---
title: "Segmented Regressions - Linear Model, Limited Datasets"
author: "Indra Boving & Joe Celebrezze"
date: "7/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(tidyverse)
library(lme4)
library(here)
library(segmented)
library(nlme)
library(lubridate)
library(MetBrewer)
library(lattice)
library(gt)
library(gtsummary)
filter = dplyr::filter 
rename = dplyr::rename
here = here::here
```

# Reading in Dataframes
Using all dates instead of just Sept. 2020 data
```{r}
seg.data.subset <- read.csv(here('processed-data', 'seg.reg.data.local.csv'))

seg.data.subset.alldates <- read.csv(here('processed-data', 'mem.data.subset.alldates'))

scaled.mem.data.alldates <- read.csv(here('processed-data', 'mem.data.local.epi.alldates.csv'))
```

# Data Wrangling
For the segmented regressions, we debated using seasonal LFM minimums and maximums to limit the dataset, but instead -- since we wanted to keep the datasets similar for each analysis -- we used the dataset that was used in the mixed effects model analysis

## Species Split
```{r}
seg.adfa.subset <- seg.data.subset %>% 
  filter(spp == "ADFA")

seg.ceme.subset <- seg.data.subset %>% 
  filter(spp == "CEME")
```

```{r}
adfa_min <- 55
adfa_max <- 110

ceme_min <- 55
ceme_max <- 140
```

```{r}
seg.adfa.subset.limited <- seg.adfa.subset %>% 
  filter(lfm < adfa_max, lfm > adfa_min)

seg.ceme.subset.limited <- seg.ceme.subset %>% 
  filter(lfm < ceme_max, lfm > ceme_min)
```

## PV Data, TLP
Getting PV data, TLP stuff all ready for segmented regression visualizations (comparing breakpoint in segmented regression to turgor loss point derived from pressure-volume curves)
```{r}
pv_summary_df_timing <- read_csv(here("processed-data", "pv_summary_df_timing.csv"))

pv_local <- pv_summary_df_timing %>% 
  filter(spp %in% c("ADFA", "CEME"))
```

```{r}
mean_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(mean_lfm)) %>% 
  pull()

upr_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(upr_lfm)) %>% 
  pull()

lwr_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(lwr_lfm)) %>% 
  pull()

mean_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(mean_tlp)) %>% 
  pull()

upr_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(upr)) %>% 
  pull()

lwr_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(lwr)) %>% 
  pull()
```

```{r}
mean_lfm_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(mean_lfm)) %>% 
  pull()

upr_lfm_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(upr_lfm)) %>% 
  pull()

lwr_lfm_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(lwr_lfm)) %>% 
  pull()

mean_mpa_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(mean_tlp)) %>% 
  pull()

upr_mpa_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(upr)) %>% 
  pull()

lwr_mpa_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(lwr)) %>% 
  pull()
```

```{r}
scaled.mem.data.alldates.noNAs <- scaled.mem.data.alldates %>% 
  drop_na(mpa, lfm, PC1)

tmp <- scaled.mem.data.alldates.noNAs %>% 
  mutate(tlp = case_when(
    spp == "ADFA" ~ mean_mpa_adfa, 
    spp == "CEME" ~ mean_mpa_ceme
  )) %>% 
  mutate(tlp_split = case_when(
    mpa > tlp ~ "tlp_above", 
    mpa < tlp ~ "tlp_below"
  )) 
tmp
```

# Global Options: Colors, Themes
```{r}
th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank())

th.spp.wrap <- theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12) +
  scale_color_manual(values=met.brewer("Morgenstern", 7)))

Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c(7, 5, 4, 6, 3, 2, 1), colorblind=TRUE)
```


# Functions

```{r, eval=F}
seg.setup <- function(x, y, df) {
  #out.lm<-lm({{y}}~{{x}}, data = data
  x <- enquo(x)
  y <- enquo(y)
  
#out.lm<-lm(paste(y, "~", x), data = df)

out.lm<-lm(y ~ x, data = df)

segmented.mod <- segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod) #CI of breakpoints
confint

lower <- confint[2] #lower bound
lower

upper <- confint[3] #upper bound
upper

fit <- numeric(length(df$x)) * NA

fit[complete.cases(rowSums(cbind(y, x)))] <- broken.line(segmented.mod)$fit

}

#seg.setup(lfm, PC1, seg.ceme.subset)
```

```{r}
segplot <- function(data, x, y, z, tlp_value, lwr, upr, lwr_seg, upr_seg) {
  ggplot(data, aes({{x}}, {{y}})) +
  geom_point()+
  geom_line(aes({{x}}, {{z}}), #segmented line
            color = "blue2") +
  geom_vline(xintercept = tlp_value, #tlp value line
             color = "gold1") +
  geom_ribbon(aes(xmin=lwr, xmax=upr), #tlp CI ribbon
              alpha = .3,
              color = "gold1") +
  geom_vline(xintercept = lwr_seg, #segmented CI line lower
             color = "blue2")+
  geom_vline(xintercept = upr_seg, #segmented CI line upper
             color = "blue2") +
  geom_ribbon(aes(xmin=lwr_seg, xmax=upr_seg), #segmented ribbon
              alpha = .3, 
              color = "blue2") +
   th #theme!
}
```

# ----------------------------------
# Start of Segmented Regression Analysis

# PC1
## ADFA
```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant (p = 0.6597)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$PC1, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, PC1, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME 
```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
#Result: significant, p = 0.03114

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$PC1, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, PC1, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# Prop. Ignite (10%)
## ADFA
```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Highly significant (p < 0.0005)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$prop.ignite.bins5_nodate, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

segplot(seg.adfa.subset.limited, lfm, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

## CEME
```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Highly significant (p < 0.00005)

selgmented.mod <- selgmented(out.lm)
selgmented.mod
#dlookr::diagnose(seg.ceme.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$prop.ignite.bins10_nodate, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, prop.ignite.bins10_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# TTI
## ADFA
```{r}
out.lm<-lm(tti ~ mpa, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: p = 1?!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$tti, seg.adfa.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, mpa, tti, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
 
```
## CEME
```{r}
out.lm<-lm(tti ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm)
# Inisignificant (p = 0.3837)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

#segmented::slope(segmented.mod)
#pscore.test(segmented.mod)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$tti, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, tti, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# FD
## ADFA
```{r}
out.lm<-lm(fd ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.6819)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fd, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, lfm, fd, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME
```{r}
out.lm<-lm(fd ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm)
#Result: insignificant (p = 0.1716)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$fd, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, fd, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# FH
## ADFA
```{r}
out.lm<-lm(fh ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant (p = 0.2161)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fh, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, fh, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME
```{r}
out.lm<-lm(fh ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: significant (p = 0.008863)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$fh, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, fh, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# GD
## ADFA
```{r}
out.lm<-lm(gd ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: significant (p = 0.02653)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$gd, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, gd, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME
```{r}
seg.ceme.subset.limited.gd <- seg.ceme.subset.limited %>% 
  filter(gd < 360) #Removing unrealistic glow durations
```

```{r}
out.lm<-lm(gd ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant 

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$gd, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, gd, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# GTI
No significant thresholds identified

## ADFA
```{r}
out.lm<-lm(gti ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$gti, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, gti, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME
```{r}
out.lm<-lm(gti ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant 

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$gti, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, gti, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)

```

# PFG
No significant thresholds identified

## ADFA
```{r}
out.lm<-lm(pfg ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$pfg, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, pfg, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME 
```{r}
out.lm<-lm(pfg ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant 

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$pfg, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, pfg, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)

```

# Max. Temp.

## ADFA
```{r}
out.lm<-lm(temp.max ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$temp.max, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, temp.max, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME
```{r}
out.lm<-lm(temp.max ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant 

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$temp.max, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, temp.max, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

# TTFG

## ADFA
For time to first glow, there is one strange value remaining where it probably didn't glow or didn't ignite (ttfg = 490)
```{r}
seg.adfa.subset.limited <- seg.adfa.subset.limited %>% 
  filter(ttfg < 300)
```

```{r}
out.lm<-lm(ttfg ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$ttfg, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, ttfg, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

## CEME
```{r}
out.lm<-lm(ttfg ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant 

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$ttfg, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, ttfg, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
