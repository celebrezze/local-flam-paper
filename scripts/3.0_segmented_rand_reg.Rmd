---
title: "Segmented Regressions - Mixed Effects Models"
author: "Indra Boving & Joe Celebrezze"
date: "4/15/2021"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(tidyverse)
library(lme4)
library(here)
library(segmented)
library(nlme)
library(lubridate)
filter = dplyr::filter 
here = here::here

#source(here("source-code", "source-segmented.lme.R"))
```

# Reading in Dataframe
```{r}
seg.data.subset <- read.csv(here('processed-data', 'seg.reg.data.local.csv'))

seg.data.subset <- seg.data.subset %>% 
  na.omit()
```

# Splitting by Species
```{r}
seg.ceme.subset <- seg.data.subset %>% 
  filter(spp == "CEME")
```

```{r}
seg.adfa.subset <- seg.data.subset %>% 
  filter(spp == "ADFA")
```

# Maximums for LFM, MPa
```{r}
max.lfm <- max(seg.data.subset$lfm)
max.mpa <- max(seg.data.subset$mpa)

max.lfm.c <- max(seg.ceme.subset$lfm)
max.mpa.c <- max(seg.ceme.subset$mpa)

max.lfm.a <- max(seg.adfa.subset$lfm)
max.mpa.a <- max(seg.adfa.subset$mpa)
```

# PV Curve Data
```{r}
pv_summary_df_timing <- read_csv(here("processed-data", "pv_summary_df_timing.csv"))

pv_local <- pv_summary_df_timing %>% 
  filter(spp %in% c("ADFA", "CEME"))
#ADFA
##LFM
mean_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(mean_lfm)) %>% 
  pull()
upr_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(upr_lfm)) %>% 
  pull()
lwr_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(lwr_lfm)) %>% 
  pull()
##MPa
mean_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(mean_tlp)) %>% 
  pull()
upr_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(upr)) %>% 
  pull()
lwr_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(lwr)) %>% 
  pull()
# CEME
##LFM
mean_lfm_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(mean_lfm)) %>% 
  pull()
upr_lfm_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(upr_lfm)) %>% 
  pull()
lwr_lfm_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(lwr_lfm)) %>% 
  pull()
##MPa
mean_mpa_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(mean_tlp)) %>% 
  pull()
upr_mpa_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(upr)) %>% 
  pull()
lwr_mpa_ceme <- pv_local %>% 
  filter(spp == "CEME") %>% 
  summarise(mean(lwr)) %>% 
  pull()
```

# Function to plot mixed effects model segmented regressions

This took a while to get running, but I think it works well now. I had to use base plot to get it to work. Note: x.variable and y.variable must be inputted as character strings.

I split the function into two so that we could customize the plots for LFM and MPa separately and also make the lines of code shorter and neater by involving more default values for arguments in the function
```{r}
rsegplot.lfm <- function(model, dataframe, x.variable = 'lfm', y.variable, max.x = max.lfm, x.lab = 'Live Fuel Moisture (%)', y.lab = NULL, tlp = NULL, tlp.upper = NULL, tlp.lower = NULL) {
  
p <- summary.segmented(model)$psi[2]
m <- slope(model, .coef = fixef(model))[[1]][[1]]
b <- intercept(model, .coef = fixef(model))[[1]][[1]]
m2 <- slope(model, .coef = fixef(model))[[1]][[2]]
b2 <- intercept(model, .coef = fixef(model))[[1]][[2]]
yvar <- dataframe[,y.variable]
xvar <- dataframe[,x.variable]
confint <- confint.segmented(model, x.variable, .coef=fixef(model))
lower <- confint[2]
upper <- confint[3]
ymax <- max(yvar)
ymin <- min(yvar)

wacky <- plot(xvar, yvar, xlim = c(0, max.x), ylim = c(ymin-1, ymax+1), 
              xlab = x.lab, ylab = y.lab,
              pch = 16, col = "#F48C06")
polygon(x = c(lower, upper, upper, lower), y = c(ymax +1.5, ymax +1.5, ymin -1.5, ymin -1.5), col = alpha('gray', 0.3), lty = 2)
abline(v = tlp, col = alpha('#00C368', 0.8), cex = 3)
polygon(x = c(tlp.lower, tlp.upper, tlp.upper, tlp.lower), y = c(ymax +1.5, ymax +1.5, ymin -1.5, ymin -1.5), col = alpha('#00C368', 0.3), border = alpha('#00C368', 0.7))
for(z in 1:length(xvar)){
  if(z < p){
    segments(x0 = 0, x1 = p, y0 = b, y1 = m*((b2 - b)/(m - m2))+b, lwd = 3, col = "#9D0208")
  }else{
    segments(x0 = p, x1 = max.x, y0 = m2*((b - b2)/(m2 - m))+b2 , y1 = m2*max.x + b2, lwd = 3, col = "#9D0208")}}
return(wacky)
}
```

```{r}
rsegplot.mpa <- function(model, dataframe, x.variable = 'mpa', y.variable, max.x = max.mpa, x.lab = 'Water Potential (MPa)', y.lab = NULL, tlp = NULL, tlp.upper = NULL, tlp.lower = NULL) 
  {
p <- summary.segmented(model)$psi[2]
m <- slope(model, .coef = fixef(model))[[1]][[1]]
b <- intercept(model, .coef = fixef(model))[[1]][[1]]
m2 <- slope(model, .coef = fixef(model))[[1]][[2]]
b2 <- intercept(model, .coef = fixef(model))[[1]][[2]]
yvar <- dataframe[,y.variable]
xvar <- dataframe[,x.variable]
confint <- confint.segmented(model, x.variable, .coef=fixef(model))
lower <- confint[2]
upper <- confint[3]
ymax <- max(yvar)
ymin <- min(yvar)

wacky <- plot(xvar, yvar, xlim = c(-10,0), ylim = c(ymin-1, ymax+1), 
              xlab = x.lab, ylab = y.lab,
              pch = 16, col = "#F48C06")
polygon(x = c(lower, upper, upper, lower), y = c(ymax +1.5, ymax +1.5, ymin -1.5, ymin -1.5), col = alpha('gray', 0.3), lty = 2)
abline(v = tlp, col = alpha('#00C368', 0.8), cex = 3)
polygon(x = c(tlp.lower, tlp.upper, tlp.upper, tlp.lower), y = c(ymax +1.5, ymax +1.5, ymin -1.5, ymin -1.5), col = alpha('#00C368', 0.3), border = alpha('#00C368', 0.7))
abline(a = b, b = m, lwd = 3, col = "#9D0208")
for(j in 1:length(xvar)){
  if(j < p){
    segments(x0 = -10, x1 = p, y0 = (-10*m) + b , y1 = m2*((b - b2)/(m2 - m))+b2, lwd = 3, col = "#9D0208")
  }
  else{
    segments(x0 = p, x1 = max.x, y0 = m2*((b - b2)/(m2 - m))+b2, y1 = b2, lwd = 3, col = "#9D0208")
  }
    }
return(wacky)
}
```

x0 = -10, x1 = p, y0 = (-10*m) + b , y1 = m2*((b - b2)/(m2 - m))+b2

#---------------------------------
# CEME
## LFM
### PC1
```{r}
o.mod<-lme(PC1~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'PC1',y.lab = "PC1", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

### PC2
```{r}
o.mod<-lme(PC2~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'PC2',y.lab = "PC2", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```
 
Ignitability Metrics:
### Time to Ignition
```{r}
o.mod<-lme(tti~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'tti',y.lab = "Time to Ignition (s)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

### Prop. Ignite (5%)
```{r}
o.mod<-lme(prop.ignite.bins5_nodate~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'prop.ignite.bins5_nodate',y.lab = "Proportion Ignted (5% Bins of LFM)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

### Glow to Ignition
```{r}
o.mod<-lme(gti~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'gti',y.lab = "Glow to Ignition (s)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

Combustibility Metrics:
### Flame Height
```{r}
o.mod<-lme(fh~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'fh',y.lab = "Flame Height (cm)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

### Max. Temp.
```{r}
o.mod<-lme(temp.max~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'temp.max',y.lab = "Maximum Temperature (C)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

Sustainability Metrics:
### Flame Duration
```{r}
o.mod<-lme(fd~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'fd',y.lab = "Flame Duration (s)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

Consumability Metrics:
### Glow Duration
```{r}
o.mod<-lme(gd~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'gd',y.lab = "Glow Duration (s)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

### Post-Flame Glow
```{r}
o.mod<-lme(pfg~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'pfg',y.lab = "Post-Flame Glow (s)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```

### Time to First Glow
```{r}
o.mod<-lme(ttfg~lfm + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.ceme.subset, y.variable = 'ttfg',y.lab = "Time to First Glow (s)", tlp = mean_lfm_ceme, tlp.lower = lwr_lfm_ceme, tlp.upper = upr_lfm_ceme)
```
# -------
## Water Potential
### PC1
```{r}
o.mod<-lme(PC1~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'PC1',y.lab = "PC1", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

### PC2
```{r}
o.mod<-lme(PC2~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'PC2',y.lab = "PC2", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```
 
Ignitability Metrics:
### Time to Ignition
```{r}
o.mod<-lme(tti~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'tti',y.lab = "Time to Ignition (s)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

### Prop. Ignite (5%)
```{r}
o.mod<-lme(prop.ignite.bins5_nodate~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'prop.ignite.bins5_nodate',y.lab = "Proportion Ignted (5% Bins of LFM)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

### Glow to Ignition
```{r}
o.mod<-lme(gti~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'gti',y.lab = "Glow to Ignition (s)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

Combustibility Metrics:
### Flame Height
```{r}
o.mod<-lme(fh~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'fh',y.lab = "Flame Height (cm)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

### Max. Temp.
```{r}
o.mod<-lme(temp.max~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'temp.max',y.lab = "Maximum Temperature (C)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

Sustainability Metrics:
### Flame Duration
```{r}
o.mod<-lme(fd~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'fd',y.lab = "Flame Duration (s)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

Consumability Metrics:
### Glow Duration
```{r}
o.mod<-lme(gd~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'gd',y.lab = "Glow Duration (s)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

### Post-Flame Glow
```{r}
o.mod<-lme(pfg~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'pfg',y.lab = "Post-Flame Glow (s)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

### Time to First Glow
```{r}
o.mod<-lme(ttfg~mpa + year.month + site, random=~1|id, data=seg.ceme.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.ceme.subset, y.variable = 'ttfg',y.lab = "Time to First Glow (s)", tlp = mean_mpa_ceme, tlp.lower = lwr_mpa_ceme, tlp.upper = upr_mpa_ceme)
```

#---------------------------------
# ADFA
## LFM
### PC1
```{r}
o.mod<-lme(PC1~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'PC1',y.lab = "PC1", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

### PC2
```{r}
o.mod<-lme(PC2~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'PC2',y.lab = "PC2", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```
 
Ignitability Metrics:
### Time to Ignition
```{r}
o.mod<-lme(tti~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'tti',y.lab = "Time to Ignition (s)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

### Prop. Ignite (5%)
```{r}
o.mod<-lme(prop.ignite.bins5_nodate~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'prop.ignite.bins5_nodate',y.lab = "Proportion Ignted (5% Bins of LFM)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

### Glow to Ignition
```{r}
o.mod<-lme(gti~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'gti',y.lab = "Glow to Ignition (s)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

Combustibility Metrics:
### Flame Height
```{r}
o.mod<-lme(fh~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'fh',y.lab = "Flame Height (cm)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

### Max. Temp.
```{r}
o.mod<-lme(temp.max~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'temp.max',y.lab = "Maximum Temperature (C)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

Sustainability Metrics:
### Flame Duration
```{r}
o.mod<-lme(fd~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'fd',y.lab = "Flame Duration (s)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

Consumability Metrics:
### Glow Duration
```{r}
o.mod<-lme(gd~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'gd',y.lab = "Glow Duration (s)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

### Post-Flame Glow
```{r}
o.mod<-lme(pfg~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'pfg',y.lab = "Post-Flame Glow (s)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

### Time to First Glow
```{r}
o.mod<-lme(ttfg~lfm + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.lfm(os.mod, seg.adfa.subset, y.variable = 'ttfg',y.lab = "Time to First Glow (s)", tlp = mean_lfm_adfa, tlp.lower = lwr_lfm_adfa, tlp.upper = upr_lfm_adfa)
```

# ------
## Water Potential
### PC1
```{r}
o.mod<-lme(PC1~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'PC1',y.lab = "PC1", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```

### PC2
```{r}
o.mod<-lme(PC2~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'PC2',y.lab = "PC2", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```
 
Ignitability Metrics:
### Time to Ignition
```{r}
o.mod<-lme(tti~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'tti',y.lab = "Time to Ignition (s)", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```

### Prop. Ignite (5%)
```{r}
o.mod<-lme(prop.ignite.bins5_nodate~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'prop.ignite.bins5_nodate',y.lab = "Proportion Ignted (5% Bins of LFM)", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```

### Glow to Ignition
```{r}
o.mod<-lme(gti~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

plot.segmented(os.mod, "mpa", .coef=fixef(os.mod), conf.level=.95)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'gti',y.lab = "Glow to Ignition (s)", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```

Combustibility Metrics:
### Flame Height
No threshold able to be identified (segmented.default returns error)

### Max. Temp.
No threshold able to be identified (segmented.default returns error)

Sustainability Metrics:
### Flame Duration
No threshold able to be identified (segmented.default returns error)

Consumability Metrics:
### Glow Duration
```{r}
o.mod<-lme(gd~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'gd',y.lab = "Glow Duration (s)", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```

### Post-Flame Glow
```{r}
o.mod<-lme(pfg~mpa + year.month + site, random=~1|id, data=seg.adfa.subset)
os.mod<-segmented.default(o.mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '.coef' argument)
summary.segmented(os.mod)

rsegplot.mpa(os.mod, seg.adfa.subset, y.variable = 'pfg',y.lab = "Post-Flame Glow (s)", tlp = mean_mpa_adfa, tlp.lower = lwr_mpa_adfa, tlp.upper = upr_mpa_adfa)
```

### Time to First Glow
No threshold able to be identified (segmented.default returns error)

# ---------------------------------
# Both Species 
## MPa x PC1
```{r}
o.pc1.mpa<-lme(PC1~mpa, random=~1|id, data=seg.data.subset)
os.pc1.mpa<-segmented.default(o.pc1.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
rsegplot.mpa(os.pc1.mpa, seg.data.subset, y = 'PC1', y.lab = "PC1")
```

## LFM x PC1
```{r}
o.pc1.lfm<-lme(PC1~lfm + site + spp + year.month, random=~1|id, data=seg.data.subset)
os.pc1.lfm<-segmented.default(o.pc1.lfm, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
rsegplot.lfm(os.pc1.lfm, seg.data.subset, y = 'PC1', y.lab = "PC1")
```

## MPa x TTI
```{r}
o.tti.mpa<-lme(tti~mpa, random=~1|id, data=seg.data.subset)
os.tti.mpa<-segmented.default(o.tti.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
rsegplot.mpa(os.tti.mpa, seg.data.subset, y = 'tti', y.lab = "Time to Ignition (s)")
```

## LFM x TTI
```{r}
o.tti.lfm<-lme(tti~lfm, random=~1|id, data=seg.data.subset)
os.tti.lfm<-segmented.default(o.tti.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
rsegplot.lfm(os.tti.lfm, seg.data.subset, y = 'tti', y.lab = "Time to Ignition (s)")
```

## MPa x FH
```{r}
o.fh.mpa<-lme(fh~mpa, random=~1|id, data=seg.data.subset)
os.fh.mpa<-segmented.default(o.fh.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.mpa, .coef=fixef(os.fh.mpa))
plot.segmented(os.fh.mpa, "mpa", .coef=fixef(os.fh.mpa), conf.level=.95)
confint.segmented(os.fh.mpa, "mpa", .coef=fixef(os.fh.mpa))
```

## LFM x FH
```{r}
o.fh.lfm<-lme(fh~lfm, random=~1|id, data=seg.data.subset)
os.fh.lfm<-segmented.default(o.fh.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
rsegplot.lfm(os.fh.lfm, seg.data.subset, y = 'fh', y.lab = "Flame Height (cm)")
```

