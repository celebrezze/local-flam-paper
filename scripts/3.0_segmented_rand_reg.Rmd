---
title: "Segmented Regressions - Mixed Effects Models"
author: "Indra Boving & Joe Celebrezze"
date: "4/15/2021"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(tidyverse)
library(lme4)
library(here)
library(segmented)
library(nlme)
library(lubridate)
filter = dplyr::filter 

#source(here("source-code", "source-segmented.lme.R"))
```

# Reading in Dataframe
```{r}
seg.data.subset <- read.csv(here('processed-data', 'seg.reg.data.local.csv'))

seg.data.subset <- seg.data.subset %>% 
  na.omit()
```

# Function to plot mixed effects model segmented regressions
This took forever to get running, but I think it works well now. I had to use base plot to get it to work. Note: x.variable and y.variable must be inputted as character strings.

I split the function into two so that we could easily customize the plots for LFM and MPa separately and also make the lines of code super short and neat
```{r}
rsegplot.lfm <- function(model, dataframe, x.variable = 'lfm', y.variable, max.x = max.lfm, x.lab = 'Live Fuel Moisture (%)', y.lab = NULL) {
  
p <- summary.segmented(model)$psi[2]
m <- slope(model, .coef = fixef(model))[[1]][[1]]
b <- intercept(model, .coef = fixef(model))[[1]][[1]]
m2 <- slope(model, .coef = fixef(model))[[1]][[2]]
b2 <- intercept(model, .coef = fixef(model))[[1]][[2]]
yvar <- dataframe[,y.variable]
xvar <- dataframe[,x.variable]
confint <- confint.segmented(model, x.variable, .coef=fixef(model))
lower <- confint[2]
upper <- confint[3]
ymax <- max(yvar)
ymin <- min(yvar)

wacky <- plot(xvar, yvar, xlim = c(0, 300), ylim = c(ymin-1, ymax+1), 
              xlab = x.lab, ylab = y.lab,
              pch = 16, col = "#F48C06")
polygon(x = c(lower, upper, upper, lower), y = c(ymax +1.5, ymax +1.5, ymin -1.5, ymin -1.5), col = alpha('gray', 0.3), lty = 2)
for(z in 1:length(xvar)){
  if(z < p){
    segments(x0 = 0, x1 = p, y0 = b, y1 = m*((b2 - b)/(m - m2))+b, lwd = 3, col = "#9D0208")
  }else{
    segments(x0 = p, x1 = max.x, y0 = m2*((b - b2)/(m2 - m))+b2 , y1 = m2*max.x + b2, lwd = 3, col = "#9D0208")}}
return(wacky)
}
```

```{r}
rsegplot.mpa <- function(model, dataframe, x.variable = 'mpa', y.variable, max.x = max.mpa, x.lab = 'Water Potential (MPa)', y.lab = NULL) {
  
p <- summary.segmented(model)$psi[2]
m <- slope(model, .coef = fixef(model))[[1]][[1]]
b <- intercept(model, .coef = fixef(model))[[1]][[1]]
m2 <- slope(model, .coef = fixef(model))[[1]][[2]]
b2 <- intercept(model, .coef = fixef(model))[[1]][[2]]
yvar <- dataframe[,y.variable]
xvar <- dataframe[,x.variable]
confint <- confint.segmented(model, x.variable, .coef=fixef(model))
lower <- confint[2]
upper <- confint[3]
ymax <- max(yvar)
ymin <- min(yvar)

wacky <- plot(xvar, yvar, xlim = c(-10,0), ylim = c(ymin-1, ymax+1), 
              xlab = x.lab, ylab = y.lab,
              pch = 16, col = "#F48C06")
polygon(x = c(lower, upper, upper, lower), y = c(ymax +1.5, ymax +1.5, ymin -1.5, ymin -1.5), col = alpha('gray', 0.3), lty = 2)
for(z in 1:length(xvar)){
  if(z < p){
    segments(x0 = 0, x1 = p, y0 = b, y1 = m*((b2 - b)/(m - m2))+b, lwd = 3, col = "#9D0208")
  }else{
    segments(x0 = p, x1 = max.x, y0 = m2*((b - b2)/(m2 - m))+b2 , y1 = m2*max.x + b2, lwd = 3, col = "#9D0208")}}
return(wacky)
}
```

# Maximums for LFM, MPa
```{r}
max.lfm <- max(seg.data.subset$lfm)
max.mpa <- max(seg.data.subset$mpa)

max.lfm.c <- max(seg.ceme.subset$lfm)
max.mpa.c <- max(seg.ceme.subset$mpa)

max.lfm.a <- max(seg.adfa.subset$lfm)
max.mpa.a <- max(seg.adfa.subset$mpa)
```


# Both Species 
## MPa x PC1
```{r}
o.pc1.mpa<-lme(PC1~mpa, random=~1|id, data=seg.data.subset)
os.pc1.mpa<-segmented.default(o.pc1.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
rsegplot.mpa(os.pc1.mpa, seg.data.subset, y = 'PC1', y.lab = "PC1")
```

## LFM x PC1
```{r}
o.pc1.lfm<-lme(PC1~lfm, random=~1|id, data=seg.data.subset)
os.pc1.lfm<-segmented.default(o.pc1.lfm, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
rsegplot.lfm(os.pc1.lfm, seg.data.subset, y = 'PC1', y.lab = "PC1")
```

## MPa x TTI
```{r}
o.tti.mpa<-lme(tti~mpa, random=~1|id, data=seg.data.subset)
os.tti.mpa<-segmented.default(o.tti.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
rsegplot.mpa(os.tti.mpa, seg.data.subset, y = 'tti', y.lab = "Time to Ignition (s)")
```

## LFM x TTI
```{r}
o.tti.lfm<-lme(tti~lfm, random=~1|id, data=seg.data.subset)
os.tti.lfm<-segmented.default(o.tti.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
rsegplot.lfm(os.tti.lfm, seg.data.subset, y = 'tti', y.lab = "Time to Ignition (s)")
```

## MPa x FH
```{r}
o.fh.mpa<-lme(fh~mpa, random=~1|id, data=seg.data.subset)
os.fh.mpa<-segmented.default(o.fh.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.mpa, .coef=fixef(os.fh.mpa))
plot.segmented(os.fh.mpa, "mpa", .coef=fixef(os.fh.mpa), conf.level=.95)
confint.segmented(os.fh.mpa, "mpa", .coef=fixef(os.fh.mpa))
```

## LFM x FH
```{r}
o.fh.lfm<-lme(fh~lfm, random=~1|id, data=seg.data.subset)
os.fh.lfm<-segmented.default(o.fh.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
rsegplot.lfm(os.fh.lfm, seg.data.subset, y = 'fh', y.lab = "Flame Height (cm)")
```


--------------------------------------------------------------------------------


# CEME Only
```{r}
seg.ceme.subset <- seg.data.subset %>% 
  filter(spp == "CEME") %>% 
  na.omit()
```


## MPa x PC1
```{r}
o.pc1.mpa.c<-lme(PC1~mpa, random=~1|id, data=seg.ceme.subset)
os.pc1.mpa.c<-segmented.default(o.pc1.mpa.c, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.mpa.c, .coef=fixef(os.pc1.mpa.c))
plot.segmented(os.pc1.mpa.c, "mpa", .coef=fixef(os.pc1.mpa.c), conf.level=.95)
confint.segmented(os.pc1.mpa.c, "mpa", .coef=fixef(os.pc1.mpa.c))
```

## LFM x PC1
```{r}
o.pc1.lfm.c<-lme(PC1~lfm, random=~1|id, data=seg.ceme.subset)
os.pc1.lfm.c<-segmented.default(o.pc1.lfm.c, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '.coef' argument)
slope(os.pc1.lfm.c, .coef=fixef(os.pc1.lfm.c))
plot.segmented(os.pc1.lfm.c, "lfm", .coef=fixef(os.pc1.lfm.c), res = T, conf.level=.95)

#####
summary.segmented(os.pc1.lfm.c)
#####
?summary.segmented()
confint.segmented(os.pc1.lfm.c, "lfm", .coef=fixef(os.pc1.lfm.c))
```

## MPa x TTI
```{r}
o.tti.mpa.c<-lme(tti~mpa, random=~1|id, data=seg.ceme.subset)
os.tti.mpa.c<-segmented.default(o.tti.mpa.c, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.mpa.c, .coef=fixef(os.tti.mpa.c))
plot.segmented(os.tti.mpa.c, "mpa", .coef=fixef(os.tti.mpa.c), conf.level=.95)
confint.segmented(os.tti.mpa.c, "mpa", .coef=fixef(os.tti.mpa.c))
```

## LFM x TTI
```{r}
o.tti.lfm.c<-lme(tti~lfm, random=~1|id, data=seg.ceme.subset)
os.tti.lfm.c<-segmented.default(o.tti.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.lfm.c, .coef=fixef(os.tti.lfm.c))
plot.segmented(os.tti.lfm.c, "lfm", .coef=fixef(os.tti.lfm.c), conf.level=.95)
confint.segmented(os.tti.lfm.c, "lfm", .coef=fixef(os.tti.lfm.c))
```

## MPa x FH
```{r}
o.fh.mpa.c<-lme(fh~mpa, random=~1|id, data=seg.ceme.subset)
os.fh.mpa.c<-segmented.default(o.fh.mpa.c, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
rsegplot.mpa(os.fh.mpa.c, seg.ceme.subset, y = 'fh', y.lab = "Flame Height (cm)", max.x = max.mpa.c) 
```

## LFM x FH
```{r}
o.fh.lfm.c<-lme(fh~lfm, random=~1|id, data=seg.ceme.subset)
os.fh.lfm.c<-segmented.default(o.fh.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.lfm.c, .coef=fixef(os.fh.lfm.c))
plot.segmented(os.fh.lfm.c, "lfm", .coef=fixef(os.fh.lfm.c), conf.level=.95)
confint.segmented(os.fh.lfm.c, "lfm", .coef=fixef(os.fh.lfm.c))
```

## LFM x Prop Ignite (5%)
```{r}
o.pi5.lfm.c<-lme(prop.ignite.bins5_nodate~lfm, random=~1|id, data=seg.ceme.subset)
os.pi5.lfm.c<-segmented.default(o.pi5.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.pi5.lfm.c, .coef=fixef(os.pi5.lfm.c))
plot.segmented(os.pi5.lfm.c, "lfm", .coef=fixef(os.pi5.lfm.c), conf.level=.95)
confint.segmented(os.pi5.lfm.c, "lfm", .coef=fixef(os.pi5.lfm.c))
```

## LFM x GD
```{r}
o.gd.lfm.c<-lme(gd~lfm, random=~1|id, data=seg.ceme.subset)
os.gd.lfm.c<-segmented.default(o.gd.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.gd.lfm.c, .coef=fixef(os.gd.lfm.c))
plot.segmented(os.gd.lfm.c, "lfm", .coef=fixef(os.gd.lfm.c), conf.level=.95)
summary.segmented(os.gd.lfm.c)
confint.segmented(os.gd.lfm.c, "lfm", .coef=fixef(os.gd.lfm.c))
```


## LFM x Prop Ignite (10%)
Code below popped up an error :(

o.pi10.lfm.c<-lme(prop.ignite.bins10_nodate~lfm, random=~1|id, data=seg.ceme.subset)
os.pi10.lfm.c<-segmented.default(o.pi10.lfm.c, ~lfm, npsi=list(lfm=1))

slope(os.pi10.lfm.c, .coef=fixef(os.pi10.lfm.c))
plot.segmented(os.pi10.lfm.c, "lfm", .coef=fixef(os.pi10.lfm.c), conf.level=.95)
confint.segmented(os.pi10.lfm.c, "lfm", .coef=fixef(os.pi10.lfm.c))


--------------------------------------------------------------------------------

# ADFA Only
```{r}
seg.adfa.subset <- seg.data.subset %>% 
  filter(spp == "ADFA")
```


## MPa x PC1
No threshold identified

## LFM x PC1
```{r}
o.pc1.lfm.a<-lme(PC1~lfm, random=~1|id, data=seg.adfa.subset)
os.pc1.lfm.a<-segmented.default(o.pc1.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.lfm.a, .coef=fixef(os.pc1.lfm.a))
plot.segmented(os.pc1.lfm.a, "lfm", .coef=fixef(os.pc1.lfm.a), conf.level=.95)
confint.segmented(os.pc1.lfm.a, "lfm", .coef=fixef(os.pc1.lfm.a))
```

## MPa x TTI
No threshold identified

## LFM x TTI
```{r}
o.tti.lfm.a<-lme(tti~lfm, random=~1|id, data=seg.adfa.subset)
os.tti.lfm.a<-segmented.default(o.tti.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.lfm.a, .coef=fixef(os.tti.lfm.a))
plot.segmented(os.tti.lfm.a, "lfm", .coef=fixef(os.tti.lfm.a), conf.level=.95)
confint.segmented(os.tti.lfm.a, "lfm", .coef=fixef(os.tti.lfm.a))
```

## MPa x FH
```{r}
o.fh.mpa.a<-lme(fh~mpa, random=~1|id, data=seg.adfa.subset)
os.fh.mpa.a<-segmented.default(o.fh.mpa.a, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.mpa.a, .coef=fixef(os.fh.mpa.a))
plot.segmented(os.fh.mpa.a, "mpa", .coef=fixef(os.fh.mpa.a), conf.level=.95)
confint.segmented(os.fh.mpa.a, "mpa", .coef=fixef(os.fh.mpa.a))
```

## LFM x FH
```{r}
o.fh.lfm.a<-lme(fh~lfm, random=~1|id, data=seg.adfa.subset)
os.fh.lfm.a<-segmented.default(o.fh.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.lfm.a, .coef=fixef(os.fh.lfm.a))
plot.segmented(os.fh.lfm.a, "lfm", .coef=fixef(os.fh.lfm.a), conf.level=.95)
confint.segmented(os.fh.lfm.a, "lfm", .coef=fixef(os.fh.lfm.a))
```

## LFM x Prop Ignite (5%)
```{r}
o.pi5.lfm.a<-lme(prop.ignite.bins5_nodate~lfm, random=~1|id, data=seg.adfa.subset)
os.pi5.lfm.a<-segmented.default(o.pi5.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.pi5.lfm.a, .coef=fixef(os.pi5.lfm.a))
plot.segmented(os.pi5.lfm.a, "lfm", .coef=fixef(os.pi5.lfm.a), conf.level=.95)
confint.segmented(os.pi5.lfm.a, "lfm", .coef=fixef(os.pi5.lfm.a))
```

## LFM x Prop Ignite (10%)
Did not work for some reason...