---
title: "Mixed Effects Model - Segmented Regression"
author: "Indra Boving & Joe Celebrezze"
date: "4/15/2021"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(tidyverse)
library(lme4)
library(here)
library(segmented)
library(nlme)
library(lubridate)
filter = dplyr::filter 

#source(here("source-code", "source-segmented.lme.R"))
```

# Data Wrangling

```{r, message=FALSE, warning=FALSE, include=FALSE}
mem.data <- read_csv(here("processed-data", "mem.data.local.epi.csv"), show_col_types = FALSE)

mem.data.raw <- mem.data %>%
  mutate(mpa = (-1*mpa)) %>% 
  mutate(year = as.factor(year)) %>%
  mutate(month = as.factor(month)) %>% 
  mutate(mpa.unscaled = mpa)

clean.mem.data.all <- mem.data.raw[,c('PC1', 'PC2', 'PC3', 'PC4', 'spp', 'lfm.NAs.imputed', 'lfm.outliers.out', 'mpa', 'dw.flam.sample', 'year.month', 'individual', 'site','sample.wt', 'ww.flam.sample', 'gww.gdw.saturated', 'gdw.gww.saturated', 'start.temp',  'year', 'month', 'tti', 'fh', 'gd', 'temp.max','flam.index', 'precip.2mo')] 

clean.mem.data <- mem.data.raw[,c('PC1', 'PC2', 'PC3', 'PC4', 'spp', 'lfm.NAs.imputed', 'lfm.outliers.out', 'mpa', 'dw.flam.sample', 'year.month', 'individual', 'site','sample.wt', 'ww.flam.sample', 'gww.gdw.saturated', 'gdw.gww.saturated', 'start.temp',  'year', 'month', 'tti', 'fh', 'gd', 'temp.max','flam.index', 'precip.2mo', 'mpa.unscaled')] %>%
  #na.omit() %>%
  filter(year.month == "2020_September")
#Parsing out the variables of interest for the mixed effects modelling

clean.mem.data.dependant <- clean.mem.data[,c('PC1', 'PC2', 'PC3', 'PC4', 'tti', 'fh', 'gd', 'temp.max', 'flam.index', 'year', 'month', 'mpa.unscaled')] 
  
scaled.mem.data.predictors <- clean.mem.data %>%
    dplyr::select('spp', 'lfm.NAs.imputed', 'lfm.outliers.out', 'mpa', 'dw.flam.sample', 'year.month', 'individual', 'site','sample.wt', 'ww.flam.sample', 'gww.gdw.saturated', 'gdw.gww.saturated', 'start.temp', 'precip.2mo') %>%
    mutate_if(is.numeric, scale)

scaled.mem.data <- cbind(scaled.mem.data.predictors, clean.mem.data.dependant) 
  
#For sept. 2020 only: 
scaled.mem.data.2020 <- scaled.mem.data %>%
  #na.omit() %>%
  filter(year.month == "2020_September")
```


```{r}
seg.data.subset <- clean.mem.data %>% 
  mutate(lfm = lfm.NAs.imputed, 
         id = individual) %>% 
 dplyr::select(id, PC1, PC2, mpa, lfm, ww.flam.sample, dw.flam.sample, spp, tti, fh) 

seg.data.subset<-seg.data.subset[order(seg.data.subset$id),]
```

# Both Species 

## MPa x PC1
```{r}
o.pc1.mpa<-lme(PC1~mpa, random=~1|id, data=seg.data.subset)
os.pc1.mpa<-segmented.default(o.pc1.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.mpa, .coef=fixef(os.pc1.mpa))
plot.segmented(os.pc1.mpa, "mpa", .coef=fixef(os.pc1.mpa), conf.level=.95)
confint.segmented(os.pc1.mpa, "mpa", .coef=fixef(os.pc1.mpa))
```

## LFM x PC1
```{r}
o.pc1.lfm<-lme(PC1~lfm, random=~1|id, data=seg.data.subset)
os.pc1.lfm<-segmented.default(o.pc1.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.lfm, .coef=fixef(os.pc1.lfm))
plot.segmented(os.pc1.lfm, "lfm", .coef=fixef(os.pc1.lfm), conf.level=.95)
confint.segmented(os.pc1.lfm, "lfm", .coef=fixef(os.pc1.lfm))
```

## MPa x TTI
```{r}
o.tti.mpa<-lme(tti~mpa, random=~1|id, data=seg.data.subset)
os.tti.mpa<-segmented.default(o.tti.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.mpa, .coef=fixef(os.tti.mpa))
plot.segmented(os.tti.mpa, "mpa", .coef=fixef(os.tti.mpa), conf.level=.95)
confint.segmented(os.tti.mpa, "mpa", .coef=fixef(os.tti.mpa))
```

## LFM x TTI
```{r}
o.tti.lfm<-lme(tti~lfm, random=~1|id, data=seg.data.subset)
os.tti.lfm<-segmented.default(o.tti.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.lfm, .coef=fixef(os.tti.lfm))
plot.segmented(os.tti.lfm, "lfm", .coef=fixef(os.tti.lfm), conf.level=.95)
confint.segmented(os.tti.lfm, "lfm", .coef=fixef(os.tti.lfm))
```

## MPa x FH
```{r}
o.fh.mpa<-lme(fh~mpa, random=~1|id, data=seg.data.subset)
os.fh.mpa<-segmented.default(o.fh.mpa, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.mpa, .coef=fixef(os.fh.mpa))
plot.segmented(os.fh.mpa, "mpa", .coef=fixef(os.fh.mpa), conf.level=.95)
confint.segmented(os.fh.mpa, "mpa", .coef=fixef(os.fh.mpa))
```

## LFM x FH
```{r}
o.fh.lfm<-lme(fh~lfm, random=~1|id, data=seg.data.subset)
os.fh.lfm<-segmented.default(o.fh.lfm, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.lfm, .coef=fixef(os.fh.lfm))
plot.segmented(os.fh.lfm, "lfm", .coef=fixef(os.fh.lfm), conf.level=.95)
confint.segmented(os.fh.lfm, "lfm", .coef=fixef(os.fh.lfm))
```


--------------------------------------------------------------------------------


# CEME Only
```{r}
seg.ceme.subset <- seg.data.subset %>% 
  filter(spp == "CEME")
```


## MPa x PC1
```{r}
o.pc1.mpa.c<-lme(PC1~mpa, random=~1|id, data=seg.ceme.subset)
os.pc1.mpa.c<-segmented.default(o.pc1.mpa.c, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.mpa.c, .coef=fixef(os.pc1.mpa.c))
plot.segmented(os.pc1.mpa.c, "mpa", .coef=fixef(os.pc1.mpa.c), conf.level=.95)
confint.segmented(os.pc1.mpa.c, "mpa", .coef=fixef(os.pc1.mpa.c))
```

## LFM x PC1
```{r}
o.pc1.lfm.c<-lme(PC1~lfm, random=~1|id, data=seg.ceme.subset)
os.pc1.lfm.c<-segmented.default(o.pc1.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.lfm.c, .coef=fixef(os.pc1.lfm.c))
plot.segmented(os.pc1.lfm.c, "lfm", .coef=fixef(os.pc1.lfm.c), conf.level=.95)
confint.segmented(os.pc1.lfm.c, "lfm", .coef=fixef(os.pc1.lfm.c))
```

## MPa x TTI
```{r}
o.tti.mpa.c<-lme(tti~mpa, random=~1|id, data=seg.ceme.subset)
os.tti.mpa.c<-segmented.default(o.tti.mpa.c, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.mpa.c, .coef=fixef(os.tti.mpa.c))
plot.segmented(os.tti.mpa.c, "mpa", .coef=fixef(os.tti.mpa.c), conf.level=.95)
confint.segmented(os.tti.mpa.c, "mpa", .coef=fixef(os.tti.mpa.c))
```

## LFM x TTI
```{r}
o.tti.lfm.c<-lme(tti~lfm, random=~1|id, data=seg.ceme.subset)
os.tti.lfm.c<-segmented.default(o.tti.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.lfm.c, .coef=fixef(os.tti.lfm.c))
plot.segmented(os.tti.lfm.c, "lfm", .coef=fixef(os.tti.lfm.c), conf.level=.95)
confint.segmented(os.tti.lfm.c, "lfm", .coef=fixef(os.tti.lfm.c))
```

## MPa x FH
```{r}
o.fh.mpa.c<-lme(fh~mpa, random=~1|id, data=seg.ceme.subset)
os.fh.mpa.c<-segmented.default(o.fh.mpa.c, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.mpa.c, .coef=fixef(os.fh.mpa.c))
plot.segmented(os.fh.mpa.c, "mpa", .coef=fixef(os.fh.mpa.c), conf.level=.95)
confint.segmented(os.fh.mpa.c, "mpa", .coef=fixef(os.fh.mpa.c))
```

## LFM x FH
```{r}
o.fh.lfm.c<-lme(fh~lfm, random=~1|id, data=seg.ceme.subset)
os.fh.lfm.c<-segmented.default(o.fh.lfm.c, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.lfm.c, .coef=fixef(os.fh.lfm.c))
plot.segmented(os.fh.lfm.c, "lfm", .coef=fixef(os.fh.lfm.c), conf.level=.95)
confint.segmented(os.fh.lfm.c, "lfm", .coef=fixef(os.fh.lfm.c))
```


--------------------------------------------------------------------------------

# ADFA Only
```{r}
seg.adfa.subset <- seg.data.subset %>% 
  filter(spp == "ADFA")
```


## MPa x PC1
```{r}
o.pc1.mpa.a<-lme(PC1~mpa, random=~1|id, data=seg.adfa.subset)
os.pc1.mpa.a<-segmented.default(o.pc1.mpa.a, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.mpa.a, .coef=fixef(os.pc1.mpa.a))
plot.segmented(os.pc1.mpa.a, "mpa", .coef=fixef(os.pc1.mpa.a), conf.level=.95)
confint.segmented(os.pc1.mpa.a, "mpa", .coef=fixef(os.pc1.mpa.a))
```

## LFM x PC1
```{r}
o.pc1.lfm.a<-lme(PC1~lfm, random=~1|id, data=seg.adfa.subset)
os.pc1.lfm.a<-segmented.default(o.pc1.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.pc1.lfm.a, .coef=fixef(os.pc1.lfm.a))
plot.segmented(os.pc1.lfm.a, "lfm", .coef=fixef(os.pc1.lfm.a), conf.level=.95)
confint.segmented(os.pc1.lfm.a, "lfm", .coef=fixef(os.pc1.lfm.a))
```

## MPa x TTI
```{r}
o.tti.mpa.a<-lme(tti~mpa, random=~1|id, data=seg.adfa.subset)
os.tti.mpa.a<-segmented.default(o.tti.mpa.a, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.mpa.a, .coef=fixef(os.tti.mpa.a))
plot.segmented(os.tti.mpa.a, "mpa", .coef=fixef(os.tti.mpa.a), conf.level=.95)
confint.segmented(os.tti.mpa.a, "mpa", .coef=fixef(os.tti.mpa.a))
```

## LFM x TTI
```{r}
o.tti.lfm.a<-lme(tti~lfm, random=~1|id, data=seg.adfa.subset)
os.tti.lfm.a<-segmented.default(o.tti.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.tti.lfm.a, .coef=fixef(os.tti.lfm.a))
plot.segmented(os.tti.lfm.a, "lfm", .coef=fixef(os.tti.lfm.a), conf.level=.95)
confint.segmented(os.tti.lfm.a, "lfm", .coef=fixef(os.tti.lfm.a))
```

## MPa x FH
```{r}
o.fh.mpa.a<-lme(fh~mpa, random=~1|id, data=seg.adfa.subset)
os.fh.mpa.a<-segmented.default(o.fh.mpa.a, ~mpa, npsi=list(mpa=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.mpa.a, .coef=fixef(os.fh.mpa.a))
plot.segmented(os.fh.mpa.a, "mpa", .coef=fixef(os.fh.mpa.a), conf.level=.95)
confint.segmented(os.fh.mpa.a, "mpa", .coef=fixef(os.fh.mpa.a))
```

## LFM x FH
```{r}
o.fh.lfm.a<-lme(fh~lfm, random=~1|id, data=seg.adfa.subset)
os.fh.lfm.a<-segmented.default(o.fh.lfm.a, ~lfm, npsi=list(lfm=1))

#summarizing results (note the '.coef' argument)
slope(os.fh.lfm.a, .coef=fixef(os.fh.lfm.a))
plot.segmented(os.fh.lfm.a, "lfm", .coef=fixef(os.fh.lfm.a), conf.level=.95)
confint.segmented(os.fh.lfm.a, "lfm", .coef=fixef(os.fh.lfm.a))
```