---
title: "Segmented Regressions - Linear Models"
author: "Indra Boving & Joe Celebrezze"
date: "6/7/2022"
output: html_document
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(tidyverse)
library(lme4)
library(here)
library(segmented)
library(nlme)
library(lubridate)
library(MetBrewer)
library(lattice)
filter = dplyr::filter 
here = here::here
```

# Reading in Dataframes
Using all dates instead of just Sept. 2020 data
```{r}
seg.data.subset <- read.csv(here('processed-data', 'seg.reg.data.local.csv'))

seg.data.subset.alldates <- read.csv(here('processed-data', 'mem.data.subset.alldates'))

scaled.mem.data.alldates <- read.csv(here('processed-data', 'mem.data.local.epi.alldates.csv'))
```

# Data Wrangling
## Species Split
Splitting by species and then getting seasonal maxes and minimums
```{r}
seg.adfa.subset <- seg.data.subset %>% 
  filter(spp == "ADFA")

seg.ceme.subset <- seg.data.subset %>% 
  filter(spp == "CEME")
```

```{r}
adfa_min <- 55
adfa_max <- 110

ceme_min <- 55
ceme_max <- 140
```

```{r}
seg.adfa.subset.limited <- seg.adfa.subset %>% 
  filter(lfm < adfa_max, lfm > adfa_min)

seg.ceme.subset.limited <- seg.ceme.subset %>% 
  filter(lfm < ceme_max, lfm > ceme_min)
```
## PV Data, TLP
Getting PV data, TLP stuff all ready for segmented regression visualizations (comparing breakpoint in segmented regression to turgor loss point derived from pressure-volume curves)

```{r}
pv_summary_df_timing <- read_csv(here("processed-data", "pv_summary_df_timing.csv"))

pv_local <- pv_summary_df_timing %>% 
  filter(spp %in% c("ADFA", "ceme"))
```

```{r}
mean_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(mean_lfm)) %>% 
  pull()

upr_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(upr_lfm)) %>% 
  pull()

lwr_lfm_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(lwr_lfm)) %>% 
  pull()

mean_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(mean_tlp)) %>% 
  pull()

upr_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(upr)) %>% 
  pull()

lwr_mpa_adfa <- pv_local %>% 
  filter(spp == "ADFA") %>% 
  summarise(mean(lwr)) %>% 
  pull()
```

```{r}
mean_lfm_ceme <- pv_local %>% 
  filter(spp == "ceme") %>% 
  summarise(mean(mean_lfm)) %>% 
  pull()

upr_lfm_ceme <- pv_local %>% 
  filter(spp == "ceme") %>% 
  summarise(mean(upr_lfm)) %>% 
  pull()

lwr_lfm_ceme <- pv_local %>% 
  filter(spp == "ceme") %>% 
  summarise(mean(lwr_lfm)) %>% 
  pull()

mean_mpa_ceme <- pv_local %>% 
  filter(spp == "ceme") %>% 
  summarise(mean(mean_tlp)) %>% 
  pull()

upr_mpa_ceme <- pv_local %>% 
  filter(spp == "ceme") %>% 
  summarise(mean(upr)) %>% 
  pull()

lwr_mpa_ceme <- pv_local %>% 
  filter(spp == "ceme") %>% 
  summarise(mean(lwr)) %>% 
  pull()
```

```{r}
scaled.mem.data.alldates.noNAs <- scaled.mem.data.alldates %>% 
  drop_na(mpa, lfm, PC1)

tmp <- scaled.mem.data.alldates.noNAs %>% 
  mutate(tlp = case_when(
    spp == "ADFA" ~ mean_mpa_adfa, 
    spp == "ceme" ~ mean_mpa_ceme
  )) %>% 
  mutate(tlp_split = case_when(
    mpa > tlp ~ "tlp_above", 
    mpa < tlp ~ "tlp_below"
  )) 
tmp
```

# Global Options: Colors, Themes
```{r}
th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank())

th.spp.wrap <- theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12) +
  scale_color_manual(values=met.brewer("Morgenstern", 7)))

Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c(7, 5, 4, 6, 3, 2, 1), colorblind=TRUE)
```


# Functions

```{r, eval=F}
seg.setup <- function(x, y, df) {
  #out.lm<-lm({{y}}~{{x}}, data = data
  x <- enquo(x)
  y <- enquo(y)
  
#out.lm<-lm(paste(y, "~", x), data = df)

out.lm<-lm(y ~ x, data = df)

segmented.mod <- segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod) #CI of breakpoints
confint

lower <- confint[2] #lower bound
lower

upper <- confint[3] #upper bound
upper

fit <- numeric(length(df$x)) * NA

fit[complete.cases(rowSums(cbind(y, x)))] <- broken.line(segmented.mod)$fit

}

#seg.setup(lfm, PC1, seg.ceme.subset)
```

```{r}
segplot <- function(data, x, y, z, tlp_value, lwr, upr, lwr_seg, upr_seg) {
  ggplot(data, aes({{x}}, {{y}})) +
  geom_point()+
  geom_line(aes({{x}}, {{z}}), #segmented line
            color = "blue2") +
  geom_vline(xintercept = tlp_value, #tlp value line
             color = "gold1") +
  geom_ribbon(aes(xmin=lwr, xmax=upr), #tlp CI ribbon
              alpha = .3,
              color = "gold1") +
  geom_vline(xintercept = lwr_seg, #segmented CI line lower
             color = "blue2")+
  geom_vline(xintercept = upr_seg, #segmented CI line upper
             color = "blue2") +
  geom_ribbon(aes(xmin=lwr_seg, xmax=upr_seg), #segmented ribbon
              alpha = .3, 
              color = "blue2") +
   th #theme!

}
```

# PC1

#### ADFA


```{r}
seg.adfa.subset <- seg.adfa.subset %>% 
  filter(lfm < 150)

out.lm<-lm(PC1 ~ lfm, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
# Result: significant (p = 0.02517)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$PC1, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm, PC1, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.adfa.subset.limited)

davies.test(out.lm, k = 50)
# Result: insignificant (p = 0.6597)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$PC1, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, PC1, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)

```

#### CEME

```{r}
seg.ceme.subset <- seg.ceme.subset %>% 
  filter(lfm < 300)

out.lm<-lm(PC1 ~ lfm, data = seg.ceme.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)
davies.test(out.lm, k = 50)
# Result: marginally significant (p = 0.04844)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$PC1, seg.ceme.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm, PC1, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
 
```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.ceme.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)
#Result: significant, p = 0.03114

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$PC1, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, PC1, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

####ADFA --MPa
no breakpoint
```{r}
out.lm<-lm(PC1 ~ mpa, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
#Result: insignifcant (p = 0.6182)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa)) * NA

#fit[complete.cases(rowSums(cbind(seg.adfa.subset$PC1, seg.adfa.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa, PC1, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

```{r}
out.lm<-lm(PC1 ~ mpa, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.5455)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$PC1, seg.adfa.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, mpa, PC1, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)

```

#### CEME--MPa

```{r}
out.lm<-lm(PC1 ~ mpa, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.6775)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
#segmented.mod
#summary(segmented.mod)


confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$PC1, seg.ceme.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, mpa, PC1, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```
 
```{r}
out.lm<-lm(PC1 ~ mpa, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
#Result: P = 1?!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$PC1, seg.ceme.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, mpa, PC1, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

# Proportion Ignited

```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: marginally significant (p = 0.04587)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$prop.ignite.bins10_nodate, seg.ceme.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm, prop.ignite.bins10_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Highly significant (p < 0.00005)

selgmented.mod <- selgmented(out.lm)
selgmented.mod
#dlookr::diagnose(seg.ceme.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$prop.ignite.bins10_nodate, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, prop.ignite.bins10_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
## Zoomed in: 5%

Bins of 5 LFM used to make prop. ignite column

### ADFA

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.adfa.subset) 
davies.test(out.lm, k = 50)
# Highly significant (p < 0.00005)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins5_nodate, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

segplot(seg.adfa.subset, lfm, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```


```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Highly significant (p < 0.0005)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$prop.ignite.bins5_nodate, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

segplot(seg.adfa.subset.limited, lfm, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
### CEME

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.1897)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.ceme.subset$lfm)) * NA

confint <- confint(segmented.mod)
confint

lower.seg <- confint[2]
lower.seg

upper.seg <- confint[3]
upper.seg

fit[complete.cases(rowSums(cbind(seg.ceme.subset$prop.ignite.bins5_nodate, seg.ceme.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
#Result: highly significant (p < 0.00005)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper


fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$prop.ignite.bins5_nodate, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

### ADFA --MPa

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ mpa, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
# Result: insignificant (p = 0.5482)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

summary(segmented.mod)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins5_nodate, seg.adfa.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa, prop.ignite.bins5_nodate, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

### CEME--MPa

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ mpa, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: highly significant, p = 0.000134

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

summary(segmented.mod)

fit <- numeric(length(seg.ceme.subset$mpa)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit[complete.cases(rowSums(cbind(seg.ceme.subset$prop.ignite.bins5_nodate, seg.ceme.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, mpa, prop.ignite.bins5_nodate, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

## TTI

### ADFA
```{r}
out.lm<-lm(tti ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
#Result: p = 1?!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$tti, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, lfm, tti, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
 
```
### CEME

```{r}
out.lm<-lm(tti ~ lfm, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
# Result: highly significant (p = 0.0009369)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$tti, seg.ceme.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm, tti, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

Remove non-realistic LFMS
```{r}
out.lm<-lm(tti ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm)
# Inisignificant (p = 0.3837)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

#segmented::slope(segmented.mod)
#pscore.test(segmented.mod)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$tti, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, tti, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```


### ADFA --MPa

```{r}
out.lm<-lm(tti ~ mpa, data = seg.adfa.subset)
davies.test(out.lm, k=50)
# Result: insignificant (p = 0.6741)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$tti, seg.adfa.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa, tti, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

####With random bps

# NOTE: ERROR
```{r}
#Basis functions
bp = 1
b1 <- function(x, bp) ifelse(x < bp, bp - x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x - bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  # mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)
  
  mod <- lmer(PC1 ~ b1(mpa, bp) + b2(mpa, bp) +  spp + year.month + ((b1(mpa, bp) + b2(mpa, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)
  deviance(mod)
}

search.range <- c(min(scaled.mem.data.alldates.noNAs$mpa) + 0.5, max(scaled.mem.data.alldates.noNAs$mpa)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        tti ~ mpa | individual, scaled.mem.data.alldates.noNAs, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "tti",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(PC1 ~ b1(mpa, bp) + b2(mpa, bp) +  spp + year.month + ((b1(mpa, bp) + b2(mpa, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)

# ERRORS popping up below. What is this?
#lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
#ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
#lb95$root

#ub95$root

```

```{r}
out.lm<-lm(tti ~ mpa, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: p = 1?!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$tti, seg.adfa.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, mpa, tti, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
 
```
### CEME --MPa

```{r}
out.lm<-lm(tti ~ mpa, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: significant (p = 0.01178)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$tti, seg.ceme.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, mpa, tti, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

####With random bps
```{r}
#Basis functions
bp = 4
b1 <- function(x, bp) ifelse(x < bp, bp - x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x - bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
mod <- lmer(PC1 ~ b1(mpa, bp) + b2(mpa, bp) + year.month + ((b1(mpa, bp) + b2(mpa, bp))| id), data = seg.ceme.subset, REML=FALSE)

  deviance(mod)
}

search.range <- c(min(seg.ceme.subset$mpa) + 0.5, max(seg.ceme.subset$mpa)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        tti ~ mpa | id, seg.ceme.subset, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "tti",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(PC1 ~ b1(mpa, bp) + b2(mpa, bp) + year.month + ((b1(mpa, bp) + b2(mpa, bp))| id), data = seg.ceme.subset, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)

#lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
#ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
#lb95$root

#ub95$root

```


Remove non-realistic LFMS
```{r}
out.lm<-lm(tti ~ mpa, data = seg.ceme.subset.limited)
davies.test(out.lm)
# Result: significant (p = 0.02031)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$tti, seg.ceme.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, mpa, tti, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

----
## FD

### ADFA

```{r}
#https://stats.stackexchange.com/questions/19772/estimating-the-break-point-in-a-broken-stick-piecewise-linear-model-with-rando/19777#19777

out.lm<-lm(fd ~ lfm, data = seg.adfa.subset)
davies.test(out.lm, k=50)
#Result: insignificant (p = 0.6856)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm, seg.Z = ~lfm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fd, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm, fd, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

```{r}
out.lm<-lm(fd ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.6819)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fd, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, lfm, fd, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
 
```
### CEME

```{r}
out.lm<-lm(fd ~ lfm, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.4814)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$fd, seg.ceme.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm, fd, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

Remove non-realistic LFMS
```{r}
out.lm<-lm(fd ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm)
#Result: insignificant (p = 0.1716)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$fd, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, fd, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```


### ADFA --MPa

```{r}
out.lm<-lm(fd ~ mpa, data = seg.adfa.subset)
davies.test(out.lm, k=50)
# Result: insignificant (p = 0.7258)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fd, seg.adfa.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa, fd, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

####With random bps
```{r}
#Basis functions
bp = -3
b1 <- function(x, bp) ifelse(x < bp, bp + x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x + bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  # mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)
  
  mod <- lmer(fd ~ b1(mpa, bp) + b2(mpa, bp) +  spp + year.month + ((b1(mpa, bp) + b2(mpa, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)
  deviance(mod)
}

search.range <- c(min(scaled.mem.data.alldates.noNAs$mpa) + 0.5, max(scaled.mem.data.alldates.noNAs$mpa)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        fd ~ mpa | individual, scaled.mem.data.alldates.noNAs, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "fd",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(fd ~ b1(mpa, bp) + b2(mpa, bp) +  spp + year.month + ((b1(mpa, bp) + b2(mpa, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)
#lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
#ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
#lb95$root

#ub95$root

```

```{r}
out.lm<-lm(fd ~ mpa, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
#Result: p = 1?!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fd, seg.adfa.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, mpa, fd, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
 
```
### CEME --MPa

```{r}
out.lm<-lm(fd ~ mpa, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: insignificant (p = 0.7735)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$fd, seg.ceme.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, mpa, fd, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

####With random bps
# ERROR
```{r}
#Basis functions
bp = 4
b1 <- function(x, bp) ifelse(x < bp, bp - x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x - bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
mod <- lmer(PC1 ~ b1(mpa, bp) + b2(mpa, bp) +  spp + year.month + ((b1(mpa, bp) + b2(mpa, bp))| id), data = seg.ceme.subset, REML=FALSE)

  deviance(mod)
}

search.range <- c(min(seg.ceme.subset$mpa) + 0.5, max(seg.ceme.subset$mpa)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        fd ~ mpa | id, seg.ceme.subset, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "fd",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(PC1 ~ b1(mpa, bp) + b2(mpa, bp) +  spp + year.month + ((b1(mpa, bp) + b2(mpa, bp))| id), data = seg.ceme.subset, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)
#lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
#ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
#lb95$root

#ub95$root

```


Remove non-realistic LFMS
```{r}
out.lm<-lm(fd ~ mpa, data = seg.ceme.subset.limited)
davies.test(out.lm)
#Result; insig. (p = 0.6627)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$fd, seg.ceme.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, mpa, fd, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

---
## FH

### ADFA

```{r}
out.lm<-lm(fh ~ lfm, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
# result: significant (p = 0.001313)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fh, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm, fh, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)

```

```{r}
out.lm<-lm(fh ~ lfm, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# Result: insignificant (p = 0.2161)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fh, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm, fh, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

### CEME

```{r}
out.lm<-lm(fh ~ lfm, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
#Result: significant (p = 0.3032)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$fh, seg.ceme.subset$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm, fh, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
out.lm<-lm(fh ~ lfm, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: significant (p = 0.008863)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$fh, seg.ceme.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, lfm, fh, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)

```

### ADFA -- MPa

```{r}
out.lm<-lm(fh ~ mpa, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
# Result: p = 1?!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fh, seg.adfa.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa, fh, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)

```

```{r}
out.lm<-lm(fh ~ mpa, data = seg.adfa.subset.limited)
davies.test(out.lm, k = 50)
# p = 1!

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fh, seg.adfa.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, mpa, fh, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

### CEME -- MPa

```{r}
out.lm<-lm(fh ~ mpa, data = seg.ceme.subset)
davies.test(out.lm, k = 50)
# result: significant (p = 0.001903)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset$fh, seg.ceme.subset$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, mpa, fh, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

```{r}
out.lm<-lm(fh ~ mpa, data = seg.ceme.subset.limited)
davies.test(out.lm, k = 50)
# Result: marginally insignificant (p = 0.05442)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.ceme.subset.limited$mpa)) * NA

fit[complete.cases(rowSums(cbind(seg.ceme.subset.limited$fh, seg.ceme.subset.limited$mpa)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset.limited, mpa, fh, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```