---
title: 'PCA on Local Flammability Trials'
author: "Indra Boving"
date: "Updated last 11/22/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar)
library(dplyr)
library(tidyverse)
library(devtools)
library(ggbiplot)
library(ggfortify)
library(ggpubr)
library(here)
library(psych)
here = here::here #Gets confused with dplyr::here
```

# Organize Data (in Data_Wrangling.Rmd)
1. Missing values --> NA, then imputed (see DataWrangling.Rmd)
2. Outliers removed from LFM column using oulierKD (outside 1.5 IQR --> NA)
3. Median inserted (grouped by spp) for flam metrics; ungrouped median for chamber NAs (temps, weights). 
4. Normalized flam metrics using the burned sample dry weight (.norm added to names)

### Note: This dataset inludes only Epiradiator and Ignited samples

```{r echo=FALSE, warning=FALSE}
epi.flamdata <- read.csv(here("processed-data", "epi.ignite.only.LOCAL.csv")) %>%
  mutate(LFM = lfm.NAs.imputed)
#colSums(is.na(epi.flamdata))
#Note: This dataset inludes only epiradiator and ignited samples, and Mpa is NOT negative, so imagine those axes to be reversed.
```


```{r, warning = FALSE}
distributions <- epi.flamdata %>%
  select(spp, mpa, lfm.outliers.out, lfm.NAs.imputed, sample.wt, dw.flam.sample, ttfg, gd, gti, tti, fh, pfg, fd, temp.max, prop.ignite, dry.norm.fh, dry.norm.gd, dry.norm.fd, dry.norm.pfg, dry.norm.gti, dry.norm.ttfg, dry.norm.tti, temp.change) %>%
  gather(-spp, key = "var", value = "value") %>%
  ggplot() +
  geom_density(aes(x = value, color = spp)) +
  facet_wrap(~ var, scales = "free")
distributions +
  ggtitle("Epiradiator")
```

Taking the log of the flam metrics, to see if that looks better: 

#### Untransformed values: 

```{r, include=TRUE}
#not transformed:
epi.flamdata.nolog <- (epi.flamdata[c("fh", "ttfg", "tti", "fd", "gd", "gti", "sample.wt", "pfg", "temp.max", "prop.ignite", "flam.index" )])
multi.hist(epi.flamdata.nolog[,sapply(epi.flamdata.nolog, is.numeric)])
```

#### Log-transformed values: 

```{r, include=TRUE}
## log transform normalized flam metrics:
log.epi.flamdata <- log(epi.flamdata[c("fh", "ttfg", "tti", "fd", "gd", "gti", "sample.wt", "pfg", "temp.max", "prop.ignite","mpa", "lfm.NAs.imputed", "flam.index")]) #flam metrics, lfm, and sample weight
multi.hist(log.epi.flamdata[,sapply(log.epi.flamdata, is.numeric)])
```


```{r}
#Label and subset categorical variables:
cat.epi.flamdata <- (epi.flamdata[c("hydration", "spp", "year.month", "sample")])
```

```{r, include = FALSE}
# #Not transformed: 
# nolog.epi.flamdata.norm <- (epi.flamdata[c("dry.norm.fh", "dry.norm.gd", "dry.norm.fd", "dry.norm.pfg", "dry.norm.gti", "dry.norm.ttfg", "dry.norm.tti")]) #flam metrics, lfm, and sample weight
# multi.hist(nolog.epi.flamdata.norm[,sapply(nolog.epi.flamdata.norm, is.numeric)])
# 
# ## log transform normalized flam metrics:
# log.epi.flamdata.norm <- log(epi.flamdata[c("dry.norm.fh", "dry.norm.gd", "dry.norm.fd", "dry.norm.pfg", "dry.norm.gti", "dry.norm.ttfg", "dry.norm.tti", "mpa", "lfm.NAs.imputed")]) #flam metrics, lfm, and sample weight
# multi.hist(log.epi.flamdata.norm[,sapply(log.epi.flamdata.norm, is.numeric)])
```

# 1. PCA including predictor variables 

```{r warning=FALSE}
#colSums(is.na(epi.flamdata))
epi.flamdata.all <- (epi.flamdata[, c("lfm.NAs.imputed", "mpa",
         "fh", "ttfg", "tti", "fd", "gd", "gti", "sample.wt", "pfg",
         "temp.max", "prop.ignite", "dw.flam.sample")])


epi.flamdata.all.pca <- prcomp(na.omit(epi.flamdata.all), center = TRUE, scale = TRUE)

#print(epi.flamdata.all.pca)
plot(epi.flamdata.all.pca)
#plot(epi.flamdata.all.pca, type = "l")
summary(epi.flamdata.all.pca)
#biplot(epi.flamdata.all.pca)
```


```{r warning=FALSE}
f <- ggbiplot::ggbiplot(epi.flamdata.all.pca, groups = cat.epi.flamdata[,2], 
                        circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp
ggtitle("All Values")
print(f)
```


```{r warning=FALSE}
f <- ggbiplot::ggbiplot(epi.flamdata.all.pca, groups = cat.epi.flamdata[,1], 
                        circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  #
ggtitle("All Values")  # by Hydration
print(f)

#f <- ggbiplot::ggbiplot(epi.flamdata.all.pca, groups = cat.epi.flamdata[,5], ellipse = TRUE, circle = TRUE, 
                       # varname.size = 4, alpha = .4)   # by trial (month and year)
#print(f)
```

# 2. PCA on flam. characteristics: 

```{r warning=FALSE}
epi.flamdata.flam <- (epi.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max")])

epi.flamdata.pca <- prcomp(na.omit(epi.flamdata.flam), center = TRUE, scale = TRUE)

#print(epi.flamdata.pca)
plot(epi.flamdata.pca)
#plot(epi.flamdata.pca, type = "l")
summary(epi.flamdata.pca)
#biplot(epi.flamdata.pca)

f <- ggbiplot::ggbiplot(epi.flamdata.pca, groups = cat.epi.flamdata[,2], 
                        circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp +  # by spp
ggtitle("Flammability metrics only")
print(f)

f <- ggbiplot::ggbiplot(epi.flamdata.pca, groups = cat.epi.flamdata[,1],
                         circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp
ggtitle("Flammability metrics only")  # by Hydration
print(f)

f <- ggbiplot::ggbiplot(epi.flamdata.pca,  
                        circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp
ggtitle("Flammability metrics only")  # by Hydration
print(f)

#f <- ggbiplot::ggbiplot(epi.flamdata.pca, groups = cat.epi.flamdata[,5], ellipse = TRUE, circle = TRUE, 
                       # varname.size = 4, alpha = .4)   # by trial (month and year)
#print(f)
```

# Interpretation: 

```{r}
table_pca <- tab_pca(epi.flamdata.pca)
table_pca
```

PC1 loads positively on flame height & flame duration (**sustainability and combustibility**), and loads negatively on time to ignition and glow to ignition (**ignitability**). 

PC2 is heavily negatively loaded on post-flame glow and glow duration (**consumability**). 

PC1 is the better at explaining flammability overall, especially as far as actual flames are concerned. 


# 3. PCA on flam. characteristics (log-transformed)

```{r warning=FALSE}
epi.flamdata.flam.log <- (log.epi.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max")])

epi.flamdata.pca.log <- prcomp(na.omit(epi.flamdata.flam.log), center = TRUE, scale = TRUE)

#print(epi.flamdata.pca)
plot(epi.flamdata.pca.log)
#plot(epi.flamdata.pca, type = "l")
summary(epi.flamdata.pca.log)
#biplot(epi.flamdata.pca)

f <- ggbiplot::ggbiplot(epi.flamdata.pca.log, groups = cat.epi.flamdata[,2], 
                        circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp +  # by spp
ggtitle("Flammability metrics only - log-transformed")
print(f)

f <- ggbiplot::ggbiplot(epi.flamdata.pca.log, groups = cat.epi.flamdata[,1],
                         circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp
ggtitle("Flammability metrics only - log-transformed")  # by Hydration
print(f)

f <- ggbiplot::ggbiplot(epi.flamdata.pca.log,  
                        circle = TRUE, 
                        varname.size = 3, 
                        alpha = .2, 
                        labels.size = 3,
                        varname.adjust = 2.5) +  # by spp
ggtitle("Flammability metrics only - log-transformed")  # by Hydration
print(f)
```
# Interpretation: 

PC1 


# 4. Create new dataset for MEMs: 

Here: `mem.data.local.epi.csv"`

- PCA includes only the flammability metrics

```{r warning=FALSE}
### Plot PCA scores yourself (and thus access for plotting against LFM)
#head(epi.flamdata)

x.flam <-predict(epi.flamdata.pca)  ### generate scores for each row in epi.flamdata2
pca.flam.data <- as.data.frame(x.flam) 

#x6 <-predict(epi.flamdata6.pca)  ### generate scores for each row in epi.flamdata2
#pca.flam.data6 <- as.data.frame(x6) 
#pca.flam.data6[which.min(pca.flam.data6$PC1),]

#all.data <- cbind.data.frame(ignite.only.epi, pca.flam.data6) %>%  #ignite.only.all.epi from Data_Wrangling_DATE.Rmd (so run that one first)
 # mutate(PC1.norm = PC1, PC2.norm = PC2, PC3.norm = PC3, PC4.norm = PC4, PC5.norm = PC5, PC6.norm = PC6, PC7.norm = PC7, PC1 = NULL, PC2 = NULL, PC3 = NULL, PC4 = NULL, PC5 = NULL, PC6 = NULL, PC7 = NULL )

all.data.epi <- cbind(epi.flamdata, pca.flam.data)
#colSums(is.na(all.data))
#str(all.data.epi)

#dataset with the above columns, PCA using imputed NAs (medians), and flam metrics with NAs still in there:
mem.data.PCAtests <- all.data.epi %>% select(individual, site, year, month, year.month, lfm.outliers.out, lfm.NAs.imputed, mpa, dw.flam.sample, ww.flam.sample, sample.wt, spp, start.temp,  gww.gdw.saturated, gdw.gww.saturated, fd, fh, gd, gti, pfg, dry.norm.fd, dry.norm.fh, dry.norm.gd, dry.norm.gti, dry.norm.pfg, temp.max, ttfg, tti, temp.change, PC1, PC2, PC3, PC4, model, LFM, prop.ignite, bins10lfm, flam.index, precip.2mo) 
#%>% 
 # write_csv(here("processed-data", "mem.data.local.epi_PCAdontuse.csv"))

#check out data: 
#str(mem.data)
```
