---
title: "Season and Species Effects"
author: "Indra Boving & Joe Celebrezze"
date: "12/17/2021"
output: html_document
---

This script contains code necessary to formulate figures describing differences observed between species and between time points with different antecedent precipitations. It shows both figures that are in the paper as well as supplemental or exploratory figures.

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(cowplot)
library(lmerTest)
library(ggeffects)  # install the package first if you haven't already, then load it
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)
#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data
library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
library(segmented)
filter = dplyr::filter
mutate = dplyr::mutate
library(nlme)
library(MetBrewer)
#install.packages("segmented")
#devtools::install_github("hohenstein/remef")
library(remef)
library(gridExtra)
```

Set global options for color palettes and themes: 

```{r}
th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank())

th.spp.wrap <- theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12) +
  scale_color_manual(values=met.brewer("Morgenstern", 7)))

Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c(7, 5, 4, 6, 3, 2, 1), colorblind=TRUE)
```

#------------------------------------
# 1. Data wrangling

Seasonal mins and maxs from 2016 - 2020:

https://www.sbbg.org/about/onsite-weather-station-live-fuel-moisture 

```{r}
adfa_min <- 55
adfa_max <- 110

ceme_min <- 55
ceme_max <- 140
```

### All dates datasets
```{r}
seg.data.subset.alldates <- read.csv(here('processed-data', 'mem.data.subset.alldates'))

seg.data.subset.alldates <- seg.data.subset.alldates %>% 
  na.omit()
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
seg.adfa.subset <- seg.data.subset.alldates  %>% 
  filter(spp == "ADFA") %>% 
  filter(ignition == "1")

seg.CEME.subset <- seg.data.subset.alldates  %>% 
  filter(spp == "CEME")%>% 
  filter(ignition == "1")

seg.adfa.subset.allignitions <- seg.data.subset.alldates  %>% 
  filter(spp == "ADFA")

seg.CEME.subset.allignitions <- seg.data.subset.alldates %>% 
  filter(spp == "CEME")

seg.adfa.subset.limited <- seg.adfa.subset %>% 
  filter(lfm.unscaled < adfa_max, lfm.unscaled > adfa_min)

seg.CEME.subset <- seg.data.subset.alldates %>% 
  filter(spp == "CEME")

seg.CEME.subset.limited <- seg.CEME.subset %>% 
  filter(lfm.unscaled < ceme_max, lfm.unscaled > ceme_min)
```

Scale LFM based on sample data: 
```{r}
seg.data.subset.alldates <- seg.data.subset.alldates %>%
  group_by(year.month) %>% 
  mutate(lfm.scaled.by.year = scale(lfm), 
         mpa.scaled.by.year = scale(mpa))
```

Labels for species names:
```{r}
spp.labs <- c("Adenostoma fasciculatum", "Ceanothus megacarpus")
names(spp.labs) <- c("ADFA", "CEME")
```

#------------------------------------
# 2.0 Season Effects Plot(s)

Model: 
```{r}
seg.data.subset.alldates <- seg.data.subset.alldates %>% 
  mutate(season = case_when(
    precip.2mo < 0.5 ~ "Dry", 
    precip.2mo > 0.5 ~ "Wet")
  )

precip_mod <- lmer(PC1 ~ mpa.unscaled + Species + season + (1 | individual), data = seg.data.subset.alldates)

summary(precip_mod)

r1_1 <- remef(precip_mod ,  ran = "all")
#summary(r1_1)
scaled_r1_1_df <- as.data.frame(r1_1)
#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051
```

```{r}
precip_mod.2 <- lmer(PC2 ~ mpa.unscaled + Species + season + (1 | individual), data = seg.data.subset.alldates)

r1_2 <- remef(precip_mod.2, ran = 'all')

scaled_r1_2_df <- as.data.frame(r1_2)
```

```{r}
precip_groups_ranis <- cbind(seg.data.subset.alldates, scaled_r1_1_df, scaled_r1_2_df)
```

## NOTE: How do we include r1_1 in figure?

## 2.0.1 Main Figure

### PC1
Ignitability + combustibility proxy (used as 'flammability' proxy)
```{r}
season_plot.pc1 <- precip_groups_ranis  %>%
  ggplot(aes(y = r1_1, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Ignitability-Combustibility Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,6.25), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
         
season_plot.pc1
```

### PC2
Consumability proxy
```{r}
season_plot.pc2 <- precip_groups_ranis  %>%
  ggplot(aes(y = r1_2, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Consumability Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,5), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
         
season_plot.pc2
```

Both PC1 and PC2
```{r}
season_plot.both <- cowplot::plot_grid(season_plot.pc1, season_plot.pc2, nrow = 2)

season_plot.both

ggsave(here("figures", "season_plot.jpg"),
       plot = season_plot.both, 
       width = 6, height = 8, dpi = 300)
```


### Significance Tests
```{r}
# Is species significant predictor of PC1?
precip_mod <- lmer(PC1 ~ mpa.unscaled + Species*season + (1 | individual), data = seg.data.subset.alldates)
summary(precip_mod)
# Yes

# For CEME?
seg.data.subset.alldates.ceme <- seg.data.subset.alldates %>%
  filter(spp == "CEME")
precip_mod.ceme <- lmer(PC1 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.ceme)
summary(precip_mod.ceme)
# Yes

# For ADFA?
seg.data.subset.alldates.adfa <- seg.data.subset.alldates %>%
  filter(spp == "ADFA")
precip_mod.adfa <- lmer(PC1 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.adfa)
summary(precip_mod.adfa)
# Yes

# Is species significant predictor of PC1?
precip_mod2 <- lmer(PC2 ~ mpa.unscaled + Species*season + (1 | individual), data = seg.data.subset.alldates)
summary(precip_mod2)
# Yes

# For CEME?
precip_mod.ceme2 <- lmer(PC2 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.ceme)
summary(precip_mod.ceme2)
# Yes

# For ADFA?
precip_mod.adfa2 <- lmer(PC2 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.adfa)
summary(precip_mod.adfa2)
# Yes
```
## Main Figure (cont.) LFM, Dry Weight, MPa Relationships
Models:
```{r}
mpalfm_mod <- lmer(lfm ~ mpa + Species + season + (1 | individual), data = seg.data.subset.alldates)

summary(mpalfm_mod)

r1_lfm <- remef(mpalfm_mod ,  ran = "all")
scaled_r1_lfm_df <- as.data.frame(r1_lfm)
###
mpadw_mod <- lmer(dw.flam.sample ~ mpa + Species + season + (1 | individual), data = seg.data.subset.alldates)

summary(mpadw_mod)

r1_dw <- remef(mpadw_mod ,  ran = "all")
scaled_r1_dw_df <- as.data.frame(r1_dw)
```

### MPa vs LFM
```{r}
seg.data.subset.alldates <- seg.data.subset.alldates %>%
  mutate(season = case_when(
    timing %in% c("Dec. 2019", "Dec. 2016", "Jan. 2018", "Jan. 2020") ~ "Wet", 
    timing == "Sept. 2020" ~ "Dry"
  ))

mpa_rel_df <- cbind(scaled_r1_dw_df, scaled_r1_lfm_df, seg.data.subset.alldates)
```

```{r}
mpa.vs.lfm.plot <- mpa_rel_df %>% 
  ggplot(aes(y = r1_lfm, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (MPa)", 
       y = "Live Fuel Moisture (Scaled, Effects Removed)", 
       fill = "Season",
       color = "Season") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))

mpa.vs.lfm.plot
```

### MPa vs. DW
```{r}
mpa.vs.dw.plot <- mpa_rel_df %>% 
  ggplot(aes(y = r1_dw, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (MPa)", 
       y = "Dry Weight (Scaled, Effects Removed)", 
       fill = "Season",
       color = "Season") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  scale_y_continuous(limits=c(-2,2.5), breaks=c(-2, -1, 0, 1, 2)) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))

mpa.vs.dw.plot
```

### Main Figure: Arranging plots
```{r}
legend.sz <- get_legend(
  # create some space to the top of the legend
  ggplot() + 
  geom_point(data= seg.data.subset.alldates, aes(mpa.unscaled, PC1, color = season), size = 1, alpha = .8) +
    labs(color = "Season", shape = "Season") +
    scale_color_manual(values=c("#c1121f","#669BBC")) +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot.sz <- cowplot::plot_grid(
        season_plot.pc1 + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        mpa.vs.lfm.plot + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        season_plot.pc2 + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        mpa.vs.dw.plot + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=20))

#add to plot
scatterplot.sz <- gridExtra::grid.arrange(arrangeGrob(plot.sz, bottom = x.grob)) 
scatterplot.sz

plot_legend.sz <- cowplot::plot_grid(legend.sz, scatterplot.sz, ncol = 1, rel_heights = c(1,12))
plot_legend.sz


ggsave(here("figures", "season.plot.expanded.jpg"),
       plot = plot_legend.sz,
       width = 17, height = 10, dpi = 300)
```

## MPa vs PC1

Timing (Year Month)
```{r}
mpa_mod_fig.mpa <- lmer(PC1 ~ mpa.unscaled + Species + year.month + (1 | individual), data = seg.data.subset.alldates)

effects_mpa_fig.mpa <- effects::effect(term= c("mpa.unscaled","year.month"),
                                   mod= mpa_mod_fig.mpa, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_mpa_fig.mpa <- as.data.frame(effects_mpa_fig.mpa)
```

```{r}
precip_plot <- seg.data.subset.alldates %>%
  ggplot(aes(y = PC1, x = mpa.unscaled, 
             #color = as.factor(timing)
             color = as.factor(precip.2mo)
             )) +
  geom_point(size = 1, alpha = .5) +
  #geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit, color = year.month)) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
  # ggpubr::stat_regline_equation(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  #                                   label.y = 4) +
  #stat_cor() +
  labs(x = "Water Potential (MPa)", 
       y = "PC1 ", 
       color = "Precip. (in)") +
 # scale_color_discrete(name = "Site")+
  th +
 # scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 11)) +
  facet_wrap(~Species) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
precip_plot

ggsave(here("figures", "precip_plot.jpg"),
       plot = precip_plot, 
       width = 6, height = 4, dpi = 300)
```

## LFM vs PC1
```{r}
precip_plot <- seg.data.subset.alldates %>%
  ggplot(aes(y = PC1, x = lfm.unscaled, 
             #color = as.factor(timing)
             color = as.factor(precip.2mo)
             )) +
  geom_point(size = 1, alpha = .5) +
  #geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit, color = year.month)) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
  # ggpubr::stat_regline_equation(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  #                                   label.y = 4) +
  #stat_cor() +
  labs(x = "LFM", 
       y = "PC1 ", 
       color = "Precip. (in)") +
 # scale_color_discrete(name = "Site")+
  th +
 # scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 11)) +
  facet_wrap(~Species) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
precip_plot

ggsave(here("figures", "precip_plot.jpg"),
       plot = precip_plot, 
       width = 6, height = 4, dpi = 300)
```

## Dry Weight vs PC1
```{r}
mod_dw <- lmer(PC1 ~ dw.flam.sample + Species * season + (1 | individual), data = seg.data.subset.alldates)

summary(mod_dw)
```

```{r}
precip_plot.dw <- seg.data.subset.alldates %>%
  ggplot(aes(y = PC1, x = dw.flam.sample,
             color = as.factor(precip.2mo)
             )) +
  geom_point(size = 1, alpha = .5) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
  labs(x = "Dry Weight (g)", 
       y = "PC1 ", 
       color = "Precip. (in)") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 11)) +
  facet_wrap(~Species) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
precip_plot.dw

ggsave(here("figures", "dw_plot.jpg"),
       plot = precip_plot.dw, 
       width = 6, height = 4, dpi = 300)
```

## Timing and precip plot
Precip. designated by size of point, timing by color

Model: 
```{r}
precip_mod <- lmer(lfm.unscaled ~ mpa.unscaled + Species + timing + (1 | individual), data = seg.data.subset.alldates)

#remove fixed effect of year.month
#     see what names are associated: 
terms <- term2coef(precip_mod, "timing") %>% 
  list()
terms

r1_1 <- remef(precip_mod ,  ran = "all")

#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051

scaled_r1_1_df <- as.data.frame(r1_1)
precip_groups_ranis <- cbind(seg.data.subset.alldates, scaled_r1_1_df)
```

Plot: 
```{r}
timing_plot <- precip_groups_ranis %>%
ggplot(aes(y = lfm.unscaled, 
             x = mpa.unscaled, 
             color = as.factor(timing))) +
  geom_jitter(aes(size = precip.2mo),
    alpha = .5) +
            scale_size_continuous(limits = c(0,6), guide='none')+
  #geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit, color = year.month)) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
 ggpubr::stat_regline_equation() +
  labs(x = "Water Potential (-MPa)", 
       y = "Live Fuel Moisture (%)", 
       color = "Timing", 
       size = "Precip.") +
 # scale_color_discrete(name = "Site")+
  th +
 # scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 10)) +
  facet_wrap(~Species) +
  #theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
timing_plot

ggsave(here("figures", "timing_precip_plot.jpg"),
       plot = timing_plot, 
       width = 6, height = 4, dpi = 300)
```

```{r}
mpa_lfm_mod <- lmer(lfm ~ mpa.unscaled + Species + year.month + (1| individual), data = seg.data.subset.alldates)
mpa_lfm_mod

tab_model(mpa_lfm_mod)
```

#------------------------------------
# 2.1 Species Effects Plots

Plotting options
```{r}
color_panels <- scale_color_manual(values=c("#9D0208","#F48C06")) 

th_panels <- theme(
        axis.title.x=element_blank(),
        axis.title.y=element_text(face = 'bold', size = 14),
        legend.position = "none", 
        aspect.ratio = 1, 
        plot.margin = unit(c(0,0,0,0), "cm")
        )
```

### 2.1.1 Data wrangling
Since September 2020 is the only period of time that we tested both species at once, to compare species differences, we must use only these tests
```{r}
scaled.mem.data.sept2020 <- seg.data.subset.alldates %>% 
  filter(year.month == '2020_September')
```



### 2.1.2 Removing effects of random effects
Remeff package

```{r}
mpa_mod_fig_tti <- lmer(tti ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(mpa_mod_fig_tti)

model_coefs <- coef(mpa_mod_fig_tti)$individual %>% 
  mutate(Intercept = `(Intercept)`, Slope = mpa.unscaled) %>% 
  rownames_to_column("individual") %>% 
  select(individual, Intercept, Slope)

# see coefficients
model_coefs

tti_groups_ranis <- left_join(scaled.mem.data.sept2020, model_coefs, by = "individual")

model_coef_plot <- ggplot(data = tti_groups_ranis, 
       mapping = aes(x = mpa.unscaled, 
                     y = tti,
                     colour = individual)
       ) +
  geom_point(na.rm = T, alpha = 0.5) +
  geom_abline(aes(intercept = Intercept, 
                  slope = Slope,
                  colour = individual
                  ),
              size = 1.5
              )+
  theme(legend.position = "none")

# see the plot
model_coef_plot
```

#### Time to ignition
```{r}
mpa_mod_fig_tti <- lmer(tti ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

r1_1 <- remef(mpa_mod_fig_tti, ran = list(individual = c("(Intercept)")))
#summary(r1_1)

#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051

scaled_r1_1_df <- as.data.frame(r1_1)
tti_groups_ranis <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

tti.mpa <- ggplot(data= tti_groups_ranis, aes(mpa.unscaled, r1_1, color = Species, shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= tti_groups_ranis, aes(mpa.unscaled, r1_1, color = Species, fill = Species), se = TRUE, size = 1) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(x="Water Potential (-Mpa)", y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.mpa
```

#### Flame duration
```{r}
mpa_mod_fig_fd <- lmer(fd ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

fd_remef_year <- remef(mpa_mod_fig_fd , ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(fd_remef_year)
fd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

fd.mpa <- ggplot(data= fd_remef_year_df, aes(mpa.unscaled, fd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= fd_remef_year_df, aes(mpa.unscaled, fd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Water Potential (-Mpa)", 
       y="Flame Duration (s)")  +
   th +
  th_panels +
  color_panels
fd.mpa
```

#### Glow duration
```{r}
mpa_mod_fig_gd <- lmer(gd ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(mpa_mod_fig_gd)

gd_remef_year <- remef(mpa_mod_fig_gd , ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(gd_remef_year)
gd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

gd.mpa <- ggplot(data= gd_remef_year_df, aes(mpa.unscaled, gd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= gd_remef_year_df, aes(mpa.unscaled, gd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Water Potential (-Mpa)", 
       y="Glow Duration (s)")  +
  scale_y_continuous(limits = c(50,235), breaks = c(50, 100, 150, 200)) +
   th +
  th_panels +
  color_panels
gd.mpa
```

#### PC1
```{r}
mpa_mod_fig_pc1 <- lmer(PC1 ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

pc1_remef_year <- remef(mpa_mod_fig_pc1 , ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(pc1_remef_year)
pc1_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

pc1.mpa <- ggplot(data= pc1_remef_year_df, aes(mpa.unscaled, pc1_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= pc1_remef_year_df, aes(mpa.unscaled, pc1_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +  
  labs(x="Water Potential (-Mpa)", 
       y="Ignitability-Combustibility Proxy") +
  th +
  th_panels +
  color_panels
  
pc1.mpa
```

#### Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .8) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        tti.mpa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        gd.mpa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        fd.mpa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc1.mpa+ theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=20)
                   )

#add to plot
scatterplot <- gridExtra::grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot

plot_legend <- cowplot::plot_grid (legend, scatterplot, ncol = 1, rel_heights = c(1, 12))
plot_legend


ggsave(here("figures", "species.plot.jpg"),
       plot = plot_legend, 
       width = 10, height = 10, dpi = 300)
```


## 2.1.3 Keeping random effects

#### Time to ignition
```{r}
tti.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, tti, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, tti, color = Species), se = FALSE, size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    x="Water Potential (-Mpa)", 
       y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.mpa
```

#### Flame height
```{r}
fh.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, fh, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, fh, color = Species), se = FALSE, size = 1, alpha = .5) +
   stat_regline_equation() +
  labs(
    x="Water Potential (-Mpa)", 
       y="Flame Height (cm)")  +
   th +
  th_panels +
  color_panels
fh.mpa
```

#### Glow duration
```{r}
gd.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, gd, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, gd, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="Glow Duration (s)") +
   th +
  th_panels +
  color_panels
  
gd.mpa
```

#### PC1
```{r}
pc1.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="PC1") +
  th +
  th_panels +
  color_panels
  
pc1.mpa
```

#### Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .5) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.text = element_text(face = "italic"),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        tti.mpa + theme(plot.margin = unit(c(0, 0, 0, 0), "cm")), 
        gd.mpa + theme(plot.margin = unit(c(0, 0, 0, 0), "cm")), 
        fh.mpa + theme(plot.margin = unit(c(0, 0, 0, 0), "cm")), 
        pc1.mpa+ theme(plot.margin = unit(c(0, 0, 0, 0), "cm")),
       
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=15)
                   )

library("gridExtra")

#add to plot
scatterplot <- grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot

plot_legend <- cowplot::plot_grid(scatterplot, legend, rel_widths = c(4, 1))
plot_legend

ggsave(here("figures", "scatterplot_noremef.jpg"),
       plot = plot_legend, 
       width = 6.5, height = 4.5, dpi = 300)
```
#--------
## 2.1.4 LFM species effects (supplemental figure)
Using remeff to remove random effects

```{r}
lfm_mod_fig_tti <- lmer(tti ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

model_coefs <- coef(lfm_mod_fig_tti)$individual %>% 
  mutate(Intercept = `(Intercept)`, Slope = lfm.unscaled) %>% 
  rownames_to_column("individual") %>% 
  select(individual, Intercept, Slope)

# see coefficients
model_coefs

tti_groups_ranis <- left_join(scaled.mem.data.sept2020, model_coefs, by = "individual")

model_coef_plot <- ggplot(data = tti_groups_ranis, 
       mapping = aes(x = lfm.unscaled, 
                     y = tti,
                     colour = individual)
       ) +
  geom_point(na.rm = T, alpha = 0.5) +
  geom_abline(aes(intercept = Intercept, 
                  slope = Slope,
                  colour = individual
                  ),
              size = 1.5
              )+
  theme(legend.position = "none")

# see the plot
model_coef_plot
```

#### Time to ignition
```{r}
lfm_mod_fig_tti <- lmer(tti ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

r1_1 <- remef(lfm_mod_fig_tti, ran = list(individual = c("(Intercept)")))
#summary(r1_1)

#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051

scaled_r1_1_df <- as.data.frame(r1_1)
tti_groups_ranis <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

tti.lfm <- ggplot(data= tti_groups_ranis, aes(lfm.unscaled, r1_1, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= tti_groups_ranis, aes(lfm.unscaled, r1_1, color = Species, fill = Species), se = TRUE, size = 1) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Live Fuel Moisture (%)", 
       y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.lfm
```

#### Flame duration
```{r}
lfm_mod_fig_fd <- lmer(fd ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(lfm_mod_fig_fd)

fd_remef_year <- remef(lfm_mod_fig_fd, ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(fd_remef_year)
fd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

fd.lfm <- ggplot(data= fd_remef_year_df, aes(lfm.unscaled, fd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= fd_remef_year_df, aes(lfm.unscaled, fd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Live Fuel Moisture (%)", 
       y="Flame Duration (s)")  +
   th +
  th_panels +
  color_panels
fd.lfm
```

#### Glow duration
```{r}
lfm_mod_fig_gd <- lmer(gd ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(lfm_mod_fig_gd)

gd_remef_year <- remef(lfm_mod_fig_gd, ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(gd_remef_year)
gd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

gd.lfm <- ggplot(data= gd_remef_year_df, aes(lfm.unscaled, gd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= gd_remef_year_df, aes(lfm.unscaled, gd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  scale_y_continuous(limits = c(50, 225), breaks = c(50, 100, 150, 200)) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Live Fuel Moisture (%)", 
       y="Glow Duration (s)")  +
   th +
  th_panels +
  color_panels
gd.lfm
```

#### PC1
```{r}
lfm_mod_fig_pc1 <- lmer(PC1 ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(lfm_mod_fig_pc1)

pc1_remef_year <- remef(lfm_mod_fig_pc1, ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(pc1_remef_year)
pc1_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

pc1.lfm <- ggplot(data= pc1_remef_year_df, aes(lfm.unscaled, pc1_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= pc1_remef_year_df, aes(lfm.unscaled, pc1_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x= "Live Fuel Moisture (%)", 
       y= "Ignitability-Combustibility Proxy")  +
   th +
  th_panels +
  color_panels

pc1.lfm
```

#### Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(lfm.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .8) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        tti.lfm + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        gd.lfm + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        fd.lfm + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc1.lfm+ theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Live Fuel Moisture (%)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=20)
                   )
library(gridExtra)
#add to plot
scatterplot <- gridExtra::grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot

plot_legend <- cowplot::plot_grid(legend, scatterplot, ncol = 1, rel_heights = c(1,12))
plot_legend


ggsave(here("figures", "lfm_spp_fx_ranef.jpg"),
       plot = plot_legend, 
       width = 10, height = 10, dpi = 300)
```

# ------------------------------------
# 2.2 Season + Species Effects
Note: Might want to remove.. right now may just be taking up extra space

Splitting season effects into two plots (separated by species)
```{r}
season_plot.adfa <- precip_groups_ranis  %>%
  filter(spp == "ADFA") %>% 
  ggplot(aes(y = PC1, 
             x = mpa.unscaled, 
             color = season,
             shape = season)) +
  geom_point(alpha = .5, size = 1) +
  geom_smooth(method = lm,
              se = FALSE) +
  ggpubr::stat_regline_equation() +
  labs(x = "Water Potential (-MPa)", 
       y = "PC1 ", 
       color = "Season",
       shape = "Season",
       title = "Adenostoma fasciculatum") +
  th +
  theme(plot.title = element_text(face = "italic", size = 15, hjust = 0.5),
        legend.position = "bottom") +
  scale_color_manual(values=met.brewer("Morgenstern", 3)) +
  annotate("text", x = 0.2, y = 0.4, label = "Wet") +
  annotate("text", x = 0.2, y = -0.5, label = "Dry")
season_plot.adfa

season_plot.ceme <- precip_groups_ranis  %>%
  filter(spp == "CEME") %>% 
  ggplot(aes(y = PC1, 
             x = mpa.unscaled, 
             color = season,
             shape = season)) +
  geom_point(alpha = .5, size = 1) +
  geom_smooth(method = lm,
              se = FALSE) +
  ggpubr::stat_regline_equation() +
  labs(x = "Water Potential (-MPa)", 
       y = "PC1 ", 
       color = "Season",
       shape = "Season",
       title = "Ceanothus megacarpus") +
  th +
  theme(plot.title = element_text(face = "italic", size = 15, hjust = 0.5),
        legend.position = "bottom") +
  scale_color_manual(values=met.brewer("Morgenstern", 3))+
  annotate("text", x = 0.2, y = -1, label = "Wet") +
  annotate("text", x = 0.2, y = -1.55, label = "Dry")
season_plot.ceme
```

Species effects plots
```{r}
tti.mpa2 <- ggplot() + 
  geom_point(data= seg.data.subset.alldates, aes(mpa.unscaled, tti, color = Species ,shape = season), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= seg.data.subset.alldates, aes(mpa.unscaled, tti, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="Time to Ignition (s)",
       shape = "Season") +
  scale_color_manual(values = c("#9e748f", "#ffc473")) +
  th
tti.mpa2

gd.mpa2 <- ggplot() + 
  geom_point(data= seg.data.subset.alldates, aes(mpa.unscaled, gd, color = Species ,shape = season), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= seg.data.subset.alldates, aes(mpa.unscaled, gd, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="Glow Duration (s)",
       shape = "Season") +
  scale_color_manual(values = c("#9e748f", "#ffc473")) +
  th
gd.mpa2

fh.mpa2 <- ggplot() + 
  geom_point(data= seg.data.subset.alldates, aes(mpa.unscaled, fh, color = Species ,shape = season), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= seg.data.subset.alldates, aes(mpa.unscaled, fh, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="Flame Height (cm)",
       shape = "Season") +
  scale_color_manual(values = c("#9e748f", "#ffc473")) +
  th
fh.mpa2

pc1.mpa2 <- ggplot() + 
  geom_point(data= seg.data.subset.alldates, aes(mpa.unscaled, PC1, color = Species ,shape = season), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= seg.data.subset.alldates, aes(mpa.unscaled, PC1, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="PC1",
       shape = "Season") +
  scale_color_manual(values = c("#9e748f", "#ffc473")) +
  th
pc1.mpa2
```
# ------
# LFM vs. Water Potential (raw values)
```{r}
ggplot(seg.data.subset.alldates, aes(y = lfm.unscaled, x = mpa)) +
  geom_point(fill = "#c1121f", alpha = 0.6) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  labs(x = "Water Potential (MPa)", y = "Live Fuel Moisture (%)") +
  theme(strip.text = element_text(face = "italic")) +
  th

ggsave(here('figures', 'lfm.vs.mpa.raw.values.jpg'), height = 10, width = 18)
```

