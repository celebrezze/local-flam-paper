---
title: "Season and Species Effects"
author: "Indra Boving & Joe Celebrezze"
date: "12/17/2021"
output: html_document
---

This script contains code necessary to formulate figures describing differences observed between species and between time points with different antecedent precipitations. It shows both figures that are in the paper as well as supplemental or exploratory figures.

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(cowplot)
library(lmerTest)
library(ggeffects)  # install the package first if you haven't already, then load it
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)
#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data
library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
library(segmented)
filter = dplyr::filter
mutate = dplyr::mutate
library(nlme)
library(MetBrewer)
#install.packages("segmented")
#devtools::install_github("hohenstein/remef")
library(remef)
library(gridExtra)
```

Set global options for color palettes and themes: 

```{r}
th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank())

th.spp.wrap <- theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12) +
  scale_color_manual(values=met.brewer("Morgenstern", 7)))

Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c(7, 5, 4, 6, 3, 2, 1), colorblind=TRUE)
```

#------------------------------------
# 1. Data wrangling

Seasonal mins and maxs from 2016 - 2020:

https://www.sbbg.org/about/onsite-weather-station-live-fuel-moisture 

```{r}
adfa_min <- 55
adfa_max <- 110

ceme_min <- 55
ceme_max <- 140
```

### All dates datasets
```{r}
seg.data.subset.alldates <- read.csv(here('processed-data', 'mem.data.subset.alldates'))

seg.data.subset.alldates <- seg.data.subset.alldates %>% 
  na.omit()
```

Numerical 1 or 0 for site, dry vs. wet season
```{r}
seg.data.subset.alldates <- seg.data.subset.alldates %>% 
  mutate(season = case_when(
    precip.2mo < 0.5 ~ "Dry", 
    precip.2mo > 0.5 ~ "Wet")
  ) %>% 
  mutate(site.test = case_when(
    site == "St. Marys" ~ 1,
    site == "Painted Caves" ~ 2
  ))
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
seg.adfa.subset <- seg.data.subset.alldates  %>% 
  filter(spp == "ADFA") %>% 
  filter(ignition == "1")

seg.CEME.subset <- seg.data.subset.alldates  %>% 
  filter(spp == "CEME")%>% 
  filter(ignition == "1")

seg.adfa.subset.allignitions <- seg.data.subset.alldates  %>% 
  filter(spp == "ADFA")

seg.CEME.subset.allignitions <- seg.data.subset.alldates %>% 
  filter(spp == "CEME")

seg.adfa.subset.limited <- seg.adfa.subset %>% 
  filter(lfm.unscaled < adfa_max, lfm.unscaled > adfa_min)

seg.CEME.subset <- seg.data.subset.alldates %>% 
  filter(spp == "CEME")

seg.CEME.subset.limited <- seg.CEME.subset %>% 
  filter(lfm.unscaled < ceme_max, lfm.unscaled > ceme_min)
```

Scale LFM based on sample data: 
```{r}
seg.data.subset.alldates <- seg.data.subset.alldates %>%
  group_by(year.month) %>% 
  mutate(lfm.scaled.by.year = scale(lfm), 
         mpa.scaled.by.year = scale(mpa))
```

Labels for species names:
```{r}
spp.labs <- c("Adenostoma fasciculatum", "Ceanothus megacarpus")
names(spp.labs) <- c("ADFA", "CEME")
```


#------------------------------------
# 2.0 Season Effects Plot(s)
## 2.0.1 REMEF
Although this step actually occurred AFTER the model selection, in the script it is included prior to the model selection, so that I could include the REMEF values in the models so I could see what the slopes/intercepts are for the REMEF visualizations of the mixed effects models
### PC1
```{r}
precip_mod <- lmer(PC1 ~ mpa.unscaled + site.test + Species + season + (1 | individual), data = seg.data.subset.alldates)

summary(precip_mod)

r1_1 <- remef(precip_mod, fix = 'site.test',  ran = "all")
#summary(r1_1)
scaled_r1_1_df <- as.data.frame(r1_1)
#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051
```

### PC2
```{r}
precip_mod.2 <- lmer(PC2 ~ mpa.unscaled + Species + season + site.test + (1 | individual), data = seg.data.subset.alldates)

r1_2 <- remef(precip_mod.2, fix = 'site.test', ran = 'all')

scaled_r1_2_df <- as.data.frame(r1_2)
```

```{r}
precip_groups_ranis <- cbind(seg.data.subset.alldates, scaled_r1_1_df, scaled_r1_2_df)

precip_groups_ranis.adfa <- precip_groups_ranis %>% 
  filter(spp == 'ADFA')
precip_groups_ranis.ceme <- precip_groups_ranis %>% 
  filter(spp == 'CEME')
```

### LFM, DW
```{r}
mpalfm_mod <- lmer(lfm ~ mpa + Species + season + site.test + (1 | individual), data = seg.data.subset.alldates)

summary(mpalfm_mod)

r1_lfm <- remef(mpalfm_mod, fix = 'site.test',  ran = "all")
scaled_r1_lfm_df <- as.data.frame(r1_lfm)
###
mpadw_mod <- lmer(dw.flam.sample ~ mpa + Species + season + site.test + (1 | individual), data = seg.data.subset.alldates)

summary(mpadw_mod)

r1_dw <- remef(mpadw_mod , fix = 'site.test',  ran = "all")
scaled_r1_dw_df <- as.data.frame(r1_dw)
```

```{r}
seg.data.subset.alldates <- seg.data.subset.alldates %>%
  mutate(season = case_when(
    timing %in% c("Dec. 2019", "Dec. 2016", "Jan. 2018", "Jan. 2020") ~ "Wet", 
    timing == "Sept. 2020" ~ "Dry"
  ))

mpa_rel_df <- cbind(scaled_r1_dw_df, scaled_r1_lfm_df, seg.data.subset.alldates)

mpa_rel_df.adfa <- mpa_rel_df %>% 
  filter(spp == 'ADFA')
mpa_rel_df.ceme <- mpa_rel_df %>% 
  filter(spp == 'CEME')
```

## 2.0.2 Model Selection
### Effect of Season - All Flam Metrics
#### ADFA
```{r}
pc1.m <- lmer(PC1 ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

pc1.x <- lmer(PC1 ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

pc2.m <- lmer(PC2 ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

pc2.x <- lmer(PC2 ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

tti.m <- lmer(tti ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

tti.x <- lmer(tti ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

fd.m <- lmer(fd ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

fd.x <- lmer(fd ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

gd.m <- lmer(gd ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

gd.x <- lmer(gd ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

fh.m <- lmer(fh ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

fh.x <- lmer(fh ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

gti.m <- lmer(gti ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

gti.x <- lmer(gti ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

ttfg.m <- lmer(ttfg ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

ttfg.x <- lmer(ttfg ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

pfg.m <- lmer(pfg ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

pfg.x <- lmer(pfg ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

temp.m <- lmer(temp.max ~ mpa.unscaled + site.test + season + (1 | individual), data = seg.adfa.subset)

temp.x <- lmer(temp.max ~ mpa.unscaled + site.test + (1 | individual), data = seg.adfa.subset)

tab_model(pc1.m, pc1.x, pc2.m, pc2.x, tti.m, tti.x, fd.m, fd.x, gd.m, gd.x, fh.m, fh.x, pfg.m, pfg.x, ttfg.m, ttfg.x, temp.m, temp.x, gti.m, gti.x,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "season plot: season improve all models? ADFA",
  string.p = "P-Value", 
  p.style = "stars")
```

#### CEME
```{r}
pc1.m <- lmer(PC1 ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

pc1.x <- lmer(PC1 ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

pc2.m <- lmer(PC2 ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

pc2.x <- lmer(PC2 ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

tti.m <- lmer(tti ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

tti.x <- lmer(tti ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

fd.m <- lmer(fd ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

fd.x <- lmer(fd ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

gd.m <- lmer(gd ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

gd.x <- lmer(gd ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

fh.m <- lmer(fh ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

fh.x <- lmer(fh ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

gti.m <- lmer(gti ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

gti.x <- lmer(gti ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

ttfg.m <- lmer(ttfg ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

ttfg.x <- lmer(ttfg ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

pfg.m <- lmer(pfg ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

pfg.x <- lmer(pfg ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

temp.m <- lmer(temp.max ~ lfm.unscaled + site.test + season + (1 | individual), data = seg.CEME.subset)

temp.x <- lmer(temp.max ~ lfm.unscaled + site.test + (1 | individual), data = seg.CEME.subset)

tab_model(pc1.m, pc1.x, pc2.m, pc2.x, tti.m, tti.x, fd.m, fd.x, gd.m, gd.x, fh.m, fh.x, pfg.m, pfg.x, ttfg.m, ttfg.x, temp.m, temp.x, gti.m, gti.x,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "season plot: season improve all models? CEME",
  string.p = "P-Value", 
  p.style = "stars")
```


### PC1
```{r}
m1 <- lmer(PC1 ~ mpa.unscaled + site.test + Species + season + (1 | individual), data = seg.data.subset.alldates)

m2 <- lmer(PC1 ~ mpa.unscaled + site.test + Species + (1 | individual), data = seg.data.subset.alldates)

m3 <- lmer(PC1 ~ mpa.unscaled*season + site.test + Species + (1 | individual), data = seg.data.subset.alldates)

m.adfa <- lmer(PC1 ~ mpa.unscaled + site + season + (1 | individual), data = seg.adfa.subset)

m.ceme <- lmer(PC1 ~ mpa.unscaled + site + season + (1 | individual), data = seg.CEME.subset)

m.adfa.remef <- lmer(r1_1 ~ mpa.unscaled + site + season + (1 | individual), data = precip_groups_ranis.adfa)

m.ceme.remef <- lmer(r1_1 ~ mpa.unscaled + site + season + (1 | individual), data = precip_groups_ranis.ceme)

tab_model(m1, m2, m3, m.adfa, m.ceme, m.adfa.remef, m.ceme.remef,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "season plot model selection",
         dv.labels = c('Model 1', 'Model 2', 'Model 3', 'Model 1 - ADFA', 'Model 1 - CEME', 'REMEF - ADFA', 'REMEF - CEME'),
  string.p = "P-Value", 
  p.style = "stars")
# Best model is as expected -- PC1 ~ mpa + season + species + site + (1|ind); added models split by species into table
```

### PC2
```{r}
m1 <- lmer(PC2 ~ mpa.unscaled + site.test + Species + season + (1 | individual), data = seg.data.subset.alldates)

m2 <- lmer(PC2 ~ mpa.unscaled + site.test + Species + (1 | individual), data = seg.data.subset.alldates)

m3 <- lmer(PC2 ~ mpa.unscaled*season + site.test + Species + (1 | individual), data = seg.data.subset.alldates)

m.adfa <- lmer(PC2 ~ mpa.unscaled + site + season + (1 | individual), data = seg.adfa.subset)

m.ceme <- lmer(PC2 ~ mpa.unscaled + site + season + (1 | individual), data = seg.CEME.subset)

m.adfa.remef <- lmer(r1_2 ~ mpa.unscaled + site + season + (1 | individual), data = precip_groups_ranis.adfa)

m.ceme.remef <- lmer(r1_2 ~ mpa.unscaled + site + season + (1 | individual), data = precip_groups_ranis.ceme)

tab_model(m1, m2, m3, m.adfa, m.ceme, m.adfa.remef, m.ceme.remef,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "season plot model selection",
         dv.labels = c('Model 1', 'Model 2', 'Model 3', 'Model 1 - ADFA', 'Model 1 - CEME', 'REMEF - ADFA', 'REMEF - CEME'),
  string.p = "P-Value", 
  p.style = "stars")
```

### MPa vs. LFM
```{r}
m1 <- lmer(lfm.outliers.out ~ mpa.unscaled + site.test + Species + season + (1 | individual), data = seg.data.subset.alldates)

m2 <- lmer(lfm.outliers.out ~ mpa.unscaled + site.test + Species + (1 | individual), data = seg.data.subset.alldates)

m3 <- lmer(lfm.outliers.out ~ mpa.unscaled*season + site.test + Species + (1 | individual), data = seg.data.subset.alldates)

m.adfa <- lmer(lfm.outliers.out ~ mpa.unscaled + site + season + (1 | individual), data = seg.adfa.subset)

m.ceme <- lmer(lfm.outliers.out ~ mpa.unscaled + site + season + (1 | individual), data = seg.CEME.subset)

m.adfa.remef <- lmer(r1_lfm ~ mpa.unscaled + site + season + (1 | individual), data = mpa_rel_df.adfa)

m.ceme.remef <- lmer(r1_lfm ~ mpa.unscaled + site + season + (1 | individual), data = mpa_rel_df.ceme)

tab_model(m1, m2, m3, m.adfa, m.ceme, m.adfa.remef, m.ceme.remef,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "season plot model selection",
         dv.labels = c('Model 1', 'Model 2', 'Model 3', 'Model 1 - ADFA', 'Model 1 - CEME', 'REMEF - ADFA', 'REMEF - CEME'),
  string.p = "P-Value", 
  p.style = "stars")
```



## 2.0.3 Visualizations

### PC1
Ignitability + combustibility proxy (used as 'flammability' proxy)
```{r}
season_plot.pc1 <- precip_groups_ranis  %>%
  ggplot(aes(y = PC1, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Ignitability-Combustibility Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,6.25), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
         
season_plot.pc1
```

#### ADFA
```{r}
pc1.vs.mpa.adfa <- precip_groups_ranis  %>%
  filter(spp == 'ADFA') %>% 
  ggplot(aes(y = r1_1, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = -0.137, intercept = -0.022,
              color = '#c1121f', cex = 1, alpha = .9,
              show.legend = FALSE) +
  geom_abline(slope = -0.137, intercept = 0.723,
              color = '#669bbc', cex = 1, alpha = .9,
              show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Ignitability-Combustibility Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,6.25), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title.y = element_text(face = 'bold', size = 18),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = -9.7, y = 6, label = 'a', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc1.vs.mpa.adfa
```

#### CEME
```{r}
pc1.vs.mpa.ceme <- precip_groups_ranis  %>%
  filter(spp == 'CEME') %>% 
  ggplot(aes(y = r1_1, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = -0.147, intercept = -0.678,
              color = '#c1121f', cex = 1, alpha = .9,
              show.legend = FALSE) +
  geom_abline(slope = -0.147, intercept = -0.219,
              color = '#669bbc', cex = 1, alpha = .9,
              show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Ignitability-Combustibility Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,6.25), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = -9.7, y = 6, label = 'b', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc1.vs.mpa.ceme
```

### PC2
Consumability proxy
```{r}
season_plot.pc2 <- precip_groups_ranis  %>%
  ggplot(aes(y = PC2, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Consumability Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,5), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
         
season_plot.pc2
```

#### ADFA
```{r}
pc2.vs.mpa.adfa <- precip_groups_ranis  %>%
  filter(spp == "ADFA") %>% 
  ggplot(aes(y = r1_2, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = 0.109, intercept = 0.589,
              color = '#c1121f', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  geom_abline(slope = 0.109, intercept = 1.26,
              color = '#669bbc', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Consumability Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,5), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title.y = element_text(face = 'bold', size = 18),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = -9.7, y = 4.9, label = 'c', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc2.vs.mpa.adfa
```

#### CEME
```{r}
pc2.vs.mpa.ceme <- precip_groups_ranis  %>%
  filter(spp == 'CEME') %>% 
  ggplot(aes(y = r1_2, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = 0.12, intercept = 0.435,
              color = '#c1121f', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  geom_abline(slope = 0.12, intercept = 1.18,
              color = '#669bbc', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  labs(x = "Water Potential (-MPa)", 
       y = "Consumability Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,5), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = -9.7, y = 4.85, label = 'd', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc2.vs.mpa.ceme
```

Both PC1 and PC2
```{r}
season_plot.both <- cowplot::plot_grid(season_plot.pc1, season_plot.pc2, nrow = 2)

season_plot.both

ggsave(here("figures", "season_plot.jpg"),
       plot = season_plot.both, 
       width = 6, height = 8, dpi = 300)
```

### MPa vs LFM
```{r}
mpa.vs.lfm.plot <- mpa_rel_df %>% 
  ggplot(aes(y = lfm.outliers.out, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (MPa)", 
       y = "Live Fuel Moisture (Scaled)", 
       fill = "Season",
       color = "Season") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))

mpa.vs.lfm.plot
```

#### ADFA
```{r}
mpa.vs.lfm.adfa <- mpa_rel_df %>% 
  filter(spp == 'ADFA') %>% 
  ggplot(aes(y = r1_lfm, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = 0.033, intercept = -0.063,
              color = '#c1121f', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  geom_abline(slope = 0.033, intercept = 0.178,
              color = '#669bbc', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  labs(x = "Water Potential (MPa)", 
       y = "Live Fuel Moisture (Scaled, Effects Removed)", 
       fill = "Season",
       color = "Season") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title.y = element_text(face = 'bold', size = 18),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = -9.7, y = 0.46, label = 'e', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
mpa.vs.lfm.adfa
```

#### CEME
```{r}
mpa.vs.lfm.ceme <- mpa_rel_df %>% 
  filter(spp == 'CEME') %>% 
  ggplot(aes(y = r1_lfm, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = 0.032, intercept = -0.186,
              color = '#c1121f', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  geom_abline(slope = 0.032, intercept = 0.222,
              color = '#669bbc', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  labs(x = "Water Potential (MPa)", 
       y = "Live Fuel Moisture (Scaled, Effects Removed)", 
       fill = "Season",
       color = "Season") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = -9.7, y = 0.2, label = 'f', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
mpa.vs.lfm.ceme
```


### MPa vs. DW
Likely going to omit from final figure
```{r}
mpa.vs.dw.plot <- mpa_rel_df %>% 
  ggplot(aes(y = dw.flam.sample, 
             x = mpa.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .5, aes(color = season)) +
  geom_smooth(method = lm, 
              se = TRUE, 
              aes(fill = season),
              show.legend = FALSE) +
  ggpubr::stat_regline_equation(show.legend = FALSE) +
  labs(x = "Water Potential (MPa)", 
       y = "Dry Weight (Scaled)", 
       fill = "Season",
       color = "Season") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  scale_y_continuous(limits=c(-2,2.5), breaks=c(-2, -1, 0, 1, 2)) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 12),
        axis.title.y = element_text(face = 'bold'),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  scale_fill_manual(values=c("#c1121f","#669BBC"))

mpa.vs.dw.plot
```

## Arranging Main Plots

### Linear Regressions
```{r}
legend.sz <- get_legend(
  # create some space to the top of the legend
  ggplot() + 
  geom_point(data= seg.data.subset.alldates, aes(mpa.unscaled, PC1, color = season), size = 5, alpha = .8) +
    labs(color = "Season", shape = "Season") +
    scale_color_manual(values=c("#c1121f","#669BBC")) +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "right",
          legend.title = element_text(face = 'bold', size = 26),
          legend.text = element_text(size = 22),
          legend.key = element_rect(fill = "white"))
)

plot.sz <- cowplot::plot_grid(
        season_plot.pc1 + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        mpa.vs.lfm.plot + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        season_plot.pc2 + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        mpa.vs.dw.plot + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=24))

#add to plot
scatterplot.sz <- gridExtra::grid.arrange(arrangeGrob(plot.sz, bottom = x.grob)) 
scatterplot.sz

plot_legend.sz <- cowplot::plot_grid(legend.sz, scatterplot.sz, ncol = 1, rel_heights = c(1,12))
plot_legend.sz


ggsave(here("figures", "season.plot.expanded.noREMEF.jpg"),
       plot = plot_legend.sz,
       width = 17, height = 10, dpi = 300)
```

### Mixed Effects Models
```{r}
plot.sz.mem <- cowplot::plot_grid(
        pc1.vs.mpa.adfa + theme(plot.margin = unit(c(0.25, 0.1, 0.25, 0.25), "cm")), 
        pc1.vs.mpa.ceme + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.1), "cm")),
        pc2.vs.mpa.adfa + theme(plot.margin = unit(c(0.25, 0.1, 0.25, 0.25), "cm")), 
        pc2.vs.mpa.ceme + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.1), "cm")),
        mpa.vs.lfm.adfa + theme(plot.margin = unit(c(0.25, 0.1, 0.25, 0.25), "cm")),
        mpa.vs.lfm.ceme + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.1), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2)

#add to plot
scatterplot.sz.mem <- gridExtra::grid.arrange(arrangeGrob(plot.sz.mem, bottom = x.grob)) 
scatterplot.sz.mem

plot_legend.sz.mem <- cowplot::plot_grid(scatterplot.sz.mem, legend.sz, ncol = 2, rel_widths = c(5,1))
plot_legend.sz.mem

ggsave(here("figures", "season.plot.MEM.REMEF.jpg"),
       plot = plot_legend.sz.mem,
       width = 10, height = 18, dpi = 300)
```


## 2.0.4 Statistical Tests
### Significance Tests
```{r}
# Is species significant predictor of PC1?
precip_mod <- lmer(PC1 ~ mpa.unscaled + Species*season + (1 | individual), data = seg.data.subset.alldates)
summary(precip_mod)
# Yes

# For CEME?
seg.data.subset.alldates.ceme <- seg.data.subset.alldates %>%
  filter(spp == "CEME")
precip_mod.ceme <- lmer(PC1 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.ceme)
summary(precip_mod.ceme)
# Yes

# For ADFA?
seg.data.subset.alldates.adfa <- seg.data.subset.alldates %>%
  filter(spp == "ADFA")
precip_mod.adfa <- lmer(PC1 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.adfa)
summary(precip_mod.adfa)
# Yes

# Is species significant predictor of PC2?
precip_mod2 <- lmer(PC2 ~ mpa.unscaled + Species*season + (1 | individual), data = seg.data.subset.alldates)
summary(precip_mod2)
# Yes

# For CEME?
precip_mod.ceme2 <- lmer(PC2 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.ceme)
summary(precip_mod.ceme2)
# Yes

# For ADFA?
precip_mod.adfa2 <- lmer(PC2 ~ mpa.unscaled + season + (1 | individual), data = seg.data.subset.alldates.adfa)
summary(precip_mod.adfa2)
# Yes
```

### ANOVA
```{r}
# Is model with season sig. better than w/o?
## PC1
### ADFA
pc1.w.szn.a <- lmer(PC1 ~ mpa.unscaled + season + site + (1 | individual), data = seg.data.subset.alldates.adfa)
pc1.wo.szn.a <- lmer(PC1 ~ mpa.unscaled + site + (1 | individual), data = seg.data.subset.alldates.adfa)
anova(pc1.w.szn.a, pc1.wo.szn.a)
### CEME
pc1.w.szn.c <- lmer(PC1 ~ mpa.unscaled + season + site + (1 | individual), data = seg.data.subset.alldates.ceme)
pc1.wo.szn.c <- lmer(PC1 ~ mpa.unscaled + site + (1 | individual), data = seg.data.subset.alldates.ceme)
anova(pc1.w.szn.c, pc1.wo.szn.c)

## PC2
### ADFA
pc2.w.szn.a <- lmer(PC2 ~ mpa.unscaled + season + site + (1 | individual), data = seg.data.subset.alldates.adfa)
pc2.wo.szn.a <- lmer(PC2 ~ mpa.unscaled + site + (1 | individual), data = seg.data.subset.alldates.adfa)
anova(pc2.w.szn.a, pc2.wo.szn.a)
### CEME
pc2.w.szn.c <- lmer(PC2 ~ mpa.unscaled + season + site + (1 | individual), data = seg.data.subset.alldates.ceme)
pc2.wo.szn.c <- lmer(PC2 ~ mpa.unscaled + site + (1 | individual), data = seg.data.subset.alldates.ceme)
anova(pc2.w.szn.c, pc2.wo.szn.c)

## MPa vs. LFM
### ADFA
lfm.w.szn.a <- lmer(lfm.outliers.out ~ mpa.unscaled + site + season + (1 | individual), data = seg.data.subset.alldates.adfa)
lfm.wo.szn.a <- lmer(lfm.outliers.out ~ mpa.unscaled + site + (1 | individual), data = seg.data.subset.alldates.adfa)
anova(lfm.w.szn.a, lfm.wo.szn.a)
### CEME
lfm.w.szn.c <- lmer(lfm.outliers.out ~ mpa.unscaled + site + season + (1 | individual), data = seg.data.subset.alldates.ceme)
lfm.wo.szn.c <- lmer(lfm.outliers.out ~ mpa.unscaled + site + (1 | individual), data = seg.data.subset.alldates.ceme)
anova(lfm.w.szn.c, lfm.wo.szn.c)
```

#--------------------------------
# 2.1 Supplementary Season Effects Plots

## MPa vs PC1

Timing (Year Month)
```{r}
mpa_mod_fig.mpa <- lmer(PC1 ~ mpa.unscaled + Species + year.month + (1 | individual), data = seg.data.subset.alldates)

effects_mpa_fig.mpa <- effects::effect(term= c("mpa.unscaled","year.month"),
                                   mod= mpa_mod_fig.mpa, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_mpa_fig.mpa <- as.data.frame(effects_mpa_fig.mpa)
```

```{r}
precip_plot <- seg.data.subset.alldates %>%
  ggplot(aes(y = PC1, x = mpa.unscaled, 
             #color = as.factor(timing)
             color = as.factor(precip.2mo)
             )) +
  geom_point(size = 1, alpha = .5) +
  #geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit, color = year.month)) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
  # ggpubr::stat_regline_equation(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  #                                   label.y = 4) +
  #stat_cor() +
  labs(x = "Water Potential (MPa)", 
       y = "PC1 ", 
       color = "Precip. (in)") +
 # scale_color_discrete(name = "Site")+
  th +
 # scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 11)) +
  facet_wrap(~Species) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
precip_plot

ggsave(here("figures", "precip_plot.jpg"),
       plot = precip_plot, 
       width = 6, height = 4, dpi = 300)
```

## LFM vs PC1
```{r}
precip_plot <- seg.data.subset.alldates %>%
  ggplot(aes(y = PC1, x = lfm.unscaled, 
             #color = as.factor(timing)
             color = as.factor(precip.2mo)
             )) +
  geom_point(size = 1, alpha = .5) +
  #geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit, color = year.month)) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
  # ggpubr::stat_regline_equation(aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
  #                                   label.y = 4) +
  #stat_cor() +
  labs(x = "LFM", 
       y = "PC1 ", 
       color = "Precip. (in)") +
 # scale_color_discrete(name = "Site")+
  th +
 # scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 11)) +
  facet_wrap(~Species) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
precip_plot

ggsave(here("figures", "precip_plot.jpg"),
       plot = precip_plot, 
       width = 6, height = 4, dpi = 300)
```

## Dry Weight vs PC1
```{r}
mod_dw <- lmer(PC1 ~ dw.flam.sample + Species * season + (1 | individual), data = seg.data.subset.alldates)

summary(mod_dw)
```

```{r}
precip_plot.dw <- seg.data.subset.alldates %>%
  ggplot(aes(y = PC1, x = dw.flam.sample,
             color = as.factor(precip.2mo)
             )) +
  geom_point(size = 1, alpha = .5) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
  labs(x = "Dry Weight (g)", 
       y = "PC1 ", 
       color = "Precip. (in)") +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 11)) +
  facet_wrap(~Species) +
  theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
precip_plot.dw

ggsave(here("figures", "dw_plot.jpg"),
       plot = precip_plot.dw, 
       width = 6, height = 4, dpi = 300)
```

## Timing and precip plot
Precip. designated by size of point, timing by color

Model: 
```{r}
precip_mod <- lmer(lfm.unscaled ~ mpa.unscaled + Species + timing + (1 | individual), data = seg.data.subset.alldates)

#remove fixed effect of year.month
#     see what names are associated: 
terms <- term2coef(precip_mod, "timing") %>% 
  list()
terms

r1_1 <- remef(precip_mod ,  ran = "all")

#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051

scaled_r1_1_df <- as.data.frame(r1_1)
precip_groups_ranis <- cbind(seg.data.subset.alldates, scaled_r1_1_df)
```

Plot: 
```{r}
timing_plot <- precip_groups_ranis %>%
ggplot(aes(y = lfm.unscaled, 
             x = mpa.unscaled, 
             color = as.factor(timing))) +
  geom_jitter(aes(size = precip.2mo),
    alpha = .5) +
            scale_size_continuous(limits = c(0,6), guide='none')+
  #geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit, color = year.month)) +
  geom_smooth(method = lm, 
              size = 1, 
              alpha = 1, 
              se = FALSE) +
 ggpubr::stat_regline_equation() +
  labs(x = "Water Potential (-MPa)", 
       y = "Live Fuel Moisture (%)", 
       color = "Timing", 
       size = "Precip.") +
 # scale_color_discrete(name = "Site")+
  th +
 # scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  theme(legend.position = "bottom", 
        strip.text = element_text(face = "italic", size = 12)) +
  scale_color_manual(values=met.brewer("Morgenstern", 10)) +
  facet_wrap(~Species) +
  #theme(legend.position = "bottom") +
  scale_x_continuous(breaks = c(-10, -8, -6, -4, -2, 0))
timing_plot

ggsave(here("figures", "timing_precip_plot.jpg"),
       plot = timing_plot, 
       width = 6, height = 4, dpi = 300)
```

```{r}
mpa_lfm_mod <- lmer(lfm ~ mpa.unscaled + Species + year.month + (1| individual), data = seg.data.subset.alldates)
mpa_lfm_mod

tab_model(mpa_lfm_mod)
```

# 2.1.1 Season Plot: LFM
## REMEF
```{r}
#### PC1
szn.lfm.pc1.mod <- lmer(PC1 ~ lfm.unscaled + site.test + Species + season + (1 | individual), data = seg.data.subset.alldates)

r1_L <- remef(szn.lfm.pc1.mod, fix = 'site.test',  ran = "all")
r1_L_df <- as.data.frame(r1_L)

### PC2
szn.lfm.pc1.mod <- lmer(PC2 ~ lfm.unscaled + site.test + Species + season + (1 | individual), data = seg.data.subset.alldates)

r2_L <- remef(szn.lfm.pc1.mod, fix = 'site.test',  ran = "all")
r2_L_df <- as.data.frame(r2_L)

### Combining into df
szn_lfm_ranis <- cbind(seg.data.subset.alldates, r1_L_df, r2_L_df)

### Splitting by species
szn_lfm_ranis.adfa <- szn_lfm_ranis %>% 
  filter(spp == "ADFA")
szn_lfm_ranis.ceme <- szn_lfm_ranis %>% 
  filter(spp == "CEME")
```

## Model Selection
```{r}
m.adfa.remef <- lmer(r1_L ~ lfm.unscaled + site + season + (1 | individual), data = szn_lfm_ranis.adfa)

m.ceme.remef <- lmer(r1_L ~ lfm.unscaled + site + season + (1 | individual), data = szn_lfm_ranis.ceme)

m.adfa.remef2 <- lmer(r2_L ~ lfm.unscaled + site + season + (1 | individual), data = szn_lfm_ranis.adfa)

m.ceme.remef2 <- lmer(r2_L ~ lfm.unscaled + site + season + (1 | individual), data = szn_lfm_ranis.ceme)

tab_model(m.adfa.remef, m.ceme.remef, m.adfa.remef2, m.ceme.remef2,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "season plot model selection: LFM",
         dv.labels = c('ADFA - PC1', 'CEME - PC1', 'ADFA - PC2', 'CEME - PC2'),
  string.p = "P-Value", 
  p.style = "stars")
```

## PC1
```{r}
#### ADFA
pc1.vs.lfm.adfa <- szn_lfm_ranis  %>%
  filter(spp == 'ADFA') %>% 
  ggplot(aes(y = r1_L, 
             x = lfm.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = -0.01, intercept = 1.121,
              color = '#c1121f', cex = 1, alpha = .9,
              show.legend = FALSE) +
  geom_abline(slope = -0.01, intercept = 1.795,
              color = '#669bbc', cex = 1, alpha = .9,
              show.legend = FALSE) +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignitability-Combustibility Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,6.25), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title.y = element_text(face = 'bold', size = 18),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = 10, y = 6, label = 'a', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc1.vs.lfm.adfa

#### CEME
pc1.vs.lfm.ceme <- szn_lfm_ranis  %>%
  filter(spp == 'CEME') %>% 
  ggplot(aes(y = r1_L, 
             x = lfm.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = -0.013, intercept = 0.817,
              color = '#c1121f', cex = 1, alpha = .9,
              show.legend = FALSE) +
  geom_abline(slope = -0.013, intercept = 1.785,
              color = '#669bbc', cex = 1, alpha = .9,
              show.legend = FALSE) +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignitability-Combustibility Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,6.25), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = 10, y = 6, label = 'b', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc1.vs.lfm.ceme
```

## PC2
```{r}
#### ADFA
pc2.vs.lfm.adfa <- szn_lfm_ranis  %>%
  filter(spp == "ADFA") %>% 
  ggplot(aes(y = r2_L, 
             x = lfm.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = 0.016, intercept = -1.466,
              color = '#c1121f', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  geom_abline(slope = 0.016, intercept = -0.449,
              color = '#669bbc', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Consumability Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,5), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title.y = element_text(face = 'bold', size = 18),
        axis.title.x = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = 10, y = 4.9, label = 'c', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc2.vs.lfm.adfa

#### CEME
pc2.vs.lfm.ceme <- szn_lfm_ranis  %>%
  filter(spp == 'CEME') %>% 
  ggplot(aes(y = r2_L, 
             x = lfm.unscaled,
             fill = season,
             color = season,
             group = season)) +
  geom_point(alpha = .65, aes(color = season), size = 2) +
  geom_abline(slope = 0.008, intercept = -1.184,
              color = '#c1121f', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  geom_abline(slope = 0.008, intercept = -0.683,
              color = '#669bbc', cex = 1, alpha = 0.9,
              show.legend = FALSE) +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Consumability Proxy", 
       fill = "Season",
       color = "Season") +
  scale_y_continuous(limits=c(-5,5), breaks=c(-5,-2.5,0,2.5,5)) +
  th +
  facet_wrap(~spp,
              labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  guides(color = guide_legend(override.aes = list(linetype = 0, shape = 16))) +
  theme(legend.position = "none", 
        legend.title = element_text(face = "bold"),
        legend.key = element_rect(fill = 'white'),
        strip.text = element_text(face = "italic", size = 18),
        axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  annotate('text', x = 10, y = 4.85, label = 'd', size = 12, face = 'bold') +
  scale_fill_manual(values=c("#c1121f","#669BBC"))
pc2.vs.lfm.ceme
```

## Arranging Plots
```{r}
plot.sz.lfm <- cowplot::plot_grid(
        pc1.vs.lfm.adfa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc1.vs.lfm.ceme + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        pc2.vs.lfm.adfa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc2.vs.lfm.ceme + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

lfm.grob <- textGrob("Live Fuel Moisture (%)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=24))

#add to plot
scatterplot.sz.lfm <- gridExtra::grid.arrange(arrangeGrob(plot.sz.lfm, bottom = lfm.grob)) 

plot_legend.sz.lfm <- cowplot::plot_grid(scatterplot.sz.lfm, legend.sz, ncol = 2, rel_widths = c(5,1))
plot_legend.sz.lfm

ggsave(here("figures", "LFM.season.plot.suppfigure.jpg"),
       plot = plot_legend.sz.lfm,
       width = 17, height = 10, dpi = 300)
```

#------------------------------------
# 3.0 Species Effects Plots

Plotting options
```{r}
color_panels <- scale_color_manual(values=c("#9D0208","#F48C06")) 

th_panels <- theme(
        axis.title.x=element_blank(),
        axis.title.y=element_text(face = 'bold', size = 18),
        legend.position = "none", 
        aspect.ratio = 1, 
        plot.margin = unit(c(0,0,0,0), "cm")
        )
```

# 3.0.1 Data wrangling
Since September 2020 is the only period of time that we tested both species at once, to compare species differences, we must use only these tests
```{r}
scaled.mem.data.sept2020 <- seg.data.subset.alldates %>% 
  filter(year.month == '2020_September')
```

# 3.0.2 Model Selection
## Effect of Species - All Flam Metrics
```{r}
pc1.m <- lmer(PC1 ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

pc1.x <- lmer(PC1 ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

pc2.m <- lmer(PC2 ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

pc2.x <- lmer(PC2 ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

tti.m <- lmer(tti ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

tti.x <- lmer(tti ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

fd.m <- lmer(fd ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

fd.x <- lmer(fd ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

fh.m <- lmer(fh ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

fh.x <- lmer(fh ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

gd.m <- lmer(gd ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

gd.x <- lmer(gd ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

pfg.m <- lmer(pfg ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

pfg.x <- lmer(pfg ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

ttfg.m <- lmer(ttfg ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

ttfg.x <- lmer(ttfg ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

temp.m <- lmer(temp.max ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

temp.x <- lmer(temp.max ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

gti.m <- lmer(gti ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

gti.x <- lmer(gti ~ mpa.unscaled + site + (1 | individual), data = scaled.mem.data.sept2020)

tab_model(pc1.m, pc1.x, pc2.m, pc2.x, tti.m, tti.x, fd.m, fd.x, gd.m, gd.x, fh.m, fh.x, pfg.m, pfg.x, ttfg.m, ttfg.x, temp.m, temp.x, gti.m, gti.x,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "species plot: species improve all models?",
  string.p = "P-Value", 
  p.style = "stars")
```

# 3.0.3 Statistical Tests
## ANOVA
Does species significantly improve model?
- Only testing variables in our plot (for now)
```{r}
# PC1
anova(pc1.m, pc1.x)
# TTI
anova(tti.m, tti.x)
# FD
anova(fd.m, fd.x)
# GD
anova(gd.m, gd.x)
```

# 3.0.4 Removing effects of random effects
Remeff package

```{r}
mpa_mod_fig_tti <- lmer(tti ~ mpa.unscaled + Species + site + (1 | individual), data = scaled.mem.data.sept2020)

summary(mpa_mod_fig_tti)

model_coefs <- coef(mpa_mod_fig_tti)$individual %>% 
  mutate(Intercept = `(Intercept)`, Slope = mpa.unscaled) %>% 
  rownames_to_column("individual") %>% 
  select(individual, Intercept, Slope)

# see coefficients
model_coefs

tti_groups_ranis <- left_join(scaled.mem.data.sept2020, model_coefs, by = "individual")

model_coef_plot <- ggplot(data = tti_groups_ranis, 
       mapping = aes(x = mpa.unscaled, 
                     y = tti,
                     colour = individual)
       ) +
  geom_point(na.rm = T, alpha = 0.5) +
  geom_abline(aes(intercept = Intercept, 
                  slope = Slope,
                  colour = individual
                  ),
              size = 1.5
              )+
  theme(legend.position = "none")

# see the plot
model_coef_plot
```

## Time to ignition
```{r}
mpa_mod_fig_tti <- lmer(tti ~ mpa.unscaled + Species + site.test + (1 | individual), data = scaled.mem.data.sept2020)

r1_1 <- remef(mpa_mod_fig_tti, fix = 'site.test', ran = list(individual = c("(Intercept)")))
#summary(r1_1)

#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051

scaled_r1_1_df <- as.data.frame(r1_1)
tti_groups_ranis <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

tti.mpa <- ggplot(data= tti_groups_ranis, aes(mpa.unscaled, tti, color = Species, shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= tti_groups_ranis, aes(mpa.unscaled, r1_1, color = Species, fill = Species), se = TRUE, size = 1) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(x="Water Potential (-Mpa)", y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.mpa
```

## Flame duration
```{r}
mpa_mod_fig_fd <- lmer(fd ~ mpa.unscaled + Species + site.test + (1 | individual), data = scaled.mem.data.sept2020)

fd_remef_year <- remef(mpa_mod_fig_fd, fix = 'site.test', ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(fd_remef_year)
fd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

fd.mpa <- ggplot(data= fd_remef_year_df, aes(mpa.unscaled, fd, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= fd_remef_year_df, aes(mpa.unscaled, fd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Water Potential (-Mpa)", 
       y="Flame Duration (s)")  +
   th +
  th_panels +
  color_panels
fd.mpa
```

## Glow duration
```{r}
mpa_mod_fig_gd <- lmer(gd ~ mpa.unscaled + Species + site.test + (1 | individual), data = scaled.mem.data.sept2020)

summary(mpa_mod_fig_gd)

gd_remef_year <- remef(mpa_mod_fig_gd , fix = 'site.test', ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(gd_remef_year)
gd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

gd.mpa <- ggplot(data= gd_remef_year_df, aes(mpa.unscaled, gd, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= gd_remef_year_df, aes(mpa.unscaled, gd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Water Potential (-Mpa)", 
       y="Glow Duration (s)")  +
  scale_y_continuous(limits = c(50,235), breaks = c(50, 100, 150, 200)) +
   th +
  th_panels +
  color_panels
gd.mpa
```

## PC1
```{r}
mpa_mod_fig_pc1 <- lmer(PC1 ~ mpa.unscaled + Species + site.test + (1 | individual), data = scaled.mem.data.sept2020)

pc1_remef_year <- remef(mpa_mod_fig_pc1 , fix = 'site.test', ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(pc1_remef_year)
pc1_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

pc1.mpa <- ggplot(data= pc1_remef_year_df, aes(mpa.unscaled, PC1, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= pc1_remef_year_df, aes(mpa.unscaled, pc1_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +  
  labs(x="Water Potential (-Mpa)", 
       y="Ignitability-Combustibility Proxy") +
  th +
  th_panels +
  color_panels
  
pc1.mpa
```

## Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .8) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        tti.mpa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        gd.mpa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        fd.mpa + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc1.mpa+ theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=20)
                   )

#add to plot
scatterplot <- gridExtra::grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot

plot_legend <- cowplot::plot_grid (legend, scatterplot, ncol = 1, rel_heights = c(1, 12))
plot_legend


ggsave(here("figures", "species.plot.noREMEF.jpg"),
       plot = plot_legend, 
       width = 10, height = 10, dpi = 300)
```


# 3.0.5 Keeping random effects

#### Time to ignition
```{r}
tti.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, tti, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, tti, color = Species), se = FALSE, size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    x="Water Potential (-Mpa)", 
       y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.mpa
```

#### Flame height
```{r}
fh.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, fh, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, fh, color = Species), se = FALSE, size = 1, alpha = .5) +
   stat_regline_equation() +
  labs(
    x="Water Potential (-Mpa)", 
       y="Flame Height (cm)")  +
   th +
  th_panels +
  color_panels
fh.mpa
```

#### Glow duration
```{r}
gd.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, gd, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, gd, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="Glow Duration (s)") +
   th +
  th_panels +
  color_panels
  
gd.mpa
```

#### PC1
```{r}
pc1.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species,shape = Species), size = 1, alpha = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species), se = FALSE, size = 1) +
  labs(x="Water Potential (-Mpa)", 
       y="PC1") +
  th +
  th_panels +
  color_panels
  
pc1.mpa
```

#### Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .5) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.text = element_text(face = "italic"),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        tti.mpa + theme(plot.margin = unit(c(0, 0, 0, 0), "cm")), 
        gd.mpa + theme(plot.margin = unit(c(0, 0, 0, 0), "cm")), 
        fh.mpa + theme(plot.margin = unit(c(0, 0, 0, 0), "cm")), 
        pc1.mpa+ theme(plot.margin = unit(c(0, 0, 0, 0), "cm")),
       
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=15)
                   )

library("gridExtra")

#add to plot
scatterplot <- grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot

plot_legend <- cowplot::plot_grid(scatterplot, legend, rel_widths = c(4, 1))
plot_legend

ggsave(here("figures", "scatterplot_noremef.jpg"),
       plot = plot_legend, 
       width = 6.5, height = 4.5, dpi = 300)
```

# 3.0.6 Using Mixed Effects Models
#### Models
```{r}
m.tti <- lmer(r1_1 ~ mpa.unscaled + Species + site + (1 | individual), data = tti_groups_ranis)

m.tti.nospp <- lmer(r1_1 ~ mpa.unscaled + site + (1 | individual), data = tti_groups_ranis)

m.fd <- lmer(fd_remef_year ~ mpa.unscaled + Species + site + (1 | individual), data = fd_remef_year_df)

m.fd.nospp <- lmer(fd_remef_year ~ mpa.unscaled + site + (1 | individual), data = fd_remef_year_df)

m.gd <- lmer(gd_remef_year ~ mpa.unscaled + Species + site + (1 | individual), data = gd_remef_year_df)

m.gd.nospp <- lmer(gd_remef_year ~ mpa.unscaled + site + (1 | individual), data = gd_remef_year_df)

m.pc1 <- lmer(pc1_remef_year ~ mpa.unscaled + Species + site + (1 | individual), data = pc1_remef_year_df)

m.pc1.nospp <- lmer(pc1_remef_year ~ mpa.unscaled + site + (1 | individual), data = pc1_remef_year_df)

tab_model(m.tti, m.tti.nospp, m.fd, m.fd.nospp, m.gd, m.gd.nospp, m.pc1, m.pc1.nospp,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "species plot model selection",
         dv.labels = c('TTI Model', 'no spp', 'FD Model', 'no spp', 'GD Model', 'no spp', 'PC1 Model', 'no spp'),
  string.p = "P-Value", 
  p.style = "stars")
```

#### PC1
```{r}
pc1.mpa.mem <- ggplot(data= pc1_remef_year_df, aes(mpa.unscaled, pc1_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 2, alpha = .65) + 
  geom_abline(slope = -0.109, intercept = -0.882, color = "#9D0208", cex = 1, alpha = 0.9) +
  geom_abline(slope = -0.109, intercept = -1.674, color = "#F48C06", cex = 1, alpha = 0.9) +
  labs(x="Water Potential (-Mpa)", y="Ignitability-Combustibility Proxy") +
  annotate('text', x = -7.69, y = -4.76, label = 'Species Difference: *** p < 0.001', size = 3) +
  annotate('text', x = -9.7, y = 3.775, label = 'a', size = 12) +
  th +
  th_panels +
  color_panels
pc1.mpa.mem
```

#### Time to ignition
```{r}
tti.mpa.mem <- ggplot(data= tti_groups_ranis, aes(mpa.unscaled, r1_1, color = Species, shape = Species)) + 
  geom_point(size = 2, alpha = .65) + 
  geom_abline(slope = 1.381, intercept = 47.489, color = "#9D0208", cex = 1, alpha = 0.9) +
  geom_abline(slope = 1.381, intercept = 54.879, color = "#F48C06", cex = 1, alpha = 0.9) +
  annotate('text', x = -7.5, y = 2, label = 'Species Difference: *** p < 0.001', size = 3) +
  annotate('text', x = -9.7, y = 80, label = 'b', size = 12) +
  labs(x="Water Potential (-Mpa)", y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.mpa.mem
```

#### Flame duration
```{r}
fd.mpa.mem <- ggplot(data= fd_remef_year_df, aes(mpa.unscaled, fd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 2, alpha = .65) + 
  geom_abline(slope = -0.133, intercept = 7.162, color = "#9D0208", cex = 1, alpha = 0.9) +
  geom_abline(slope = -0.133, intercept = 5.056, color = "#F48C06", cex = 1, alpha = 0.9) +
  labs(x="Water Potential (-Mpa)", y="Flame Duration (s)")  +
  annotate('text', x = -7.5, y = 0.783, label = 'Species Difference: *** p < 0.001', size = 3) +
  annotate('text', x = -9.7, y = 21.75, label = 'c', size = 12) +
  th +
  th_panels +
  color_panels
fd.mpa.mem
```

#### Glow duration
```{r}
gd.mpa.mem <- ggplot(data= gd_remef_year_df, aes(mpa.unscaled, gd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 2, alpha = .65) + 
  geom_abline(slope = -1.18, intercept = 125.59, color = "#9D0208", cex = 1, alpha = 0.9) +
  geom_abline(slope = -1.18, intercept = 131.917, color = "#F48C06", cex = 1, alpha = 0.9) +
  labs(x="Water Potential (-Mpa)", y="Glow Duration (s)")  +
  scale_y_continuous(limits = c(50,235), breaks = c(50, 100, 150, 200)) +
  annotate('text', x = -7.5, y = 52, label = 'Species Difference: insignificant', size = 3) +
  annotate('text', x = -9.7, y = 225, label = 'd', size = 12) +
  th +
  th_panels +
  color_panels
gd.mpa.mem
```

#### Main Figure: Arranging Above Plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(mpa.unscaled, PC1, color = Species, shape = Species), size = 5, alpha = .8) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 18),
          legend.title = element_text(face = 'bold', size = 22),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        pc1.mpa.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        tti.mpa.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        fd.mpa.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        gd.mpa.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2)

x.grob <- textGrob("Water Potential (MPa)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=24)
                   )

#add to plot
scatterplot.mem <- gridExtra::grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot.mem

plot_legend.mem <- cowplot::plot_grid (legend, scatterplot.mem, ncol = 1, rel_heights = c(1,12))
plot_legend.mem

ggsave(here("figures", "species.scatterplot.MEM.jpg"),
       plot = plot_legend.mem, 
       width = 10, height = 10, dpi = 300)
```



#--------
## 3.1.0 LFM Species Effects (supplemental figure)
Using remeff to remove random effects

```{r}
lfm_mod_fig_tti <- lmer(tti ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

model_coefs <- coef(lfm_mod_fig_tti)$individual %>% 
  mutate(Intercept = `(Intercept)`, Slope = lfm.unscaled) %>% 
  rownames_to_column("individual") %>% 
  select(individual, Intercept, Slope)

# see coefficients
model_coefs

tti_groups_ranis <- left_join(scaled.mem.data.sept2020, model_coefs, by = "individual")

model_coef_plot <- ggplot(data = tti_groups_ranis, 
       mapping = aes(x = lfm.unscaled, 
                     y = tti,
                     colour = individual)
       ) +
  geom_point(na.rm = T, alpha = 0.5) +
  geom_abline(aes(intercept = Intercept, 
                  slope = Slope,
                  colour = individual
                  ),
              size = 1.5
              )+
  theme(legend.position = "none")

# see the plot
model_coef_plot
```

#### Time to ignition
```{r}
lfm_mod_fig_tti <- lmer(tti ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

r1_1 <- remef(lfm_mod_fig_tti, ran = list(individual = c("(Intercept)")))
#summary(r1_1)

#https://stats.stackexchange.com/questions/258285/how-to-do-partial-regression-plots-with-linear-mixed-effect-models/258292#258292?newreg=3b55c635f610441db980674675bc0051

scaled_r1_1_df <- as.data.frame(r1_1)
tti_groups_ranis <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

tti.lfm <- ggplot(data= tti_groups_ranis, aes(lfm.unscaled, r1_1, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= tti_groups_ranis, aes(lfm.unscaled, r1_1, color = Species, fill = Species), se = TRUE, size = 1) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Live Fuel Moisture (%)", 
       y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.lfm
```

#### Flame duration
```{r}
lfm_mod_fig_fd <- lmer(fd ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(lfm_mod_fig_fd)

fd_remef_year <- remef(lfm_mod_fig_fd, ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(fd_remef_year)
fd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

fd.lfm <- ggplot(data= fd_remef_year_df, aes(lfm.unscaled, fd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= fd_remef_year_df, aes(lfm.unscaled, fd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Live Fuel Moisture (%)", 
       y="Flame Duration (s)")  +
   th +
  th_panels +
  color_panels
fd.lfm
```

#### Glow duration
```{r}
lfm_mod_fig_gd <- lmer(gd ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(lfm_mod_fig_gd)

gd_remef_year <- remef(lfm_mod_fig_gd, ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(gd_remef_year)
gd_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

gd.lfm <- ggplot(data= gd_remef_year_df, aes(lfm.unscaled, gd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= gd_remef_year_df, aes(lfm.unscaled, gd_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  scale_y_continuous(limits = c(50, 225), breaks = c(50, 100, 150, 200)) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x="Live Fuel Moisture (%)", 
       y="Glow Duration (s)")  +
   th +
  th_panels +
  color_panels
gd.lfm
```

#### PC1
```{r}
lfm_mod_fig_pc1 <- lmer(PC1 ~ lfm.unscaled + Species + (1 | individual), data = scaled.mem.data.sept2020)

summary(lfm_mod_fig_pc1)

pc1_remef_year <- remef(lfm_mod_fig_pc1, ran = list(individual = c("(Intercept)")))

scaled_r1_1_df <- as.data.frame(pc1_remef_year)
pc1_remef_year_df <- cbind(scaled.mem.data.sept2020, scaled_r1_1_df)

pc1.lfm <- ggplot(data= pc1_remef_year_df, aes(lfm.unscaled, pc1_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_smooth(method = "lm", data= pc1_remef_year_df, aes(lfm.unscaled, pc1_remef_year, color = Species, fill = Species), se = TRUE, size = 1, alpha = .5) +
  ggpubr::stat_regline_equation(legend = FALSE) +
  labs(
    x= "Live Fuel Moisture (%)", 
       y= "Ignitability-Combustibility Proxy")  +
   th +
  th_panels +
  color_panels

pc1.lfm
```

#### Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(lfm.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .8) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot <- cowplot::plot_grid(
        tti.lfm + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        gd.lfm + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        fd.lfm + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc1.lfm+ theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Live Fuel Moisture (%)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=20)
                   )
library(gridExtra)
#add to plot
scatterplot <- gridExtra::grid.arrange(arrangeGrob(plot, bottom = x.grob)) 
scatterplot

plot_legend <- cowplot::plot_grid(legend, scatterplot, ncol = 1, rel_heights = c(1,12))
plot_legend


ggsave(here("figures", "lfm_spp_fx_ranef.jpg"),
       plot = plot_legend, 
       width = 10, height = 10, dpi = 300)
```

## 3.1.1 LFM Species Effect: Plotting Linear MEM
### Models
```{r}
m.tti <- lmer(r1_1 ~ lfm.unscaled + Species + site + (1 | individual), data = tti_groups_ranis)

m.tti.nospp <- lmer(r1_1 ~ lfm.unscaled + site + (1 | individual), data = tti_groups_ranis)

m.fd <- lmer(fd_remef_year ~ lfm.unscaled + Species + site + (1 | individual), data = fd_remef_year_df)

m.fd.nospp <- lmer(fd_remef_year ~ lfm.unscaled + site + (1 | individual), data = fd_remef_year_df)

m.gd <- lmer(gd_remef_year ~ lfm.unscaled + Species + site + (1 | individual), data = gd_remef_year_df)

m.gd.nospp <- lmer(gd_remef_year ~ lfm.unscaled + site + (1 | individual), data = gd_remef_year_df)

m.pc1 <- lmer(pc1_remef_year ~ lfm.unscaled + Species + site + (1 | individual), data = pc1_remef_year_df)

m.pc1.nospp <- lmer(pc1_remef_year ~ lfm.unscaled + site + (1 | individual), data = pc1_remef_year_df)

tab_model(m.tti, m.tti.nospp, m.fd, m.fd.nospp, m.gd, m.gd.nospp, m.pc1, m.pc1.nospp,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient", 
         title = "species plot model selection",
         dv.labels = c('TTI Model', 'no spp', 'FD Model', 'no spp', 'GD Model', 'no spp', 'PC1 Model', 'no spp'),
  string.p = "P-Value", 
  p.style = "stars")
```

### Time to ignition
```{r}
tti.lfm.mem <- ggplot(data= tti_groups_ranis, aes(lfm.unscaled, r1_1, color = Species, shape = Species), xlim = c(0, 170)) + 
  geom_point(size = 1.2, alpha = .6) + 
 geom_abline(slope = 0.183, intercept = 20.634, color = "#9D0208", cex = 1) +
  geom_abline(slope = 0.183, intercept = 26.591, color = "#F48C06", cex = 1) +
  annotate('text', x = 55, y = 7, label = 'Species Difference: *** p < 0.001', size = 3) +
  labs(x="Live Fuel Moisture (%)", y="Time to Ignition (s)")  +
  th +
  th_panels +
  color_panels
tti.lfm.mem
```

### Flame duration
```{r}
fd.lfm.mem <- ggplot(data= fd_remef_year_df, aes(lfm.unscaled, fd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_abline(slope = -0.015, intercept = 9.519, color = "#9D0208", cex = 1) +
  geom_abline(slope = -0.015, intercept = 7.531, color = "#F48C06", cex = 1) +
  labs(x="Live Fuel Moisture (%)", y="Flame Duration (s)")  +
  annotate('text', x = 55, y = 1, label = 'Species Difference: *** p < 0.001', size = 3) +
   th +
  th_panels +
  color_panels
fd.lfm.mem
```

### Glow duration
```{r}
gd.lfm.mem <- ggplot(data= gd_remef_year_df, aes(lfm.unscaled, gd_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_abline(slope = -0.157, intercept = 131.030, color = "#9D0208", cex = 1) +
  geom_abline(slope = -0.157, intercept = 138.761, color = "#F48C06", cex = 1) +
  labs(x="Live Fuel Moisture (%)", y="Glow Duration (s)")  +
  scale_y_continuous(limits = c(50,235), breaks = c(50, 100, 150, 200)) +
  annotate('text', x = 55, y = 55, label = 'Species Difference: * p < 0.05', size = 3) +
   th +
  th_panels +
  color_panels
gd.lfm.mem
```

### PC1
```{r}
pc1.lfm.mem <- ggplot(data= pc1_remef_year_df, aes(lfm.unscaled, pc1_remef_year, color = Species,shape = Species)) + 
  geom_point(size = 1.2, alpha = .6) + 
  geom_abline(slope = -0.014, intercept = 1.561, color = "#9D0208", cex = 1) +
  geom_abline(slope = -0.014, intercept = 0.876, color = "#F48C06", cex = 1) +
  labs(x="Live Fuel Moisture (%)", y="Ignitability-Combustibility Proxy") +
  annotate('text', x = 55, y = -4.55, label = 'Species Difference: ** p < 0.01', size = 3) +
  th +
  th_panels +
  color_panels
pc1.lfm.mem
```

#### Main Figure: Arranging plots
```{r}
legend <- get_legend(
  # create some space to the left of the legend
  ggplot() + 
  geom_point(data= scaled.mem.data.sept2020, aes(lfm.unscaled, PC1, color = Species, shape = Species), size = 1, alpha = .8) +
    color_panels +
    theme(legend.box.margin = margin(0, 0, 0, 0),
          legend.position = "top",
          legend.text = element_text(face = "italic", size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.key = element_rect(fill = "white"))
)

plot.mem <- cowplot::plot_grid(
        tti.lfm.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        gd.lfm.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        fd.lfm.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")), 
        pc1.lfm.mem + theme(plot.margin = unit(c(0.25, 0.25, 0.25, 0.25), "cm")),
        align='vh', vjust=.5, scale = 1,
        ncol = 2
          )

x.grob <- textGrob("Live Fuel Moisture (%)", 
                   gp=gpar(fontface="bold", 
                           col="black", 
                           fontsize=20)
                   )
#add to plot
scatterplot.mem <- gridExtra::grid.arrange(arrangeGrob(plot.mem, bottom = x.grob)) 
scatterplot.mem

plot_legend.mem <- cowplot::plot_grid(legend, scatterplot.mem, ncol = 1, rel_heights = c(1,12))
plot_legend.mem


ggsave(here("figures", "LFM.species.plot.MEM.jpg"),
       plot = plot_legend.mem, 
       width = 10, height = 10, dpi = 300)
```


# ------
# LFM vs. Water Potential (raw values)
```{r}
ggplot(seg.data.subset.alldates, aes(y = lfm.unscaled, x = mpa)) +
  geom_point(fill = "#c1121f", alpha = 0.6) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs),
             scales = "free" ) +
  labs(x = "Water Potential (MPa)", y = "Live Fuel Moisture (%)") +
  theme(strip.text = element_text(face = "italic")) +
  th

ggsave(here('figures', 'lfm.vs.mpa.raw.values.jpg'), height = 10, width = 18)
```

