---
title: "Field Data Analysis"
author: "Indra Boving & JC"
date: "2/26/2021"
output: html_document
---

# QUESTION
Are we using any of this??

```{r}
#install.packages("ggplot2")
library(ggplot2)
library(dplyr)
library(ggpubr)
library(tidyverse)
#install.packages("segmented")
library(segmented)
#install.packages("cowplot")
library(cowplot)
library(here)
filter = dplyr::filter #apparently there is an override in tidyverse that makes filter sometimes use package stats...so do this. 
```


```{r}
df <- read_csv(here("raw-data", "local_field_data.csv")) %>%  ##read in data, cleaned up in Excel (checked for absurd numbers, removed excel errors due to missing values, etc.)
  mutate(predawn = -1*predawn) %>% 
  mutate(midday = -1*midday)
dlookr::diagnose(df)
```

Organize data:
```{r}
data.xpp <- df %>% 
  select(spp, age, site, pod, lfm, date, predawn, midday, type, LFMtlp, Mpatlp) %>% #filter out super high LFM (check that this is ok? Necessary?)
  mutate(lfm.outliers.out = lfm) #add a column that we can use to take out outliers
  
  range(data.xpp$LFMtlp) 
  

data.xpp <- data.xpp %>%
  filter(!is.na(predawn)) %>% #remove rows where we are missing Xpp values 
  filter(!is.na(midday))

data.xpp <- data.xpp %>%
  mutate_if(is.factor, as.character) 
str(data.xpp) #view data; 

##create new dataset with all Xpp measurements together and column time = predawn or midday 
split.lfm <- gather(data.xpp, key = "time", value = "xpp",
       predawn, midday) 
str(split.lfm)#view
```

Find mean values
```{r}
mean_pd_adfa <- data.xpp %>% filter(spp == "ADFA") %>% 
  summarise(mean.PD.adfa = mean(predawn)) %>% pull()

sd_pd_adfa <- data.xpp %>% filter(spp == "ADFA") %>% 
  summarise(sd.PD.adfa = sd(predawn)) %>% pull()

mean_md_adfa <- data.xpp %>% filter(spp == "ADFA") %>% 
  summarise(mean.MD.adfa = mean(midday)) %>% pull()

sd_md_adfa <- data.xpp %>% filter(spp == "ADFA") %>% 
  summarise(sd.MD.adfa = sd(midday)) %>% pull()

mean_lfm_adfa <- data.xpp %>% filter(spp == "ADFA") %>% 
   filter(!is.na(lfm)) %>% 
  summarise(mean.LFM.adfa = mean(lfm)) %>% pull()

sd_lfm_adfa <- data.xpp %>% filter(spp == "ADFA") %>% 
  filter(!is.na(lfm)) %>% 
  summarise(sd.LFM.adfa = sd(lfm)) %>% pull()


mean_pd_ceme <-data.xpp %>% filter(spp == "CEME") %>% 
  summarise(mean.PD.ceme = mean(predawn)) %>% pull()

sd_pd_ceme <-data.xpp %>% filter(spp == "CEME") %>% 
  summarise(sd.PD.ceme = sd(predawn)) %>% pull()

mean_md_ceme <-data.xpp %>% filter(spp == "CEME") %>% 
  summarise(mean.MD.ceme = mean(midday)) %>% pull()

sd_md_ceme <- data.xpp %>% filter(spp == "CEME") %>% 
  summarise(sd.MD.ceme = sd(midday)) %>% pull()

mean_lfm_ceme <- data.xpp %>% filter(spp == "CEME") %>% 
  summarise(mean.LFM.ceme = mean(lfm)) %>% pull()

sd_lfm_ceme <- data.xpp %>% filter(spp == "CEME") %>% 
  summarise(sd.LFM.ceme = sd(lfm)) %>% pull()
```

```{r}
#Visualize: plot LFM and Water potential:
ggplot(data = data.xpp, aes(x = predawn, y = lfm, color = spp)) +
  geom_point(size = 1) +
  xlim(-8,-2) + 
  ylim(50,125)  + 
  ylab("Live Fuel Moisture") +
  xlab("Predawn (-Mpa)") +
  ggtitle("Local, Sept. 2020") +
  theme_bw()
```

```{r}
#Visualize: plot LFM and Water potential:
ggplot(data = data.xpp, aes(x = midday, y = lfm, color = spp)) +
  geom_point(size = 1) +
  xlim(-10,-4) + 
  ylim(50,125)  + 
  ylab("Live Fuel Moisture") +
  xlab("Middays (-Mpa)") +
  ggtitle("Local, Sept. 2020") +
  theme_bw()
```



```{r}
data.xpp %>% 
  filter(age == "New") %>% 
  ggplot(aes(midday, lfm, fill = spp)) +
  geom_boxplot() +
  ggtitle("Local, 2020, by age")
```

Segmented regression: 

1. Predawn: 
# ERROR pops up in below chunk:

###Looks better with outliers in....300 lfm realistic?

#####build lm model and find inflection point using 'segmented' package...do this with each spp? 

model_segmented.pd <- segmented(lm(lfm ~ predawn, data=data.xpp), seg.Z = ~ predawn)
model_segmented.pd

predict_segmented = data.frame(predawn = data.xpp$predawn, lfm = broken.line(model_segmented.pd)$fit)

my.lines <- model_segmented.pd$psi[,2]

ggplot(df, aes(x = predawn, y = lfm, color = spp)) +
  geom_point() + geom_line(data = predict_segmented, color = 'blue') ##works! kinda weird looking though... 

predict_segmented = data.frame(predawn = data.xpp$predawn, lfm = broken.line(model_segmented.pd)$fit)
ggplot(df, aes(x = predawn, y = lfm, color = date)) +
  geom_point() + 
  geom_line(data = predict_segmented, color = 'purple') +
   geom_vline(xintercept = my.lines, linetype = "dashed")

model_segmented.lfm <- segmented(lm(predawn~lfm, data=data.xpp), seg.Z = ~ lfm)
model_segmented.lfm #get lfm breakpoint value....I think? Might actually be embedded in results above. 


2. Midday 
```{r}
###Looks better with outliers in....300 lfm realistic?

#####build lm model and find inflection point using 'segmented' package...do this with each spp? 

model_segmented.md <- segmented(lm(lfm ~ midday, data=data.xpp), seg.Z = ~ midday)
model_segmented.md

predict_segmented = data.frame(midday = data.xpp$midday, lfm = broken.line(model_segmented.md)$fit)

my.lines <- model_segmented.md$psi[,2]

ggplot(df, aes(x = midday, y = lfm, color = spp)) +
  geom_point() + geom_line(data = predict_segmented, color = 'blue') ##works! kinda weird looking though... 

predict_segmented = data.frame(midday = data.xpp$midday, lfm = broken.line(model_segmented.md)$fit)
ggplot(df, aes(x = midday, y = lfm, color = date)) +
  geom_point() + 
  geom_line(data = predict_segmented, color = 'purple') +
   geom_vline(xintercept = my.lines, linetype = "dashed")

model_segmented.lfm <- segmented(lm(midday~lfm, data=data.xpp), seg.Z = ~ lfm)
model_segmented.lfm #get lfm breakpoint value....I think? Might actually be embedded in results above. 
```


```{r}
###
##compare LFM and all XPPs, splitting trees vs. shrubs
###

lfm.type.plot <- ggplot(split.lfm, aes(fill = type, y = lfm, x = date)) + 
  geom_boxplot(position="dodge")  + theme(axis.text.x = element_blank(),
                                          axis.ticks.x = element_blank(),
                                          axis.title.x = element_blank() )
predawn.xpp.type.plot <- split.lfm %>%
  filter(time == "predawn") %>%
  ggplot(aes(fill = type, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp") + theme(axis.text.x = element_blank(),
                               axis.ticks.x = element_blank(),
                               axis.title.x = element_blank())
#predawn.xpp.type.plot
midday.xpp.type.plot <- split.lfm %>%
  filter(time == "midday") %>%
  ggplot(aes(fill = type, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("midday xpp")

# Create multiple plots in one
#   and then nest it inside of a second. Also, include a title at the top 
#   for the whole figure. 
# title <- ggdraw() + draw_label("Sierra Sites", fontface='bold')
# plot_grid(title, lfm.type.plot,
#           predawn.xpp.type.plot,
#           midday.xpp.type.plot,
#           nrow = 4, labels = c("", "", ""),
#           rel_heights = c(0.2, 1, 1, 1))

###
##compare LFM and all XPPs, split by spp. 
###

lfm.spp.plot <- ggplot(split.lfm, aes(fill = spp, y = lfm, x = date)) + 
  geom_boxplot(position="dodge")  + theme(axis.text.x = element_blank(),
                                          axis.ticks.x = element_blank(),
                                          axis.title.x = element_blank() )
predawn.xpp.spp.plot <- split.lfm %>%
  filter(spp == "ABCO") %>%
  filter(time == "midday") %>%
  ggplot(aes(fill = spp, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp") + theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              axis.title.x = element_blank()) +
  theme_bw() +
  ylab("Midday (-Mpa)")
predawn.xpp.spp.plot
#predawn.xpp.type.plot

midday.xpp.spp.plot <- split.lfm %>%
  filter(time == "midday") %>%
  ggplot(aes(fill = spp, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("Midday (-Mpa)") +
  xlab("Date")
midday.xpp.spp.plot
```
#####
#####
#####

```{r}
##compare LFM and predawn XPPs, no split

lfm.plot <- ggplot(split.lfm, aes(y = lfm, x = date)) + 
  geom_boxplot(position="dodge")  + theme(axis.text.x = element_blank(),
                                          axis.ticks.x = element_blank(),
                                          axis.title.x = element_blank() )
lfm.plot

predawn.plot <- split.lfm %>%
  filter(time == "predawn") %>%
  ggplot(aes(y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp")
predawn.plot
```
