---
title: "Segmented Regressions - Linear Models"
author: "Indra Boving & Joe Celebrezze"
date: "6/7/2022"
output: html_document
---

Work in progress...


#Functions: 

```{r, eval=F}
seg.setup <- function(x, y, df) {
  #out.lm<-lm({{y}}~{{x}}, data = data
  x <- enquo(x)
  y <- enquo(y)
  
#out.lm<-lm(paste(y, "~", x), data = df)

out.lm<-lm(y ~ x, data = df)

segmented.mod <- segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod) #CI of breakpoints
confint

lower <- confint[2] #lower bound
lower

upper <- confint[3] #upper bound
upper

fit <- numeric(length(df$x)) * NA

fit[complete.cases(rowSums(cbind(y, x)))] <- broken.line(segmented.mod)$fit

}

#seg.setup(lfm.unscaled, PC1, seg.CEME.subset)
```

```{r}
segplot <- function(data, x, y, z, tlp_value, lwr, upr, lwr_seg, upr_seg) {
  ggplot(data, aes({{x}}, {{y}})) +
  geom_point()+
  geom_line(aes({{x}}, {{z}}), #segmented line
            color = "blue2") +
  geom_vline(xintercept = tlp_value, #tlp value line
             color = "gold1") +
  geom_ribbon(aes(xmin=lwr, xmax=upr), #tlp CI ribbon
              alpha = .3,
              color = "gold1") +
  geom_vline(xintercept = lwr_seg, #segmented CI line lower
             color = "blue2")+
  geom_vline(xintercept = upr_seg, #segmented CI line upper
             color = "blue2") +
  geom_ribbon(aes(xmin=lwr_seg, xmax=upr_seg), #segmented ribbon
              alpha = .3, 
              color = "blue2") +
   th #theme!

}
```
###10% Changepoints
### ADFA

```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm.unscaled, data = seg.adfa.subset)

davies.test(out.lm)
pscore.test(out.lm)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins10_nodate, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.ceme.subset, lfm.unscaled, prop.ignite.bins10notdate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

### CEME

#with random changepoints: 
```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm.unscaled, data = seg.CEME.subset.limited)

davies.test(out.lm)
pscore.test(out.lm)

plot(groupedData(prop.ignite.bins10_nodate ~ lfm.unscaled|id,data = seg.CEME.subset.limited))

o<-lm(prop.ignite.bins10_nodate ~ lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled)), 
       data = seg.CEME.subset.limited)

#oseg<-segmented.lme(o, Z=lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled+U)))
#oseg

plot(o, n.plot=c(2,10), pop=TRUE)

#confint(oseg)

lower <- confint[2]
lower

upper <- confint[3]
upper

#fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

#fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$prop.ignite.bins10_nodate, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(oseg)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, prop.ignite.bins10_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
###ADFA -- Mpa
```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ mpa.unscaled, data = seg.adfa.subset)

davies.test(out.lm)
pscore.test(out.lm)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins10_nodate, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa.unscaled, prop.ignite.bins10nodate, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

### CEME -- MPa

with random changepoints: 
```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ mpa.unscaled, data = seg.CEME.subset.limited)

davies.test(out.lm)
pscore.test(out.lm)

plot(groupedData(prop.ignite.bins10_nodate ~ mpa.unscaled|id,data = seg.CEME.subset.limited))

o<-lme(prop.ignite.bins10_nodate ~ mpa.unscaled, random=list(id=pdDiag(~1+mpa.unscaled)), 
       data = seg.CEME.subset.limited)

#oseg<-segmented.lme(o, Z=mpa.unscaled, random=list(id=pdDiag(~1+mpa.unscaled+U)))
#oseg

#plot(#oseg, n.plot=c(2,10), pop=TRUE)

#confint(oseg)

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$prop.ignite.bins10_nodate, seg.CEME.subset.limited$mpa.unscaled)))] <- broken.line(o)$fit

segplot(seg.CEME.subset.limited, mpa.unscaled, prop.ignite.bins10_nodate, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```
Trying to make a function to do this: 
```{r}
# seg.random.func <- function(x, y, myd) {
# 
# o<-lme(fixed = as.formula(paste0(y,"~",x)), 
#          random= as.formula(paste0(list(id,"=",pdDiag("~",1,"+",x)))), 
#          data=myd)
# }
# 
# seg.random.func("lfm.unscaled", "prop.ignite.bins10_nodate", seg.CEME.subset)
```
###***Start here

#******PC1

####ADFA

```{r}
seg.adfa.subset <- seg.adfa.subset %>% 
  filter(lfm.unscaled < 150)

out.lm<-lm(PC1 ~ lfm.unscaled, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$PC1, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm.unscaled, PC1, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)

```

```{r}
out.lm<-lm(PC1 ~ lfm.unscaled, data = seg.adfa.subset.limited)

davies.test(out.lm, k = 50
            )
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$PC1, seg.adfa.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm.unscaled, PC1, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)

```

#### CEME

```{r}

seg.CEME.subset <- seg.CEME.subset %>% 
  filter(lfm.unscaled < 300)

out.lm<-lm(PC1 ~ lfm.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)
davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$PC1, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, PC1, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
 
```{r}
out.lm<-lm(PC1 ~ lfm.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$PC1, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, PC1, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

####ADFA --MPa

```{r}
out.lm<-lm(PC1 ~ mpa.unscaled, data = seg.adfa.subset)
davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$PC1, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa.unscaled, PC1, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)

```

```{r}
out.lm<-lm(PC1 ~ mpa.unscaled, data = seg.adfa.subset.limited)

davies.test(out.lm, k = 50
            )
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$PC1, seg.adfa.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, mpa.unscaled, PC1, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)

```

#### CEME--MPa

```{r}
out.lm<-lm(PC1 ~ mpa.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
#segmented.mod
#summary(segmented.mod)
davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$PC1, seg.CEME.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, mpa.unscaled, PC1, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```
 
```{r}
out.lm<-lm(PC1 ~ mpa.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$PC1, seg.CEME.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, mpa.unscaled, PC1, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

```{r}
library(segmented)
#seg.setup(seg.CEME.subset, lfm.unscaled, prop.ignite.bins10_nodate)

out.lm<-lm(prop.ignite.bins10_nodate ~ lfm.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$prop.ignite.bins10_nodate, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, prop.ignite.bins10_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
#with random changepoints: 
o<-lme(prop.ignite.bins10_nodate ~ lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled)), 
       data = seg.CEME.subset.limited)

##oseg<-segmented.lme(o, Z=lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled+U)))

##confint(oseg)

#with no random changepoints, but plotted:
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm.unscaled, data = seg.CEME.subset.limited)

selgmented.mod <- selgmented(out.lm)
selgmented.mod
#dlookr::diagnose(seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
summary(segmented.mod)

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$prop.ignite.bins10_nodate, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, prop.ignite.bins10_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
## Zoomed in: 5%

Bins of 5 LFM used to make prop. ignite column

### ADFA

```{r}
#with random changepoints: 
o<-lme(prop.ignite.bins5_nodate ~ lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled)), 
       data = seg.adfa.subset)

##oseg<-segmented.lme(o, Z=lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled+U)))

##confint(oseg)

#with no random changepoints, but plotted:
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm.unscaled, data = seg.adfa.subset) 
davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins5_nodate, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

segplot(seg.adfa.subset, lfm.unscaled, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```


```{r}

#with random changepoints: 
o<-lme(prop.ignite.bins5_nodate ~ lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled)), 
       data = seg.adfa.subset.limited)

#oseg<-segmented.lme(o, Z=lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled+U)))

#confint(oseg)

#with no random effects: 
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm.unscaled, data = seg.adfa.subset.limited)

davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$prop.ignite.bins5_nodate, seg.adfa.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

segplot(seg.adfa.subset.limited, lfm.unscaled, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```
### CEME

```{r}
#with random changepoints: 
o<-lme(prop.ignite.bins5_nodate ~ lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled)), 
       data = seg.CEME.subset)

#oseg<-segmented.lme(o, Z=lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled+U)))
#oseg

#confint.oseg <- #confint(oseg)
#confint.oseg

lower <- #confint.oseg[7]
lower

upper <- #confint.oseg[8]
upper

out.lm<-lm(prop.ignite.bins5_nodate ~ lfm.unscaled, data = seg.CEME.subset)

davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

confint <- confint(segmented.mod)
confint

lower.seg <- confint[2]
lower.seg

upper.seg <- confint[3]
upper.seg

fit[complete.cases(rowSums(cbind(seg.CEME.subset$prop.ignite.bins5_nodate, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
#with random changepoints: 
o<-lme(prop.ignite.bins5_nodate ~ lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled)), 
       data = seg.CEME.subset.limited)

#oseg<-segmented.lme(o, Z=lfm.unscaled, random=list(id=pdDiag(~1+lfm.unscaled+U)))
#oseg

#confint.oseg <- #confint(oseg)
#confint.oseg

lower <- #confint.oseg[7]
lower

upper <- #confint.oseg[8]
upper

out.lm<-lm(prop.ignite.bins5_nodate ~ lfm.unscaled, data = seg.CEME.subset)

out.lm<-lm(prop.ignite.bins5_nodate ~ lfm.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper


fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$prop.ignite.bins5_nodate, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, prop.ignite.bins5_nodate, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

### ADFA --MPa

```{r}
out.lm<-lm(prop.ignite.bins5 ~ mpa.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

summary(segmented.mod)
davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins5, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa.unscaled, prop.ignite.bins5, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

### CEME--MPa

```{r}
out.lm<-lm(prop.ignite.bins5 ~ mpa.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

summary(segmented.mod)
davies.test(out.lm, k = 50)

fit <- numeric(length(seg.CEME.subset$mpa.unscaled)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit[complete.cases(rowSums(cbind(seg.CEME.subset$prop.ignite.bins5, seg.CEME.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, mpa.unscaled, prop.ignite.bins5, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```


## TTI

### ADFA

```{r}
#https://stats.stackexchange.com/questions/19772/estimating-the-break-point-in-a-broken-stick-piecewise-linear-model-with-rando/19777#19777

out.lm<-lmer(tti ~ lfm.unscaled + (1 | individual), data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm, seg.z = ~lfm.unscaled) #1 breakpoint for x
segmented.mod
davies.test(out.lm, k=50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$tti, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm.unscaled, tti, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

```{r}
out.lm<-lm(tti ~ lfm.unscaled, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$tti, seg.adfa.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, lfm.unscaled, tti, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
 
```
### CEME

```{r}
out.lm<-lm(tti ~ lfm.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$tti, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, tti, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

Remove non-realistic LFMS
```{r}
out.lm<-lm(tti ~ lfm.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

#segmented::slope(segmented.mod)
#pscore.test(segmented.mod)

davies.test(out.lm)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$tti, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, tti, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```


### ADFA --MPa

```{r}
out.lm<-lm(tti ~ mpa.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
davies.test(out.lm, k=50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$tti, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa.unscaled, tti, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

####With random bps
```{r}
#Basis functions
bp = 1
b1 <- function(x, bp) ifelse(x < bp, bp - x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x - bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  # mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)
  
  mod <- lmer(PC1 ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)
  deviance(mod)
}

search.range <- c(min(scaled.mem.data.alldates.noNAs$mpa.unscaled) + 0.5, max(scaled.mem.data.alldates.noNAs$mpa.unscaled)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        tti ~ mpa.unscaled | individual, scaled.mem.data.alldates.noNAs, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "tti",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(PC1 ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)
lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
lb95$root

ub95$root

```

```{r}
out.lm<-lm(tti ~ mpa.unscaled, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$tti, seg.adfa.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, mpa.unscaled, tti, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
 
```
### CEME --MPa

```{r}
out.lm<-lm(tti ~ mpa.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$tti, seg.CEME.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, mpa.unscaled, tti, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

####With random bps
```{r}
#Basis functions
bp = 4
b1 <- function(x, bp) ifelse(x < bp, bp - x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x - bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  # mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)
  
mod <- lmer(PC1 ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = seg.CEME.subset, REML=FALSE)

  deviance(mod)
}

search.range <- c(min(seg.CEME.subset$mpa.unscaled) + 0.5, max(seg.CEME.subset$mpa.unscaled)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        tti ~ mpa.unscaled | individual, seg.CEME.subset, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "tti",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(PC1 ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = seg.CEME.subset, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)
lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
lb95$root

ub95$root

```


Remove non-realistic LFMS
```{r}
out.lm<-lm(tti ~ mpa.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

#segmented::slope(segmented.mod)
#pscore.test(segmented.mod)

davies.test(out.lm)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$tti, seg.CEME.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, mpa.unscaled, tti, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

----
## FD

### ADFA

```{r}
#https://stats.stackexchange.com/questions/19772/estimating-the-break-point-in-a-broken-stick-piecewise-linear-model-with-rando/19777#19777

out.lm<-lm(fd ~ lfm.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm, seg.Z = ~lfm.unscaled) #1 breakpoint for x
segmented.mod
davies.test(out.lm, k=50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fd, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm.unscaled, fd, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

```{r}
out.lm<-lm(fd ~ lfm.unscaled, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fd, seg.adfa.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, lfm.unscaled, fd, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
 
```
### CEME

```{r}
out.lm<-lm(fd ~ lfm.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$fd, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, fd, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

Remove non-realistic LFMS
```{r}
out.lm<-lm(fd ~ lfm.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

#segmented::slope(segmented.mod)
#pscore.test(segmented.mod)

davies.test(out.lm)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$fd, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, fd, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```


### ADFA --MPa

```{r}
out.lm<-lm(fd ~ mpa.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod
davies.test(out.lm, k=50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fd, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa.unscaled, fd, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

####With random bps
```{r}
#Basis functions
bp = -3
b1 <- function(x, bp) ifelse(x < bp, bp + x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x + bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  # mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)
  
  mod <- lmer(fd ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)
  deviance(mod)
}

search.range <- c(min(scaled.mem.data.alldates.noNAs$mpa.unscaled) + 0.5, max(scaled.mem.data.alldates.noNAs$mpa.unscaled)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        fd ~ mpa.unscaled | individual, scaled.mem.data.alldates.noNAs, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "fd",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(fd ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = scaled.mem.data.alldates.noNAs, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)
lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
lb95$root

ub95$root

```

```{r}
out.lm<-lm(fd ~ mpa.unscaled, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fd, seg.adfa.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit


segplot(seg.adfa.subset.limited, mpa.unscaled, fd, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
 
```
### CEME --MPa

```{r}
out.lm<-lm(fd ~ mpa.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$fd, seg.CEME.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, mpa.unscaled, fd, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

####With random bps
```{r}
#Basis functions
bp = 4
b1 <- function(x, bp) ifelse(x < bp, bp - x, 0)
b2 <- function(x, bp) ifelse(x < bp, 0, x - bp)

#Wrapper for Mixed effects model with variable break point
foo <- function(bp)
{
  # mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)
  
mod <- lmer(PC1 ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = seg.CEME.subset, REML=FALSE)

  deviance(mod)
}

search.range <- c(min(seg.CEME.subset$mpa.unscaled) + 0.5, max(seg.CEME.subset$mpa.unscaled)-.5)
foo.opt <- optimize(foo, interval = search.range)
bp <- foo.opt$minimum
bp

##bp = 3.961

#Plot with break point = 4
xyplot(
        fd ~ mpa.unscaled | individual, seg.CEME.subset, aspect = "xy",
        layout = c(6,3), 
        type = c("g", "p", "r"),
        xlab = "mpa",
        ylab = "fd",
        panel = function(x,y) {
        panel.points(x,y)
        panel.lmline(x,y)
        pred <- predict(lm(y ~ b1(x, bp) + b2(x, bp)), newdata = data.frame(x = 0:9))
            panel.lines(0:9, pred, lwd=1, lty=2, col="red")
        }
    )


# search.range <- c(min(sleepstudy$Days)+0.5,max(sleepstudy$Days)-0.5)
# foo.opt <- optimize(foo, interval = search.range)
# bp <- foo.opt$minimum
# bp
# [1] 6.071932
# mod <- lmer(Reaction ~ b1(Days, bp) + b2(Days, bp) + (b1(Days, bp) + b2(Days, bp) | Subject), data = sleepstudy)

mod <- lmer(PC1 ~ b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp) +  Species + year.month + ((b1(mpa.unscaled, bp) + b2(mpa.unscaled, bp))| individual), data = seg.CEME.subset, REML=FALSE)

foo.root <- function(bp, tgt)
{
  foo(bp) - tgt
}
tgt <- foo.opt$objective + qchisq(0.95,1)
lb95 <- uniroot(foo.root, lower=search.range[1], upper=bp, tgt=tgt)
ub95 <- uniroot(foo.root, lower=bp, upper=search.range[2], tgt=tgt)
lb95$root

ub95$root

```


Remove non-realistic LFMS
```{r}
out.lm<-lm(fd ~ mpa.unscaled, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

#segmented::slope(segmented.mod)
#pscore.test(segmented.mod)

davies.test(out.lm)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$fd, seg.CEME.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, mpa.unscaled, fd, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

---
## FH

### ADFA

```{r}
out.lm<-lm(fh ~ lfm.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fh, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm.unscaled, fh, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)

```

```{r}

out.lm<-lm(fh ~ lfm.unscaled, data = seg.adfa.subset.limited)

davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fh, seg.adfa.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm.unscaled, fh, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

### CEME

```{r}
out.lm<-lm(fh ~ lfm.unscaled, data = seg.CEME.subset)

davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$fh, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, fh, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
out.lm<-lm(fh ~ lfm.unscaled, data = seg.CEME.subset.limited)

davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$fh, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, fh, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)

```

### ADFA -- MPa

```{r}
out.lm<-lm(fh ~ mpa.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

davies.test(out.lm, k = 50)

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fh, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, mpa.unscaled, fh, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)

```

```{r}

out.lm<-lm(fh ~ mpa.unscaled, data = seg.adfa.subset.limited)

davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fh, seg.adfa.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, mpa.unscaled, fh, fit, mean_mpa_adfa, lwr_mpa_adfa, upr_mpa_adfa, lower, upper)
```

### CEME -- MPa

```{r}
out.lm<-lm(fh ~ mpa.unscaled, data = seg.CEME.subset)

davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$fh, seg.CEME.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, mpa.unscaled, fh, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)
```

```{r}
out.lm<-lm(fh ~ mpa.unscaled, data = seg.CEME.subset.limited)

davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$fh, seg.CEME.subset.limited$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, mpa.unscaled, fh, fit, mean_mpa_ceme, lwr_mpa_ceme, upr_mpa_ceme, lower, upper)

```

## flam.index

### ADFA

```{r}
out.lm<-lm(flam.index ~ lfm.unscaled, data = seg.adfa.subset)

davies.test(out.lm, k = 50)
#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$flam.index, seg.adfa.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset, lfm.unscaled, flam.index, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper)
```

```{r}

out.lm<-lm(flam.index ~ lfm.unscaled, data = seg.adfa.subset.limited)

davies.test(out.lm, k=50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$flam.index, seg.adfa.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.adfa.subset.limited, lfm.unscaled, flam.index, fit, mean_lfm_adfa, lwr_lfm_adfa, upr_lfm_adfa, lower, upper) 
```

### CEME

```{r}
seg.CEME.subset <- seg.CEME.subset %>% 
  filter(flam.index < 15) %>% 
  filter(lfm.unscaled < 300)

out.lm<-lm(flam.index ~ lfm.unscaled, data = seg.CEME.subset)
davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$flam.index, seg.CEME.subset$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset, lfm.unscaled, flam.index, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```

```{r}
seg.CEME.subset.limited <- seg.CEME.subset.limited %>% 
  filter(flam.index < 15) 

out.lm<-lm(flam.index ~ lfm.unscaled, data = seg.CEME.subset.limited)

davies.test(out.lm, k = 50)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$flam.index, seg.CEME.subset.limited$lfm.unscaled)))] <- broken.line(segmented.mod)$fit

segplot(seg.CEME.subset.limited, lfm.unscaled, flam.index, fit, mean_lfm_ceme, lwr_lfm_ceme, upr_lfm_ceme, lower, upper)
```