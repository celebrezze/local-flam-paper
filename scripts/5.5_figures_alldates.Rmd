---
title: "Figures"
author: "Indra Boving"
date: "12/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(lmerTest)
library(ggeffects)  # install the package first if you haven't already, then load it
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)
#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data
library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
library(segmented)
filter = dplyr::filter
```

Set global options for color palettes and themes: 

```{r}
# scale_colour_continuous <- function(...) scale_color_brewer(palette="Dark2")
# scale_colour_discrete   <- function(...) scale_color_brewer(palette="Dark2")
# scale_colour_binned     <- function(...) scale_color_brewer(palette="Dark2")
th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank())
```

# 1.1. PCA

```{r warning=FALSE}
### Note: This dataset includes only Epiradiator and Ignited samples
epi.flamdata <- read_csv(here("processed-data", "compiled-datasets", "LOCAL", "local_flam_data_all.csv"), show_col_types = FALSE) %>%
  mutate(LFM = lfm.NAs.imputed) %>% 
  filter(ignition == 1, model == "EPI")

figure_epi_pca_quant <- (epi.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max")]) %>%  
  transmute(
    "Flame Height" = fh,
     "Max. Temp" = temp.max,
     "\n\nTime to Ignition" = tti, #space is added in front of TTI so that the labels dont overlap in the figure
     "Flame Duration" = fd,
    "\nTime to First Glow" = ttfg,
   "Glow to Ignition" = gti,
    "Glow Duration" = gd,
    "Post-flame Glow" = pfg)
  
## Changing the order of the variables changes the PCA ordering: 
  
  # transmute("\nTime to First Glow" = ttfg,
  #           "Glow to Ignition" = gti,
  #           "\n\nTime to Ignition" = tti,
  #           "Flame Height" = fh,
  #           "Flame Duration" = fd,
  #           "Max. Temp" = temp.max,
  #         "Post-flame Glow" = pfg,
  #          "Glow Duration" = gd,
  #         )
  # transmute(
  #           "Glow Duration" = gd, 
  #         "Post-flame Glow" = pfg,
  #          "Max. Temp" = temp.max,
  #         "Flame Duration" = fd,
  #          "Flame Height" = fh,
  #         "\n\nTime to Ignition" = tti, 
  #         "Glow to Ignition" = gti, 
  #         "\nTime to First Glow" = ttfg
  #         )
  
  

figure_epi_pca_cat <- (epi.flamdata[c("hydration", "spp", "year.month", "sample")]) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Timing" = year.month, 
            "Sample" = sample) %>% 
  mutate(Species = case_when(
    spp == "ADFA" ~ "A. fasciculatum", 
    spp == "CEME" ~ "C. megacarpus"
  ))

figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE, retx=TRUE)
```

#### biplot PCA plot

```{r warning=FALSE}
# g <- ggbiplot(figure_prcomp, 
#                         groups = figure_epi_pca_cat$Species, 
#                         obs.scale = 0, 
#                         var.scale = 1,  
#                         circle = TRUE, 
#                         #ellipse = TRUE,
#                         size = .5,
#                         varname.size = 2.7, 
#                         alpha = 0, 
#                         labels.size = 2.7,
#                         varname.adjust = 1.5, 
#                         expand= TRUE) +
#   geom_point(aes(colour=figure_epi_pca_cat$Species), size = .5) +# by spp
# ggtitle("Flammability metrics only") +
#   scale_color_brewer(palette = "Dark2") +
#   #scale_color_manual(values=met.brewer("Morgenstern", 2)) +
#  # geom_text_repel(data=filter(results, padj<0.05), aes(label=Gene))
#   th
# g
```

### *ggplot PCA plot (USE THIS)

Setting up plotting data: 

```{r}
#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_epi_pca_cat)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("Flame Height", "Max. Temp","Flame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("\n\nTime to Ignition", "Glow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))
```

```{r, pretty colors, include = FALSE, eval = FALSE}
#Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c(7, 5, 4, 6, 3, 2, 1), colorblind=TRUE)
```

```{r}
# Plot
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  #stat_ellipse(level = 0.95, size = 1, show.legend = FALSE) +
  geom_point(size = 1, alpha = .5, aes(shape = Species
                                       #, color = Species
                                       ), data = PCAvalues) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .8, 
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 1.2), 
          y = (PCA_combustability$PC2 * 1.2),
          label = PCA_combustability$Variables, size = 2.6) +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.4), 
           y = (PCA_ignitability$PC2 * 1.5), 
           label = PCA_ignitability$Variables, size = 2.6) +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.3),
           y = (PCA_consumability$PC2 * 1.1), 
           label = PCA_consumability$Variables, size = 3) + 
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) +
  #th +
  scale_color_manual(values = c("#b08ba5","#db8872")) + 
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) + 
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
```

#1.2. PCA Table

```{r warning=FALSE}
figure_epi_pca_quant <- (epi.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max")]) %>% 
  # transmute("\nTime to First Glow" = ttfg,
  #           "Glow to Ignition" = gti,
  #           "\n\nTime to Ignition" = tti,
  #           "Flame Height" = fh,
  #           "Flame Duration" = fd,
  #           "Max. Temp" = temp.max,
  #         "Post-flame Glow" = pfg,
  #          "Glow Duration" = gd,
  #         )
  # transmute(
  #           "Glow Duration" = gd, 
  #         "Post-flame Glow" = pfg,
  #          "Max. Temp" = temp.max,
  #         "Flame Duration" = fd,
  #          "Flame Height" = fh,
  #         "\n\nTime to Ignition" = tti, 
  #         "Glow to Ignition" = gti, 
  #         "\nTime to First Glow" = ttfg
  #         )
  transmute(
    "Flame Height" = fh,
     "Max. Temp" = temp.max,
     "\n\nTime to Ignition" = tti,
     "Flame Duration" = fd,
    "\nTime to First Glow" = ttfg,
    "Glow to Ignition" = gti,
    "Glow Duration" = gd,
    "Post-flame Glow" = pfg)
  

figure_epi_pca_cat <- (epi.flamdata[c("hydration", "spp", "year.month", "sample")]) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Timing" = year.month, 
            "Sample" = sample) %>% 
  mutate(Species = case_when(
    spp == "ADFA" ~ "A. fasciculatum", 
    spp == "CEME" ~ "C. megacarpus"
  ))

#colnames(wine_subset)[2] <- "\nFlav"  # new line

figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE, retx=TRUE)

figure_varimax <- varimax(figure_prcomp$rotation[,1:3])
figure_varimax
#summary(epi.flamdata.pca) #importance of components
#plot(epi.flamdata.pca)

tab_pca(figure_prcomp, 
        rotation = c("varimax"), 
        digits = 2,
        show.var = TRUE,
  string.pov = "Proportion of Variance",
  string.cpov = "Cumulative Proportion") 

```

#------------------------------------
# 2. Data wrangling

Seasonal mins and maxs from 2016 - 2020:

https://www.sbbg.org/about/onsite-weather-station-live-fuel-moisture 

```{r}
adfa_min <- 55
adfa_max <- 110

ceme_min <- 55
ceme_max <- 140
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
mem.data <- read_csv(here("processed-data", "compiled-datasets", "LOCAL", "mem.data.local.epi.alldates.csv"), show_col_types = FALSE)

mem.data.raw <- mem.data %>%
 mutate(water_status = case_when(
    precip.2mo < 1 ~ "Dry", 
    precip.2mo > 1 ~ "Wet")
  ) %>% 
  mutate(mpa = (-1*mpa)) %>% 
  mutate(year = as.factor(year)) %>%
  mutate(month = as.factor(month)) %>% 
  mutate(mpa.unscaled = mpa) %>% 
  mutate(lfm = lfm.NAs.imputed)

clean.mem.data <- mem.data.raw  

#Parsing out the variables of interest for the mixed effects modelling

clean.mem.data.dependant <- clean.mem.data[,c('PC1', 'PC2', 'PC3', 'PC4', 'tti', 'fh', 'gd', 'temp.max', 'flam.index', 'year', 'month', 'prop.ignite', 'prop.ignite.bins5', 'prop.ignite.bins5_nodate', 'prop.ignite.bins10_nodate')] 
  
scaled.mem.data.predictors <- clean.mem.data %>%
    dplyr::select('lfm.NAs.imputed', 'lfm.outliers.out', 'mpa', 'dw.flam.sample', 'sample.wt', 'ww.flam.sample', 'gww.gdw.saturated', 'gdw.gww.saturated') %>%
  scale()
   # dplyr::mutate_if(is.numeric, scale)

mem.data.predictors <- clean.mem.data %>%
    dplyr::select('spp', 'year.month', 'individual', 'site', 'start.temp', 'precip.2mo','mpa.unscaled', 'lfm', 'water_status', "water.wt") 

scaled.mem.data <- cbind(scaled.mem.data.predictors, 
                         mem.data.predictors,
                         clean.mem.data.dependant) 
  
scaled.mem.data <- scaled.mem.data %>% 
  mutate(Species = case_when(
    spp == "ADFA" ~ "A. fasciculatum", 
    spp == "CEME" ~ "C. megacarpus"
  ))

seg.data.subset <- scaled.mem.data %>% 
  mutate(id = individual) 

seg.data.subset<-seg.data.subset[order(seg.data.subset$id),]

seg.adfa.subset <- seg.data.subset %>% 
  filter(spp == "ADFA")

seg.adfa.subset.limited <- seg.adfa.subset %>% 
  filter(lfm < adfa_max, lfm > adfa_min)

seg.CEME.subset <- seg.data.subset %>% 
  filter(spp == "CEME")

seg.CEME.subset.limited <- seg.CEME.subset %>% 
  filter(lfm < ceme_max, lfm > ceme_min)
```

#------------------------------------
#2.1 Model Figures

#### 2.1.1 Figure of model 

###### Water Potential vs. PC1

```{r}
mpa_mod_fig.mpa <- lmer(PC1 ~ mpa.unscaled + Species + year.month + (1 | individual), data = scaled.mem.data)

mod_fig.lfm <- lmer(PC1 ~ lfm + Species + year.month + (1 | individual), data = scaled.mem.data)

mod_fig.ww <- lmer(PC1 ~ water.wt + Species + year.month + (1 | individual), data = scaled.mem.data)
```

## Predicted vs. Observed PC1
```{r}
predicted_pc1_df <- data.frame(predicted_pc1 = predict(mpa_mod_fig.mpa), observed_pc1 = scaled.mem.data$PC1)

ggplot(data = predicted_pc1_df, aes(x = predicted_pc1, y = observed_pc1)) +
  geom_point(color = "lightblue", size = .7) +
  geom_abline() +
  labs(title = "Predicted vs. Observed PC1", subtitle = "All dates, mpa model",
       x = "Predicted PC1", y = "Observed PC1") +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) +
  ylim(-3, 3) +
  xlim(-3, 3) +
  coord_equal()
```

```{r}
## Water potential
effects_mpa_fig.mpa <- effects::effect(term= "mpa.unscaled", 
                                   mod= mpa_mod_fig.mpa, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_mpa_fig.mpa <- as.data.frame(effects_mpa_fig.mpa)

## LFM
effects_fig.lfm <- effects::effect(term= "lfm", 
                                   mod= mod_fig.lfm, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_fig.lfm <- as.data.frame(effects_fig.lfm)

## Water wt.
effects_fig.ww <- effects::effect(term= "water.wt", 
                                   mod= mod_fig.ww, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_fig.ww <- as.data.frame(effects_fig.ww)
```

## PC1 vs. Water Status and Content

**Figure X.** Model estimate of flammability (principle component 1) from water potential. 
```{r, message=FALSE, results='hide',fig.height= 4, fig.length = 8}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, PC1, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit), color="#db8872") +
  geom_ribbon(data= x_mpa_fig.mpa, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Potential (-Mpa)", y="Principle Component 1") +
 # scale_color_brewer(name = "Species", palette  = "Dark2") +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th 

mpa.vs.pc1 <- p +
  annotate("segment", x = -11, xend = -11, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
 # annotate("segment", x = -9, xend = -1, y = -4, yend = -4,
          # colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm")))  +
  annotate("text", x= -11, y= 4, label= "More", size = 3) +
  annotate("text", x= -11, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= -11, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= -11, y= -4, label= "Flammable", size = 3)  +
  #th +
  scale_x_continuous(limits = c(-11.5, 0), breaks= c(-10, -8, -6, -4, -2, 0)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 

mpa.vs.pc1
```

**Figure X.** Model estimate of flammability (principle component 1) from water content (LFM). 
```{r}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, PC1, color = Species), size = .5) + 
  geom_line(data=x_fig.lfm, aes(x=lfm, y=fit), color="#db8872") +
  geom_ribbon(data= x_fig.lfm, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Live Fuel Moisture (%)", y="Principle Component 1") +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th 

lfm.vs.pc1 <- p +
  annotate("segment", x = 10, xend = 10, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
  annotate("text", x= 10, y= 4, label= "More", size = 3) +
  annotate("text", x= 10, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= 10, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= 10, y= -4, label= "Flammable", size = 3)  +
  scale_x_continuous(limits = c(0,240)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 

lfm.vs.pc1
```

**Figure X.** Model estimate of flammability (principle component 1) from water weight (derived from LFM).
```{r}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(water.wt, PC1, color = Species), size = .5) + 
  geom_line(data=x_fig.ww, aes(x=water.wt, y=fit), color="#db8872") +
  geom_ribbon(data= x_fig.ww, aes(x=water.wt, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Weight (g)", y="Principle Component 1") +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th 

ww.vs.pc1 <- p +
  annotate("segment", x = 0.025, xend = 0.025, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
  annotate("text", x= 0.025, y= 4, label= "More", size = 3) +
  annotate("text", x= 0.025, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= 0.025, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= 0.025, y= -4, label= "Flammable", size = 3)  +
  scale_x_continuous(limits = c(0,0.85)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 

ww.vs.pc1
```

##### All plots together 
```{r}
ggarrange(mpa.vs.pc1, lfm.vs.pc1, ww.vs.pc1, ncol = 1)

ggsave("metrics.vs.pc1.png", height = 12, width = 8)
```

#### Wet vs. Dry Season Effects 

```{r, message=FALSE, results='hide',fig.height= 4, fig.length = 8}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, PC1, color = water_status), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit), color="#db8872") +
  geom_ribbon(data= x_mpa_fig.mpa, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Potential (-Mpa)",
       y="Principle Component 1", 
       color = "Timing") +
 # scale_color_brewer(name = "Species", palette  = "Dark2") +
  scale_color_manual(values = c("#b08ba5", "#ffb178"))
  th 

p +
  annotate("segment", x = -11, xend = -11, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
 # annotate("segment", x = -9, xend = -1, y = -4, yend = -4,
          # colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm")))  +
  annotate("text", x= -11, y= 4, label= "More", size = 3) +
  annotate("text", x= -11, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= -11, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= -11, y= -4, label= "Flammable", size = 3)  +
  #th +
  scale_x_continuous(limits = c(-11.5, 0), breaks= c(-10, -8, -6, -4, -2, 0)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 
```


######Water Potential vs. TTI

```{r}
mpa_mod_fig <- lmer(tti ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data)

effects_mpa_fig <- effects::effect(term= "mpa.unscaled", 
                                   mod= mpa_mod_fig, 
                                   se = TRUE, 
                                   confidence.level=.95)
# Save the effects values as a df:
x_mpa_fig <- as.data.frame(effects_mpa_fig)

# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, tti, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Water Potential (-Mpa)", 
       y="Time to Ignition (sec)") +
  scale_color_brewer(name = "Species", palette  = "Dark2") +
  th 


p +
  annotate("segment", x = -11, xend = -11, y = 20, yend = 60,
           colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
 # annotate("segment", x = -9, xend = -1, y = -4, yend = -4,
          # colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm")))  +
  annotate("text", x= -11, y= 70, label= "More", size = 3) +
  annotate("text", x= -11, y= 65, label= "Flammable", size = 3)+
annotate("text", x= -11, y= 15, label= "Less", size = 3) +
  annotate("text", x= -11, y= 10, label= "Flammable", size = 3) +
  th +
  scale_x_continuous(limits = c(-12, 0), breaks= c(-10, -8, -6, -4, -2, 0))
```
#### 2.1.2 Table of model

```{r}
mpa_mod_fig.mpa <- lmer(PC1 ~ mpa.unscaled + Species*year.month + (1 | individual), data = scaled.mem.data) #mpa model

m3 <- lmer(PC1 ~ spp*year.month + ww.flam.sample + (1 | individual), data = scaled.mem.data) #ww model
  
m6 <- lmer(PC1 ~ dw.flam.sample + spp*year.month + (1 | individual), data = scaled.mem.data) #dw model

m7 <- lmer(PC1 ~ mpa + lfm.NAs.imputed + spp*year.month + (1 | individual), data = scaled.mem.data) #mpa nad lfm model
m7

m10 <- lmer(PC1 ~ lfm.NAs.imputed + spp*year.month + (1 | individual), data = scaled.mem.data) #lfm model
```

```{r}
# models <- list(top_model, m7, m10, m3, m6)
# 
# # build table with `modelsummary` 
# cm <- c( '(Intercept)' = 'Intercept', 
#          'mpa' = 'Water Potential (-Mpa)', 
#          'lfm.NAs.imputed' = 'LFM (%)',
#          'ww.flam.sample' = 'Water weight (g)', 
#          'dw.flam.sample' = 'Dry weight (g)', 
#          'sppCEME' = 'C. megacarpus')
# cap <- 'Candidate models for predicting flammability (PC1)'
# 
# 
# modelsummary <- modelsummary(models,
#                              statistic = "p = {p.value}",
#                              stars = TRUE, 
#                              coef_map = cm, 
#                              title = cap, 
#                              output = 'flextable') %>% 
#   flextable::autofit()
# modelsummary
```

https://strengejacke.github.io/sjPlot/articles/tab_model_estimates.html 

```{r}

#tab_model(top_model, m7, m10, m3, m6) 

tab_model(top_model, m7, m10, m3, m6, 
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (-Mpa)', 
                          'C. megacarpus',
                           'LFM (%)',
                          'Water weight (g)', 
                          'Dry weight (g)'), 
         dv.labels = c("Model 1", 
                       "Model 2", 
                       "Model 3", 
                       "Model 4", 
                       "Model 5"),
         string.pred = "Coeffcient",
  string.p = "P-Value", 
  p.style = "stars")
         
```

The intra-class correlation coefficient (ICC) is a related statistic that quantifies the proportion of variance explained by a grouping (random) factor in multilevel/hierarchical data.

#------------------------------------
#2.2. Raw values plots

#####Prior Precip
```{r}
scaled.mem.data %>%
  ggplot(aes(y = PC1, x = lfm, color = as.factor(precip.2mo))) +
  geom_point(size = .7, alpha = .5) +
  geom_smooth(method = lm, size = .7, alpha = .5, se = FALSE) +
 # ggpubr::stat_regline_equation() +
  labs(x = "LFM", 
       y = "PC1 ", 
       color = "Precip (inches)\nprev. 2 mo.") +
 # scale_color_discrete(name = "Site")+
  th +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp) +
  theme(legend.position = "bottom")
```

#### MPa vs. TTI, FH, GD


```{r}
tti.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, tti, color = Species), size = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data, aes(mpa.unscaled, tti, color = Species), se = FALSE, size = .7) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Water Potential (-Mpa)", 
       y="Time to Ignition (sec)")  +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
tti.mpa


fh.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, fh, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(mpa.unscaled, fh, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Water Potential (-Mpa)", 
       y="Flame Height (cm)")  +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
fh.mpa

gd.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, gd, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(mpa.unscaled, gd, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Water Potential (-Mpa)", 
       y="Glow Duration (sec)")  +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 8), 
        legend.position = "bottom")
gd.mpa
```


```{r, fig1, fig.height = 6, fig.width = 3}
cowplot::plot_grid(tti.mpa, fh.mpa, gd.mpa, 
          ncol = 1)
```


#### LFM vs. TTI, FH, GD

```{r}
tti <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, tti, color = Species), size = .5) + 
  geom_smooth(method = "lm", 
              data= scaled.mem.data, 
              aes(lfm, tti, color = Species), se = FALSE, size = .7) +
  #geom_line(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3") +
  #geom_ribbon(data= x_mpa_fig, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Live Fuel Moisture (%)", 
       y="Time to Ignition (sec)")  +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
tti


fh <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, fh, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(lfm, fh, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Live Fuel Moisture (%)", 
       y="Flame Height (cm)")  +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
fh

gd <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, gd, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(lfm, gd, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Live Fuel Moisture (%)", 
       y="Glow Duration (sec)")  +
  scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 8), 
        legend.position = "bottom")
gd
```


```{r, fig1, fig.height = 6, fig.width = 3}

cowplot::plot_grid(tti, fh, gd, 
          ncol = 1)
```
#------------------------------------
#2.3. Segmented regression 

## Prop.ignite v LFM: 10% 

### ADFA

```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod


confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins10_nodate, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset, aes(x = lfm, y = prop.ignite.bins10_nodate)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

### CEME

```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$prop.ignite.bins10_nodate, seg.CEME.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = prop.ignite.bins10_nodate)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  # geom_vline(xintercept = lower, color = "red")+
  # geom_vline(xintercept = upper, color = "red") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) +
  ylim(50, 100)
  
```

```{r}
out.lm<-lm(prop.ignite.bins10_nodate ~ lfm, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$prop.ignite.bins10_nodate, seg.CEME.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset.limited, aes(x = lfm, y = prop.ignite.bins10_nodate)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  # geom_vline(xintercept = lower, color = "red")+
  # geom_vline(xintercept = upper, color = "red") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) +
  ylim(50, 100)
  
```
## Zoomed in: 5%

Bins of 5 LFM used to make prop. ignite column

### ADFA

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins5_nodate, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

ggplot(seg.adfa.subset, aes(x = lfm, y = prop.ignite.bins5_nodate)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  ylim(75, 100)  +
  # geom_vline(xintercept = lower, color = "red")+
  # geom_vline(xintercept = upper, color = "red") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```


```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$prop.ignite.bins5_nodate, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

ggplot(seg.adfa.subset.limited, aes(x = lfm, y = prop.ignite.bins5_nodate)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  ylim(75, 100)  +
  # geom_vline(xintercept = lower, color = "red")+
  # geom_vline(xintercept = upper, color = "red") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```
### CEME

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper


fit[complete.cases(rowSums(cbind(seg.CEME.subset$prop.ignite.bins5_nodate, seg.CEME.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = prop.ignite.bins5_nodate))  + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}
out.lm<-lm(prop.ignite.bins5_nodate ~ lfm, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint(segmented.mod)

fit <- numeric(length(seg.CEME.subset.limited$lfm)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper


fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$prop.ignite.bins5_nodate, seg.CEME.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset.limited, aes(x = lfm, y = prop.ignite.bins5_nodate))  + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```
##Mpa 

### ADFA

```{r}
out.lm<-lm(prop.ignite.bins5 ~ mpa.unscaled, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$mpa.unscaled)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$prop.ignite.bins5, seg.adfa.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit


ggplot(seg.adfa.subset, aes(x = mpa.unscaled, y = prop.ignite.bins5))  + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = mpa.unscaled, y = fit), color = "#ffb178") +
  labs(x = "Mpa", 
       y = "Ignition Percentage (%)", 
       title = "ADFA") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = -3.21, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

### CEME

```{r}
out.lm<-lm(prop.ignite.bins5 ~ mpa.unscaled, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

fit <- numeric(length(seg.CEME.subset$mpa.unscaled)) * NA

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit[complete.cases(rowSums(cbind(seg.CEME.subset$prop.ignite.bins5, seg.CEME.subset$mpa.unscaled)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = mpa.unscaled, y = prop.ignite.bins5_nodate))  + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = mpa.unscaled, y = fit), color = "#ffb178") +
  labs(x = "MPa", 
       y = "Ignition Percentage (%)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = -2.77, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

##PC1

####ADFA

```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$PC1, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset, aes(x = lfm, y = PC1)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Ignition Percentage (%)", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 79.93, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$PC1, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset.limited, aes(x = lfm, y = PC1)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "PC1", 
       title = "A. fasciculatum", 
       subtitle = "LFM limited to ranges observed at SBBG") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 79.93, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

#### CEME

```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$PC1, seg.CEME.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = PC1)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "PC1", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```
 
```{r}
out.lm<-lm(PC1 ~ lfm, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$PC1, seg.CEME.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset.limited, aes(x = lfm, y = PC1)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "PC1", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

## TTI

### ADFA***

```{r}
out.lm<-lm(tti ~ lfm, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$tti, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset, aes(x = lfm, y = tti)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Time to ignition (sec)", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 79.93, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}
out.lm<-lm(tti ~ lfm, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$tti, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset.limited, aes(x = lfm, y = tti)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Time to ignition (sec)", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 79.93, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```
### CEME

```{r}
out.lm<-lm(tti ~ lfm, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$tti, seg.CEME.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = tti)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Time to ignition (sec)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

Remove non-realistic LFMS
```{r}
seg.CEME.subset.limited <- seg.CEME.subset %>% 
  filter(lfm < ceme_max) 

out.lm<-lm(tti ~ lfm, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$tti, seg.CEME.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = tti)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Time to ignition (sec)", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

## FH

### ADFA

```{r}
out.lm<-lm(fh ~ lfm, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$fh, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset, aes(x = lfm, y = fh)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flame Height", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}

out.lm<-lm(fh ~ lfm, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$fh, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset.limited, aes(x = lfm, y = fh)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flame Height", 
       title = "A. fasciculatum", 
       subtitle = "LFM range limited to only those observed at SBBG") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

### CEME

```{r}
out.lm<-lm(fh ~ lfm, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$fh, seg.CEME.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = fh)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flame Height", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}
out.lm<-lm(fh ~ lfm, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$fh, seg.CEME.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset.limited, aes(x = lfm, y = fh)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flame Height", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

## flam.index

### ADFA

```{r}
out.lm<-lm(flam.index ~ lfm, data = seg.adfa.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset$flam.index, seg.adfa.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset, aes(x = lfm, y = flam.index)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flam Index", 
       title = "A. fasciculatum") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}

out.lm<-lm(flam.index ~ lfm, data = seg.adfa.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.adfa.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.adfa.subset.limited$flam.index, seg.adfa.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.adfa.subset.limited, aes(x = lfm, y = flam.index)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flam Index", 
       title = "A. fasciculatum", 
       subtitle = "LFM range limited to only those observed at SBBG") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  geom_vline(xintercept = 74.33, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

### CEME

```{r}
out.lm<-lm(flam.index ~ lfm, data = seg.CEME.subset)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset$flam.index, seg.CEME.subset$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset, aes(x = lfm, y = flam.index)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flam Index", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```

```{r}
out.lm<-lm(flam.index ~ lfm, data = seg.CEME.subset.limited)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
segmented.mod <-segmented(out.lm) #1 breakpoint for x
segmented.mod

confint <- confint(segmented.mod)
confint

lower <- confint[2]
lower

upper <- confint[3]
upper

fit <- numeric(length(seg.CEME.subset.limited$lfm)) * NA

fit[complete.cases(rowSums(cbind(seg.CEME.subset.limited$flam.index, seg.CEME.subset.limited$lfm)))] <- broken.line(segmented.mod)$fit

ggplot(seg.CEME.subset.limited, aes(x = lfm, y = flam.index)) + 
  geom_point(color = "#b08ba5", size = .7) +
  geom_line(aes(x = lfm, y = fit), color = "#ffb178") +
  labs(x = "Live Fuel Moisture (%)", 
       y = "Flam Index", 
       title = "C. megacarpus") +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th+
  geom_vline(xintercept = 88.96, color = "#7570b3") +
  geom_ribbon(aes(xmin=lower, xmax=upper), alpha = .3) 
```
#------------------------------------
#Field data: 

```{r}
field_data_local <- read.csv(here("raw-data", "local_field_data.csv")) %>% 
  janitor::clean_names() %>% 
  filter(spp %in% c("ADFA", "CEME")) 
  
field_data_local$date <- lubridate::mdy(field_data_local$date)

field_data_local <- field_data_local  %>% 
   mutate(month = month(date), 
          year = year(date)) %>% 
   mutate(age = case_when(
     age == "New" ~ "new", 
     age == "Old" ~ "old", 
     age == "new" ~ "new", 
     age == "old" ~ "old", 
     TRUE ~ as.character(age)
   )) 
```

```{r}
field_data_local %>% 
  ggplot(aes(y = lfm, x = spp, color = spp)) +
  geom_point() +
  geom_boxplot()
```
```{r}
field_data_local %>% 
  ggplot(aes(y = lfm, x = midday*-1, color = spp)) +
  geom_point() +
  xlab("Midday") +
  ylab("LFM") + 
  th
```

#------------------------------------

# EXTRA 
First attempt at using ggplot instead of biplot: 
```{r}
figure_princomp <- princomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

PCAvalues <- data.frame(Species = figure_epi_pca_cat$Species,
                        figure_prcomp$x) 

# Extract loadings of the variables
PCAloadings <- data.frame(Variables = rownames(figure_prcomp$rotation), figure_prcomp$rotation)

#Group by flam. metric: 
PCA_combustability <- PCAloadings %>% 
  filter(Variables %in% c("Flame Height", "Max. Temp","Flame Duration"))
         
PCA_ignitability <- PCAloadings %>% 
  filter(Variables %in% c("\n\nTime to Ignition", "\nTime to First Glow", "Glow to Ignition"))

PCA_consumability <- PCAloadings %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow"))


# Calculate the angles and the label offset
PCAloadings$Angle = ((180/pi) * atan(PCAloadings$PC2/PCAloadings$PC1))

PCAloadings$Offset <- ((-2 * sign(PCAloadings$PC1*4))/2)

#to make a sircle on the plot:
```
```{r}
seg_ceme_predicted <- predict(seg_CEME_mpa, seg.CEME.subset, se.fit = TRUE) %>% 
  as.data.frame()

seg_ceme_predicted_fuldf <- cbind(seg_ceme_predicted, seg.CEME.subset)
```

Varimax rotation attempt: 
```{r}
ncomp <- 2

pca_iris_rotated <- psych::principal(figure_epi_pca_quant, rotate="varimax", nfactors=ncomp, scores=TRUE)

princ_pca <- as.data.frame(pca_iris_rotated$scores)  # Scores returned by principal()

princ_pca_loadings <- as.data.frame(pca_iris_rotated$values) 


figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

rawLoadings <- figure_prcomp$rotation
rotatedLoadings <- varimax(rawLoadings)$loadings
invLoadings     <- t(pracma::pinv(rotatedLoadings))
scores          <- scale(figure_epi_pca_quant) %>% invLoadings
scores_df <- as.data.frame(print(scores))                  # Scores computed via rotated loadings


rawLoadings <- figure_prcomp$rotation
rotatedLoadings <- varimax(rawLoadings)$loadings
invLoadings     <- t(pracma::pinv(rotatedLoadings))
scores          <- scale(figure_epi_pca_quant) %>% invLoadings
scores_df <- as.data.frame(print(scores))                  # Scores computed via rotated loadings
PCAvalues <- data.frame(Species = figure_epi_pca_cat$Species, 
                        princ_pca
                        #scores_df
                        #figure_prcomp$x
                        ) %>% 
  mutate(PC1 = RC1, 
         PC2 = RC2) %>% 
  select(-RC1, - RC2)

# Extract loadings of the variables
PCAloadings <- data.frame(Variables = rownames(figure_prcomp$rotation),
                          princ_pca_loadings
                         # invLoadings
                         # figure_prcomp$rotation
                          ) %>% 
  mutate(PC1 = X1, 
         PC2 = X2) %>% 
  select(Variables, PC1, PC2)

#lengthen the loadings: 
# PCAloadings <- PCAloadings_small %>% 
#   mutate(PC1 = case_when(
#     PC1 > 0 ~ PC1 + 1, 
#     PC1 < 0 ~ PC1 - 1)) %>% 
#    mutate(PC2 = case_when(
#     PC1 > 0 ~ PC2 + 1, 
#     PC1 < 0 ~ PC2 - 1))
```

```{r, message=FALSE, results='hide'}
# Separating by Species
mpa_plot_spp <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa, PC1, color = spp), size = .5) + 
 # geom_point(data=x_mpa_fig, aes(x=mpa, y=fit), color="#7570b3", size = .5) +
  geom_line(data=seg_CEME_mpa, aes(x=effects, y=fitted.values), color="#7570b3") +
  #geom_ribbon(data= seg_CEME_mpa, aes(x=mpa, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Water Potential (-Mpa)", y="Principle Component 1") +
  scale_color_brewer(name = "Species", palette  = "Dark2") +
  th
mpa_plot_spp
```
